{
  "service": {
    "service": "aws-icc",
    "serviceObject": {
      "name": "aws-icc"
    },
    "provider": {
      "stage": "prod",
      "variableSyntax": "\\${([^{}]+?)}",
      "name": "aws",
      "runtime": "nodejs12.x",
      "environment": {
        "AWS_NODEJS_CONNECTION_REUSE_ENABLED": 1
      },
      "apiGateway": {
        "restApiId": {
          "Ref": "Api"
        },
        "restApiRootResourceId": {
          "Fn::GetAtt": [
            "Api",
            "RootResourceId"
          ]
        }
      },
      "region": "us-east-1",
      "versionFunctions": true,
      "remoteFunctionData": null,
      "compiledCloudFormationTemplate": {
        "AWSTemplateFormatVersion": "2010-09-09",
        "Description": "The AWS CloudFormation template for this Serverless application",
        "Resources": {
          "ServerlessDeploymentBucket": {
            "Type": "AWS::S3::Bucket",
            "Properties": {
              "BucketEncryption": {
                "ServerSideEncryptionConfiguration": [
                  {
                    "ServerSideEncryptionByDefault": {
                      "SSEAlgorithm": "AES256"
                    }
                  }
                ]
              }
            }
          },
          "ServerlessDeploymentBucketPolicy": {
            "Type": "AWS::S3::BucketPolicy",
            "Properties": {
              "Bucket": {
                "Ref": "ServerlessDeploymentBucket"
              },
              "PolicyDocument": {
                "Statement": [
                  {
                    "Action": "s3:*",
                    "Effect": "Deny",
                    "Principal": "*",
                    "Resource": [
                      {
                        "Fn::Join": [
                          "",
                          [
                            "arn:",
                            {
                              "Ref": "AWS::Partition"
                            },
                            ":s3:::",
                            {
                              "Ref": "ServerlessDeploymentBucket"
                            },
                            "/*"
                          ]
                        ]
                      }
                    ],
                    "Condition": {
                      "Bool": {
                        "aws:SecureTransport": false
                      }
                    }
                  }
                ]
              }
            }
          },
          "TranscribeJobProducerLogGroup": {
            "Type": "AWS::Logs::LogGroup",
            "Properties": {
              "LogGroupName": "/aws/lambda/aws-icc-prod-transcribeJobProducer"
            }
          },
          "SplitTranscriptLogGroup": {
            "Type": "AWS::Logs::LogGroup",
            "Properties": {
              "LogGroupName": "/aws/lambda/aws-icc-prod-splitTranscript"
            }
          },
          "AnalyseTextLogGroup": {
            "Type": "AWS::Logs::LogGroup",
            "Properties": {
              "LogGroupName": "/aws/lambda/aws-icc-prod-analyseText"
            }
          },
          "GetTranscriptsLogGroup": {
            "Type": "AWS::Logs::LogGroup",
            "Properties": {
              "LogGroupName": "/aws/lambda/aws-icc-prod-getTranscripts"
            }
          },
          "GetAudioLogGroup": {
            "Type": "AWS::Logs::LogGroup",
            "Properties": {
              "LogGroupName": "/aws/lambda/aws-icc-prod-getAudio"
            }
          },
          "GetSentimentLogGroup": {
            "Type": "AWS::Logs::LogGroup",
            "Properties": {
              "LogGroupName": "/aws/lambda/aws-icc-prod-getSentiment"
            }
          },
          "GetPresignedUrlLogGroup": {
            "Type": "AWS::Logs::LogGroup",
            "Properties": {
              "LogGroupName": "/aws/lambda/aws-icc-prod-getPresignedUrl"
            }
          },
          "UpdateStatusLogGroup": {
            "Type": "AWS::Logs::LogGroup",
            "Properties": {
              "LogGroupName": "/aws/lambda/aws-icc-prod-updateStatus"
            }
          },
          "QuickSightFederationFunctionLogGroup": {
            "Type": "AWS::Logs::LogGroup",
            "Properties": {
              "LogGroupName": "/aws/lambda/aws-icc-prod-quickSightFederationFunction"
            }
          },
          "CreateCallResolutionClassiferLogGroup": {
            "Type": "AWS::Logs::LogGroup",
            "Properties": {
              "LogGroupName": "/aws/lambda/aws-icc-prod-createCallResolutionClassifer"
            }
          },
          "CreateCallMotivationClassifierLogGroup": {
            "Type": "AWS::Logs::LogGroup",
            "Properties": {
              "LogGroupName": "/aws/lambda/aws-icc-prod-createCallMotivationClassifier"
            }
          },
          "CreateCallResolutionEndpointLogGroup": {
            "Type": "AWS::Logs::LogGroup",
            "Properties": {
              "LogGroupName": "/aws/lambda/aws-icc-prod-createCallResolutionEndpoint"
            }
          },
          "CreateCallMotivationEndpointLogGroup": {
            "Type": "AWS::Logs::LogGroup",
            "Properties": {
              "LogGroupName": "/aws/lambda/aws-icc-prod-createCallMotivationEndpoint"
            }
          },
          "TranscribeJobProducerLambdaFunction": {
            "Type": "AWS::Lambda::Function",
            "Properties": {
              "Code": {
                "S3Bucket": {
                  "Ref": "ServerlessDeploymentBucket"
                },
                "S3Key": "serverless/aws-icc/prod/1596656717357-2020-08-05T19:45:17.357Z/aws-icc.zip"
              },
              "FunctionName": "aws-icc-prod-transcribeJobProducer",
              "Handler": "transcribe/transcribeHandler.handler",
              "MemorySize": 1024,
              "Role": {
                "Fn::GetAtt": [
                  "TranscribeS3DynamoDBRole",
                  "Arn"
                ]
              },
              "Runtime": "nodejs12.x",
              "Timeout": 6,
              "Environment": {
                "Variables": {
                  "AWS_NODEJS_CONNECTION_REUSE_ENABLED": 1,
                  "TRANSCRIBE_OUTPUT_BUCKET": {
                    "Ref": "TranscriptionOutput"
                  },
                  "CUSTOM_VOCABULARY_NAME": {
                    "Ref": "CustomVocabularyName"
                  },
                  "TABLE_NAME": {
                    "Ref": "StatusTable"
                  }
                }
              }
            },
            "DependsOn": [
              "TranscribeJobProducerLogGroup",
              "TranscribeS3DynamoDBRole"
            ]
          },
          "TranscribeJobProducerLambdaVersionswBqveyMVNTuOCipMjIjOVpLJHRZNmVAbB7GLvBtE": {
            "Type": "AWS::Lambda::Version",
            "DeletionPolicy": "Retain",
            "Properties": {
              "FunctionName": {
                "Ref": "TranscribeJobProducerLambdaFunction"
              },
              "CodeSha256": "at8WWXA4oKr7JJmdt4UPPUgdFLe0Wx4YPB0Cq1T/Otw="
            }
          },
          "SplitTranscriptLambdaFunction": {
            "Type": "AWS::Lambda::Function",
            "Properties": {
              "Code": {
                "S3Bucket": {
                  "Ref": "ServerlessDeploymentBucket"
                },
                "S3Key": "serverless/aws-icc/prod/1596656717357-2020-08-05T19:45:17.357Z/aws-icc.zip"
              },
              "FunctionName": "aws-icc-prod-splitTranscript",
              "Handler": "analysis/splitTranscript.handler",
              "MemorySize": 1024,
              "Role": {
                "Fn::GetAtt": [
                  "TranscriptSplitterRole",
                  "Arn"
                ]
              },
              "Runtime": "nodejs12.x",
              "Timeout": 120,
              "Environment": {
                "Variables": {
                  "AWS_NODEJS_CONNECTION_REUSE_ENABLED": 1,
                  "SPLIT_TRANSCRIPT_OUTPUT_BUCKET": {
                    "Ref": "SplitTranscriptOutput"
                  },
                  "TABLE_NAME": {
                    "Ref": "StatusTable"
                  },
                  "AGENT_CHANNEL": {
                    "Ref": "AgentChannel"
                  },
                  "AGENT_LABEL": {
                    "Ref": "AgentSpeakerLabel"
                  }
                }
              }
            },
            "DependsOn": [
              "SplitTranscriptLogGroup",
              "TranscriptSplitterRole"
            ]
          },
          "SplitTranscriptLambdaVersionXAGWafJiFscz2UclaxnMieEcLEHxB8UDU6KkyfSRDQ4": {
            "Type": "AWS::Lambda::Version",
            "DeletionPolicy": "Retain",
            "Properties": {
              "FunctionName": {
                "Ref": "SplitTranscriptLambdaFunction"
              },
              "CodeSha256": "at8WWXA4oKr7JJmdt4UPPUgdFLe0Wx4YPB0Cq1T/Otw="
            }
          },
          "AnalyseTextLambdaFunction": {
            "Type": "AWS::Lambda::Function",
            "Properties": {
              "Code": {
                "S3Bucket": {
                  "Ref": "ServerlessDeploymentBucket"
                },
                "S3Key": "serverless/aws-icc/prod/1596656717357-2020-08-05T19:45:17.357Z/aws-icc.zip"
              },
              "FunctionName": "aws-icc-prod-analyseText",
              "Handler": "analysis/analyseTranscript.handler",
              "MemorySize": 1024,
              "Role": {
                "Fn::GetAtt": [
                  "ComprehendFullAccessRole",
                  "Arn"
                ]
              },
              "Runtime": "nodejs12.x",
              "Timeout": 120,
              "Environment": {
                "Variables": {
                  "AWS_NODEJS_CONNECTION_REUSE_ENABLED": 1,
                  "TEXT_ANALYSIS_OUTPUT_BUCKET": {
                    "Ref": "TextAnalysisOutput"
                  },
                  "DATA_ACCESS_ROLE": {
                    "Fn::GetAtt": [
                      "TextAnalysisRole",
                      "Arn"
                    ]
                  },
                  "TABLE_NAME": {
                    "Ref": "StatusTable"
                  },
                  "CALL_RESOLUTION_ENDPOINT_ARN": {
                    "Fn::Join": [
                      "",
                      [
                        "arn:aws:comprehend:region:account-id:document-classifier-endpoint/",
                        {
                          "Ref": "CallResolutionClassifierName"
                        },
                        "Endpoint"
                      ]
                    ]
                  },
                  "CALL_MOTIVATION_ENDPOINT_ARN": {
                    "Fn::Join": [
                      "",
                      [
                        "arn:aws:comprehend:region:account-id:document-classifier-endpoint/",
                        {
                          "Ref": "CallMotivationClassifierName"
                        },
                        "Endpoint"
                      ]
                    ]
                  },
                  "TOPIC_ARN": {
                    "Ref": "ThreatNotificationTopic"
                  },
                  "AGENT_CHANNEL": {
                    "Ref": "AgentChannel"
                  },
                  "AGENT_LABEL": {
                    "Ref": "AgentSpeakerLabel"
                  }
                }
              }
            },
            "DependsOn": [
              "AnalyseTextLogGroup",
              "ComprehendFullAccessRole"
            ]
          },
          "AnalyseTextLambdaVersionwRDBW58HQZshCZPG1s683MBLo9ThRFswwQM0W4btBI": {
            "Type": "AWS::Lambda::Version",
            "DeletionPolicy": "Retain",
            "Properties": {
              "FunctionName": {
                "Ref": "AnalyseTextLambdaFunction"
              },
              "CodeSha256": "at8WWXA4oKr7JJmdt4UPPUgdFLe0Wx4YPB0Cq1T/Otw="
            }
          },
          "GetTranscriptsLambdaFunction": {
            "Type": "AWS::Lambda::Function",
            "Properties": {
              "Code": {
                "S3Bucket": {
                  "Ref": "ServerlessDeploymentBucket"
                },
                "S3Key": "serverless/aws-icc/prod/1596656717357-2020-08-05T19:45:17.357Z/aws-icc.zip"
              },
              "FunctionName": "aws-icc-prod-getTranscripts",
              "Handler": "api/getTranscripts.handler",
              "MemorySize": 1024,
              "Role": {
                "Fn::GetAtt": [
                  "ScanTranscriptsRole",
                  "Arn"
                ]
              },
              "Runtime": "nodejs12.x",
              "Timeout": 120,
              "Environment": {
                "Variables": {
                  "AWS_NODEJS_CONNECTION_REUSE_ENABLED": 1,
                  "TABLE_NAME": {
                    "Ref": "StatusTable"
                  },
                  "AGENT_CHANNEL": {
                    "Ref": "AgentChannel"
                  },
                  "AGENT_LABEL": {
                    "Ref": "AgentSpeakerLabel"
                  }
                }
              }
            },
            "DependsOn": [
              "GetTranscriptsLogGroup",
              "ScanTranscriptsRole"
            ]
          },
          "GetTranscriptsLambdaVersionWhSzMAiQoRUWVz3XAHOub7MspgvdGzvwuLFT0WZBhA": {
            "Type": "AWS::Lambda::Version",
            "DeletionPolicy": "Retain",
            "Properties": {
              "FunctionName": {
                "Ref": "GetTranscriptsLambdaFunction"
              },
              "CodeSha256": "at8WWXA4oKr7JJmdt4UPPUgdFLe0Wx4YPB0Cq1T/Otw="
            }
          },
          "GetAudioLambdaFunction": {
            "Type": "AWS::Lambda::Function",
            "Properties": {
              "Code": {
                "S3Bucket": {
                  "Ref": "ServerlessDeploymentBucket"
                },
                "S3Key": "serverless/aws-icc/prod/1596656717357-2020-08-05T19:45:17.357Z/aws-icc.zip"
              },
              "FunctionName": "aws-icc-prod-getAudio",
              "Handler": "api/getAudio.handler",
              "MemorySize": 1024,
              "Role": {
                "Fn::GetAtt": [
                  "TranscriptionAudioFilesRole",
                  "Arn"
                ]
              },
              "Runtime": "nodejs12.x",
              "Timeout": 6,
              "Environment": {
                "Variables": {
                  "AWS_NODEJS_CONNECTION_REUSE_ENABLED": 1,
                  "BUCKET_NAME": {
                    "Fn::Join": [
                      "",
                      [
                        "transcription-audio-files",
                        "-prod-",
                        {
                          "Ref": "ServicePrefix"
                        }
                      ]
                    ]
                  }
                }
              }
            },
            "DependsOn": [
              "GetAudioLogGroup",
              "TranscriptionAudioFilesRole"
            ]
          },
          "GetAudioLambdaVersionixE09GCBLxIekgVlBCYgueME7Mssr8zmxrXphTQlbs": {
            "Type": "AWS::Lambda::Version",
            "DeletionPolicy": "Retain",
            "Properties": {
              "FunctionName": {
                "Ref": "GetAudioLambdaFunction"
              },
              "CodeSha256": "at8WWXA4oKr7JJmdt4UPPUgdFLe0Wx4YPB0Cq1T/Otw="
            }
          },
          "GetSentimentLambdaFunction": {
            "Type": "AWS::Lambda::Function",
            "Properties": {
              "Code": {
                "S3Bucket": {
                  "Ref": "ServerlessDeploymentBucket"
                },
                "S3Key": "serverless/aws-icc/prod/1596656717357-2020-08-05T19:45:17.357Z/aws-icc.zip"
              },
              "FunctionName": "aws-icc-prod-getSentiment",
              "Handler": "api/getSentiments.handler",
              "MemorySize": 1024,
              "Role": {
                "Fn::GetAtt": [
                  "GetSentimentsRole",
                  "Arn"
                ]
              },
              "Runtime": "nodejs12.x",
              "Timeout": 6,
              "Environment": {
                "Variables": {
                  "AWS_NODEJS_CONNECTION_REUSE_ENABLED": 1,
                  "BUCKET": {
                    "Fn::Join": [
                      "",
                      [
                        "text-analysis-output",
                        "-prod-",
                        {
                          "Ref": "ServicePrefix"
                        }
                      ]
                    ]
                  }
                }
              }
            },
            "DependsOn": [
              "GetSentimentLogGroup",
              "GetSentimentsRole"
            ]
          },
          "GetSentimentLambdaVersionlAm4SlFVBkJG282a3t94ZeFqLU546dKnIgd3mcMcwXU": {
            "Type": "AWS::Lambda::Version",
            "DeletionPolicy": "Retain",
            "Properties": {
              "FunctionName": {
                "Ref": "GetSentimentLambdaFunction"
              },
              "CodeSha256": "at8WWXA4oKr7JJmdt4UPPUgdFLe0Wx4YPB0Cq1T/Otw="
            }
          },
          "GetPresignedUrlLambdaFunction": {
            "Type": "AWS::Lambda::Function",
            "Properties": {
              "Code": {
                "S3Bucket": {
                  "Ref": "ServerlessDeploymentBucket"
                },
                "S3Key": "serverless/aws-icc/prod/1596656717357-2020-08-05T19:45:17.357Z/aws-icc.zip"
              },
              "FunctionName": "aws-icc-prod-getPresignedUrl",
              "Handler": "api/getPresignedUrl.handler",
              "MemorySize": 1024,
              "Role": {
                "Fn::GetAtt": [
                  "TranscriptionAudioFilesRole",
                  "Arn"
                ]
              },
              "Runtime": "nodejs12.x",
              "Timeout": 6,
              "Environment": {
                "Variables": {
                  "AWS_NODEJS_CONNECTION_REUSE_ENABLED": 1,
                  "BUCKET_NAME": {
                    "Fn::Join": [
                      "",
                      [
                        "transcription-audio-files",
                        "-prod-",
                        {
                          "Ref": "ServicePrefix"
                        }
                      ]
                    ]
                  },
                  "TOKEN_ENDPOINT": {
                    "Fn::Join": [
                      "",
                      [
                        "https://",
                        {
                          "Ref": "CognitoDomain"
                        },
                        ".auth.region.amazoncognito.com/oauth2/userInfo"
                      ]
                    ]
                  }
                }
              }
            },
            "DependsOn": [
              "GetPresignedUrlLogGroup",
              "TranscriptionAudioFilesRole"
            ]
          },
          "GetPresignedUrlLambdaVersionZCKVKZv7tZgnWkK8DDps3YYVDDPjU8e1W9ZJwVT18": {
            "Type": "AWS::Lambda::Version",
            "DeletionPolicy": "Retain",
            "Properties": {
              "FunctionName": {
                "Ref": "GetPresignedUrlLambdaFunction"
              },
              "CodeSha256": "at8WWXA4oKr7JJmdt4UPPUgdFLe0Wx4YPB0Cq1T/Otw="
            }
          },
          "UpdateStatusLambdaFunction": {
            "Type": "AWS::Lambda::Function",
            "Properties": {
              "Code": {
                "S3Bucket": {
                  "Ref": "ServerlessDeploymentBucket"
                },
                "S3Key": "serverless/aws-icc/prod/1596656717357-2020-08-05T19:45:17.357Z/aws-icc.zip"
              },
              "FunctionName": "aws-icc-prod-updateStatus",
              "Handler": "api/updateStatus.handler",
              "MemorySize": 1024,
              "Role": {
                "Fn::GetAtt": [
                  "DynamoBatchWriteRole",
                  "Arn"
                ]
              },
              "Runtime": "nodejs12.x",
              "Timeout": 6,
              "Environment": {
                "Variables": {
                  "AWS_NODEJS_CONNECTION_REUSE_ENABLED": 1,
                  "TABLE_NAME": {
                    "Ref": "StatusTable"
                  },
                  "TOKEN_ENDPOINT": {
                    "Fn::Join": [
                      "",
                      [
                        "https://",
                        {
                          "Ref": "CognitoDomain"
                        },
                        ".auth.region.amazoncognito.com/oauth2/userInfo"
                      ]
                    ]
                  }
                }
              }
            },
            "DependsOn": [
              "UpdateStatusLogGroup",
              "DynamoBatchWriteRole"
            ]
          },
          "UpdateStatusLambdaVersionk5XaoCmLOOrxwc8Zi2T3DrOfHwXEjTfKO9UUBGqPBPo": {
            "Type": "AWS::Lambda::Version",
            "DeletionPolicy": "Retain",
            "Properties": {
              "FunctionName": {
                "Ref": "UpdateStatusLambdaFunction"
              },
              "CodeSha256": "at8WWXA4oKr7JJmdt4UPPUgdFLe0Wx4YPB0Cq1T/Otw="
            }
          },
          "QuickSightFederationFunctionLambdaFunction": {
            "Type": "AWS::Lambda::Function",
            "Properties": {
              "Code": {
                "S3Bucket": {
                  "Ref": "ServerlessDeploymentBucket"
                },
                "S3Key": "serverless/aws-icc/prod/1596656717357-2020-08-05T19:45:17.357Z/aws-icc.zip"
              },
              "FunctionName": "aws-icc-prod-quickSightFederationFunction",
              "Handler": "api/quicksightAuth.handler",
              "MemorySize": 1024,
              "Role": {
                "Fn::GetAtt": [
                  "LambdaBasicExecutionRole",
                  "Arn"
                ]
              },
              "Runtime": "nodejs12.x",
              "Timeout": 6,
              "Environment": {
                "Variables": {
                  "AWS_NODEJS_CONNECTION_REUSE_ENABLED": 1
                }
              }
            },
            "DependsOn": [
              "QuickSightFederationFunctionLogGroup",
              "LambdaBasicExecutionRole"
            ]
          },
          "QuickSightFederationFunctionLambdaVersionEnwx6MUxQDyI4sqkH4rPfOPKlWCNLwzE5sqGIEEgUFI": {
            "Type": "AWS::Lambda::Version",
            "DeletionPolicy": "Retain",
            "Properties": {
              "FunctionName": {
                "Ref": "QuickSightFederationFunctionLambdaFunction"
              },
              "CodeSha256": "at8WWXA4oKr7JJmdt4UPPUgdFLe0Wx4YPB0Cq1T/Otw="
            }
          },
          "CreateCallResolutionClassiferLambdaFunction": {
            "Type": "AWS::Lambda::Function",
            "Properties": {
              "Code": {
                "S3Bucket": {
                  "Ref": "ServerlessDeploymentBucket"
                },
                "S3Key": "serverless/aws-icc/prod/1596656717357-2020-08-05T19:45:17.357Z/aws-icc.zip"
              },
              "FunctionName": "aws-icc-prod-createCallResolutionClassifer",
              "Handler": "classifiers/callResolutionClassifier.handler",
              "MemorySize": 1024,
              "Role": {
                "Fn::GetAtt": [
                  "ComprehendFullAccessRole",
                  "Arn"
                ]
              },
              "Runtime": "nodejs12.x",
              "Timeout": 900,
              "Environment": {
                "Variables": {
                  "AWS_NODEJS_CONNECTION_REUSE_ENABLED": 1,
                  "DATA_ACCESS_ROLE": {
                    "Fn::GetAtt": [
                      "ComprehendDataAccessRole",
                      "Arn"
                    ]
                  },
                  "CLASSIFIER_NAME": {
                    "Ref": "CallResolutionClassifierName"
                  },
                  "CALL_RESOLUTION_BUCKET": {
                    "Fn::Join": [
                      "",
                      [
                        "comprehend-call-resolution",
                        "-prod-",
                        {
                          "Ref": "ServicePrefix"
                        }
                      ]
                    ]
                  }
                }
              }
            },
            "DependsOn": [
              "CreateCallResolutionClassiferLogGroup",
              "ComprehendFullAccessRole"
            ]
          },
          "CreateCallResolutionClassiferLambdaVersioneKkdukzpkw18BTxRyxoc3N34aNS6POOTKUYgTKwF0": {
            "Type": "AWS::Lambda::Version",
            "DeletionPolicy": "Retain",
            "Properties": {
              "FunctionName": {
                "Ref": "CreateCallResolutionClassiferLambdaFunction"
              },
              "CodeSha256": "at8WWXA4oKr7JJmdt4UPPUgdFLe0Wx4YPB0Cq1T/Otw="
            }
          },
          "CreateCallMotivationClassifierLambdaFunction": {
            "Type": "AWS::Lambda::Function",
            "Properties": {
              "Code": {
                "S3Bucket": {
                  "Ref": "ServerlessDeploymentBucket"
                },
                "S3Key": "serverless/aws-icc/prod/1596656717357-2020-08-05T19:45:17.357Z/aws-icc.zip"
              },
              "FunctionName": "aws-icc-prod-createCallMotivationClassifier",
              "Handler": "classifiers/createMotivationClassifier.handler",
              "MemorySize": 1024,
              "Role": {
                "Fn::GetAtt": [
                  "ComprehendFullAccessRole",
                  "Arn"
                ]
              },
              "Runtime": "nodejs12.x",
              "Timeout": 900,
              "Environment": {
                "Variables": {
                  "AWS_NODEJS_CONNECTION_REUSE_ENABLED": 1,
                  "DATA_ACCESS_ROLE": {
                    "Fn::GetAtt": [
                      "ComprehendDataAccessRole",
                      "Arn"
                    ]
                  },
                  "CLASSIFIER_NAME": {
                    "Ref": "CallMotivationClassifierName"
                  },
                  "CALL_MOTIVATION_INPUT": {
                    "Fn::Join": [
                      "",
                      [
                        "comprehend-call-motivation",
                        "-prod-",
                        {
                          "Ref": "ServicePrefix"
                        }
                      ]
                    ]
                  }
                }
              }
            },
            "DependsOn": [
              "CreateCallMotivationClassifierLogGroup",
              "ComprehendFullAccessRole"
            ]
          },
          "CreateCallMotivationClassifierLambdaVersionmdyUWGZvjevcLutd2StHiZx0ThLi8GMoblf24jLniY": {
            "Type": "AWS::Lambda::Version",
            "DeletionPolicy": "Retain",
            "Properties": {
              "FunctionName": {
                "Ref": "CreateCallMotivationClassifierLambdaFunction"
              },
              "CodeSha256": "at8WWXA4oKr7JJmdt4UPPUgdFLe0Wx4YPB0Cq1T/Otw="
            }
          },
          "CreateCallResolutionEndpointLambdaFunction": {
            "Type": "AWS::Lambda::Function",
            "Properties": {
              "Code": {
                "S3Bucket": {
                  "Ref": "ServerlessDeploymentBucket"
                },
                "S3Key": "serverless/aws-icc/prod/1596656717357-2020-08-05T19:45:17.357Z/aws-icc.zip"
              },
              "FunctionName": "aws-icc-prod-createCallResolutionEndpoint",
              "Handler": "endpoints/callResolutionEnpoint.handler",
              "MemorySize": 1024,
              "Role": {
                "Fn::GetAtt": [
                  "ComprehendFullAccessRole",
                  "Arn"
                ]
              },
              "Runtime": "nodejs12.x",
              "Timeout": 120,
              "Environment": {
                "Variables": {
                  "AWS_NODEJS_CONNECTION_REUSE_ENABLED": 1,
                  "DATA_ACCESS_ROLE": {
                    "Fn::GetAtt": [
                      "ComprehendDataAccessRole",
                      "Arn"
                    ]
                  },
                  "CLASSIFIER_NAME": {
                    "Ref": "CallResolutionClassifierName"
                  },
                  "CALL_RESOLUTION_ARN": {
                    "Fn::Join": [
                      "",
                      [
                        "arn:aws:comprehend:region:account-id:document-classifier/",
                        {
                          "Ref": "CallResolutionClassifierName"
                        }
                      ]
                    ]
                  }
                }
              }
            },
            "DependsOn": [
              "CreateCallResolutionEndpointLogGroup",
              "ComprehendFullAccessRole"
            ]
          },
          "CreateCallResolutionEndpointLambdaVersionKegdf5ilCKLEqDfPrXVxHBDvLjfkR4UyX4mJKUQoS0": {
            "Type": "AWS::Lambda::Version",
            "DeletionPolicy": "Retain",
            "Properties": {
              "FunctionName": {
                "Ref": "CreateCallResolutionEndpointLambdaFunction"
              },
              "CodeSha256": "at8WWXA4oKr7JJmdt4UPPUgdFLe0Wx4YPB0Cq1T/Otw="
            }
          },
          "CreateCallMotivationEndpointLambdaFunction": {
            "Type": "AWS::Lambda::Function",
            "Properties": {
              "Code": {
                "S3Bucket": {
                  "Ref": "ServerlessDeploymentBucket"
                },
                "S3Key": "serverless/aws-icc/prod/1596656717357-2020-08-05T19:45:17.357Z/aws-icc.zip"
              },
              "FunctionName": "aws-icc-prod-createCallMotivationEndpoint",
              "Handler": "endpoints/createMotivationEndpoint.handler",
              "MemorySize": 1024,
              "Role": {
                "Fn::GetAtt": [
                  "ComprehendFullAccessRole",
                  "Arn"
                ]
              },
              "Runtime": "nodejs12.x",
              "Timeout": 120,
              "Environment": {
                "Variables": {
                  "AWS_NODEJS_CONNECTION_REUSE_ENABLED": 1,
                  "DATA_ACCESS_ROLE": {
                    "Fn::GetAtt": [
                      "ComprehendDataAccessRole",
                      "Arn"
                    ]
                  },
                  "CLASSIFIER_NAME": {
                    "Ref": "CallMotivationClassifierName"
                  },
                  "CALL_MOTIVATION_ARN": {
                    "Fn::Join": [
                      "",
                      [
                        "arn:aws:comprehend:region:account-id:document-classifier/",
                        {
                          "Ref": "CallMotivationClassifierName"
                        }
                      ]
                    ]
                  }
                }
              }
            },
            "DependsOn": [
              "CreateCallMotivationEndpointLogGroup",
              "ComprehendFullAccessRole"
            ]
          },
          "CreateCallMotivationEndpointLambdaVersionJcgomsusL2muU9iJ7NWAvMCEXg4SThgT5ifamAUY": {
            "Type": "AWS::Lambda::Version",
            "DeletionPolicy": "Retain",
            "Properties": {
              "FunctionName": {
                "Ref": "CreateCallMotivationEndpointLambdaFunction"
              },
              "CodeSha256": "at8WWXA4oKr7JJmdt4UPPUgdFLe0Wx4YPB0Cq1T/Otw="
            }
          },
          "CreateCallResolutionEndpointEventsRuleSchedule1": {
            "Type": "AWS::Events::Rule",
            "Properties": {
              "ScheduleExpression": "rate(3 minutes)",
              "State": "ENABLED",
              "Targets": [
                {
                  "Arn": {
                    "Fn::GetAtt": [
                      "CreateCallResolutionEndpointLambdaFunction",
                      "Arn"
                    ]
                  },
                  "Id": "createCallResolutionEndpointSchedule"
                }
              ]
            }
          },
          "CreateCallResolutionEndpointLambdaPermissionEventsRuleSchedule1": {
            "Type": "AWS::Lambda::Permission",
            "Properties": {
              "FunctionName": {
                "Fn::GetAtt": [
                  "CreateCallResolutionEndpointLambdaFunction",
                  "Arn"
                ]
              },
              "Action": "lambda:InvokeFunction",
              "Principal": "events.amazonaws.com",
              "SourceArn": {
                "Fn::GetAtt": [
                  "CreateCallResolutionEndpointEventsRuleSchedule1",
                  "Arn"
                ]
              }
            }
          },
          "CreateCallMotivationEndpointEventsRuleSchedule1": {
            "Type": "AWS::Events::Rule",
            "Properties": {
              "ScheduleExpression": "rate(3 minutes)",
              "State": "ENABLED",
              "Targets": [
                {
                  "Arn": {
                    "Fn::GetAtt": [
                      "CreateCallMotivationEndpointLambdaFunction",
                      "Arn"
                    ]
                  },
                  "Id": "createCallMotivationEndpointSchedule"
                }
              ]
            }
          },
          "CreateCallMotivationEndpointLambdaPermissionEventsRuleSchedule1": {
            "Type": "AWS::Lambda::Permission",
            "Properties": {
              "FunctionName": {
                "Fn::GetAtt": [
                  "CreateCallMotivationEndpointLambdaFunction",
                  "Arn"
                ]
              },
              "Action": "lambda:InvokeFunction",
              "Principal": "events.amazonaws.com",
              "SourceArn": {
                "Fn::GetAtt": [
                  "CreateCallMotivationEndpointEventsRuleSchedule1",
                  "Arn"
                ]
              }
            }
          },
          "TranscribeJobProducerCustomS31": {
            "Type": "Custom::S3",
            "Version": 1,
            "DependsOn": [
              "TranscribeJobProducerLambdaFunction",
              "CustomDashresourceDashexistingDashs3LambdaFunction"
            ],
            "Properties": {
              "ServiceToken": {
                "Fn::GetAtt": [
                  "CustomDashresourceDashexistingDashs3LambdaFunction",
                  "Arn"
                ]
              },
              "FunctionName": "aws-icc-prod-transcribeJobProducer",
              "BucketName": {
                "Ref": "TranscriptionAudioFiles"
              },
              "BucketConfigs": [
                {
                  "Event": "s3:ObjectCreated:*",
                  "Rules": []
                }
              ]
            }
          },
          "SplitTranscriptCustomS31": {
            "Type": "Custom::S3",
            "Version": 1,
            "DependsOn": [
              "SplitTranscriptLambdaFunction",
              "CustomDashresourceDashexistingDashs3LambdaFunction",
              "TranscribeJobProducerCustomS31"
            ],
            "Properties": {
              "ServiceToken": {
                "Fn::GetAtt": [
                  "CustomDashresourceDashexistingDashs3LambdaFunction",
                  "Arn"
                ]
              },
              "FunctionName": "aws-icc-prod-splitTranscript",
              "BucketName": {
                "Ref": "TranscriptionOutput"
              },
              "BucketConfigs": [
                {
                  "Event": "s3:ObjectCreated:*",
                  "Rules": []
                }
              ]
            }
          },
          "AnalyseTextCustomS31": {
            "Type": "Custom::S3",
            "Version": 1,
            "DependsOn": [
              "AnalyseTextLambdaFunction",
              "CustomDashresourceDashexistingDashs3LambdaFunction",
              "SplitTranscriptCustomS31"
            ],
            "Properties": {
              "ServiceToken": {
                "Fn::GetAtt": [
                  "CustomDashresourceDashexistingDashs3LambdaFunction",
                  "Arn"
                ]
              },
              "FunctionName": "aws-icc-prod-analyseText",
              "BucketName": {
                "Ref": "SplitTranscriptOutput"
              },
              "BucketConfigs": [
                {
                  "Event": "s3:ObjectCreated:*",
                  "Rules": []
                }
              ]
            }
          },
          "CreateCallResolutionClassiferCustomS31": {
            "Type": "Custom::S3",
            "Version": 1,
            "DependsOn": [
              "CreateCallResolutionClassiferLambdaFunction",
              "CustomDashresourceDashexistingDashs3LambdaFunction",
              "AnalyseTextCustomS31"
            ],
            "Properties": {
              "ServiceToken": {
                "Fn::GetAtt": [
                  "CustomDashresourceDashexistingDashs3LambdaFunction",
                  "Arn"
                ]
              },
              "FunctionName": "aws-icc-prod-createCallResolutionClassifer",
              "BucketName": {
                "Ref": "ComprehendCallResolutionBucket"
              },
              "BucketConfigs": [
                {
                  "Event": "s3:ObjectCreated:*",
                  "Rules": []
                }
              ]
            }
          },
          "CreateCallMotivationClassifierCustomS31": {
            "Type": "Custom::S3",
            "Version": 1,
            "DependsOn": [
              "CreateCallMotivationClassifierLambdaFunction",
              "CustomDashresourceDashexistingDashs3LambdaFunction",
              "CreateCallResolutionClassiferCustomS31"
            ],
            "Properties": {
              "ServiceToken": {
                "Fn::GetAtt": [
                  "CustomDashresourceDashexistingDashs3LambdaFunction",
                  "Arn"
                ]
              },
              "FunctionName": "aws-icc-prod-createCallMotivationClassifier",
              "BucketName": {
                "Ref": "ComprehendCallMotivationBucket"
              },
              "BucketConfigs": [
                {
                  "Event": "s3:ObjectCreated:*",
                  "Rules": []
                }
              ]
            }
          },
          "IamRoleCustomResourcesLambdaExecution": {
            "Type": "AWS::IAM::Role",
            "Properties": {
              "AssumeRolePolicyDocument": {
                "Version": "2012-10-17",
                "Statement": [
                  {
                    "Effect": "Allow",
                    "Principal": {
                      "Service": [
                        "lambda.amazonaws.com"
                      ]
                    },
                    "Action": [
                      "sts:AssumeRole"
                    ]
                  }
                ]
              },
              "Policies": [
                {
                  "PolicyName": {
                    "Fn::Join": [
                      "-",
                      [
                        "prod",
                        "aws-icc",
                        "custom-resources-lambda"
                      ]
                    ]
                  },
                  "PolicyDocument": {
                    "Version": "2012-10-17",
                    "Statement": [
                      {
                        "Effect": "Allow",
                        "Resource": {
                          "Fn::Join": [
                            ":",
                            [
                              "arn",
                              {
                                "Ref": "AWS::Partition"
                              },
                              "s3",
                              "",
                              "",
                              {
                                "Ref": "TranscriptionAudioFiles"
                              }
                            ]
                          ]
                        },
                        "Action": [
                          "s3:PutBucketNotification",
                          "s3:GetBucketNotification"
                        ]
                      },
                      {
                        "Effect": "Allow",
                        "Resource": {
                          "Fn::Join": [
                            ":",
                            [
                              "arn",
                              {
                                "Ref": "AWS::Partition"
                              },
                              "lambda",
                              {
                                "Ref": "AWS::Region"
                              },
                              {
                                "Ref": "AWS::AccountId"
                              },
                              "function",
                              "aws-icc-prod-transcribeJobProducer"
                            ]
                          ]
                        },
                        "Action": [
                          "lambda:AddPermission",
                          "lambda:RemovePermission"
                        ]
                      },
                      {
                        "Effect": "Allow",
                        "Resource": {
                          "Fn::Join": [
                            ":",
                            [
                              "arn",
                              {
                                "Ref": "AWS::Partition"
                              },
                              "s3",
                              "",
                              "",
                              {
                                "Ref": "TranscriptionOutput"
                              }
                            ]
                          ]
                        },
                        "Action": [
                          "s3:PutBucketNotification",
                          "s3:GetBucketNotification"
                        ]
                      },
                      {
                        "Effect": "Allow",
                        "Resource": {
                          "Fn::Join": [
                            ":",
                            [
                              "arn",
                              {
                                "Ref": "AWS::Partition"
                              },
                              "lambda",
                              {
                                "Ref": "AWS::Region"
                              },
                              {
                                "Ref": "AWS::AccountId"
                              },
                              "function",
                              "aws-icc-prod-splitTranscript"
                            ]
                          ]
                        },
                        "Action": [
                          "lambda:AddPermission",
                          "lambda:RemovePermission"
                        ]
                      },
                      {
                        "Effect": "Allow",
                        "Resource": {
                          "Fn::Join": [
                            ":",
                            [
                              "arn",
                              {
                                "Ref": "AWS::Partition"
                              },
                              "s3",
                              "",
                              "",
                              {
                                "Ref": "SplitTranscriptOutput"
                              }
                            ]
                          ]
                        },
                        "Action": [
                          "s3:PutBucketNotification",
                          "s3:GetBucketNotification"
                        ]
                      },
                      {
                        "Effect": "Allow",
                        "Resource": {
                          "Fn::Join": [
                            ":",
                            [
                              "arn",
                              {
                                "Ref": "AWS::Partition"
                              },
                              "lambda",
                              {
                                "Ref": "AWS::Region"
                              },
                              {
                                "Ref": "AWS::AccountId"
                              },
                              "function",
                              "aws-icc-prod-analyseText"
                            ]
                          ]
                        },
                        "Action": [
                          "lambda:AddPermission",
                          "lambda:RemovePermission"
                        ]
                      },
                      {
                        "Effect": "Allow",
                        "Resource": {
                          "Fn::Join": [
                            ":",
                            [
                              "arn",
                              {
                                "Ref": "AWS::Partition"
                              },
                              "s3",
                              "",
                              "",
                              {
                                "Ref": "ComprehendCallResolutionBucket"
                              }
                            ]
                          ]
                        },
                        "Action": [
                          "s3:PutBucketNotification",
                          "s3:GetBucketNotification"
                        ]
                      },
                      {
                        "Effect": "Allow",
                        "Resource": {
                          "Fn::Join": [
                            ":",
                            [
                              "arn",
                              {
                                "Ref": "AWS::Partition"
                              },
                              "lambda",
                              {
                                "Ref": "AWS::Region"
                              },
                              {
                                "Ref": "AWS::AccountId"
                              },
                              "function",
                              "aws-icc-prod-createCallResolutionClassifer"
                            ]
                          ]
                        },
                        "Action": [
                          "lambda:AddPermission",
                          "lambda:RemovePermission"
                        ]
                      },
                      {
                        "Effect": "Allow",
                        "Resource": {
                          "Fn::Join": [
                            ":",
                            [
                              "arn",
                              {
                                "Ref": "AWS::Partition"
                              },
                              "s3",
                              "",
                              "",
                              {
                                "Ref": "ComprehendCallMotivationBucket"
                              }
                            ]
                          ]
                        },
                        "Action": [
                          "s3:PutBucketNotification",
                          "s3:GetBucketNotification"
                        ]
                      },
                      {
                        "Effect": "Allow",
                        "Resource": {
                          "Fn::Join": [
                            ":",
                            [
                              "arn",
                              {
                                "Ref": "AWS::Partition"
                              },
                              "lambda",
                              {
                                "Ref": "AWS::Region"
                              },
                              {
                                "Ref": "AWS::AccountId"
                              },
                              "function",
                              "aws-icc-prod-createCallMotivationClassifier"
                            ]
                          ]
                        },
                        "Action": [
                          "lambda:AddPermission",
                          "lambda:RemovePermission"
                        ]
                      }
                    ]
                  }
                }
              ]
            }
          },
          "CustomDashresourceDashexistingDashs3LambdaFunction": {
            "Type": "AWS::Lambda::Function",
            "Properties": {
              "Code": {
                "S3Bucket": {
                  "Ref": "ServerlessDeploymentBucket"
                },
                "S3Key": "serverless/aws-icc/prod/1596656717357-2020-08-05T19:45:17.357Z/custom-resources.zip"
              },
              "FunctionName": "aws-icc-prod-custom-resource-existing-s3",
              "Handler": "s3/handler.handler",
              "MemorySize": 1024,
              "Runtime": "nodejs12.x",
              "Timeout": 180,
              "Role": {
                "Fn::GetAtt": [
                  "IamRoleCustomResourcesLambdaExecution",
                  "Arn"
                ]
              }
            },
            "DependsOn": [
              "IamRoleCustomResourcesLambdaExecution"
            ]
          },
          "ApiGatewayResourceApi": {
            "Type": "AWS::ApiGateway::Resource",
            "Properties": {
              "ParentId": {
                "Fn::GetAtt": [
                  "Api",
                  "RootResourceId"
                ]
              },
              "PathPart": "api",
              "RestApiId": {
                "Ref": "Api"
              }
            }
          },
          "ApiGatewayResourceApiTranscripts": {
            "Type": "AWS::ApiGateway::Resource",
            "Properties": {
              "ParentId": {
                "Ref": "ApiGatewayResourceApi"
              },
              "PathPart": "transcripts",
              "RestApiId": {
                "Ref": "Api"
              }
            }
          },
          "ApiGatewayResourceApiAudio": {
            "Type": "AWS::ApiGateway::Resource",
            "Properties": {
              "ParentId": {
                "Ref": "ApiGatewayResourceApi"
              },
              "PathPart": "audio",
              "RestApiId": {
                "Ref": "Api"
              }
            }
          },
          "ApiGatewayResourceApiSentiment": {
            "Type": "AWS::ApiGateway::Resource",
            "Properties": {
              "ParentId": {
                "Ref": "ApiGatewayResourceApi"
              },
              "PathPart": "sentiment",
              "RestApiId": {
                "Ref": "Api"
              }
            }
          },
          "ApiGatewayResourceApiPresigned": {
            "Type": "AWS::ApiGateway::Resource",
            "Properties": {
              "ParentId": {
                "Ref": "ApiGatewayResourceApi"
              },
              "PathPart": "presigned",
              "RestApiId": {
                "Ref": "Api"
              }
            }
          },
          "ApiGatewayResourceApiStatus": {
            "Type": "AWS::ApiGateway::Resource",
            "Properties": {
              "ParentId": {
                "Ref": "ApiGatewayResourceApi"
              },
              "PathPart": "status",
              "RestApiId": {
                "Ref": "Api"
              }
            }
          },
          "ApiGatewayResourceAuth": {
            "Type": "AWS::ApiGateway::Resource",
            "Properties": {
              "ParentId": {
                "Fn::GetAtt": [
                  "Api",
                  "RootResourceId"
                ]
              },
              "PathPart": "auth",
              "RestApiId": {
                "Ref": "Api"
              }
            }
          },
          "ApiGatewayMethodApiTranscriptsOptions": {
            "Type": "AWS::ApiGateway::Method",
            "Properties": {
              "AuthorizationType": "NONE",
              "HttpMethod": "OPTIONS",
              "MethodResponses": [
                {
                  "StatusCode": "200",
                  "ResponseParameters": {
                    "method.response.header.Access-Control-Allow-Origin": true,
                    "method.response.header.Access-Control-Allow-Headers": true,
                    "method.response.header.Access-Control-Allow-Methods": true
                  },
                  "ResponseModels": {}
                }
              ],
              "RequestParameters": {},
              "Integration": {
                "Type": "MOCK",
                "RequestTemplates": {
                  "application/json": "{statusCode:200}"
                },
                "ContentHandling": "CONVERT_TO_TEXT",
                "IntegrationResponses": [
                  {
                    "StatusCode": "200",
                    "ResponseParameters": {
                      "method.response.header.Access-Control-Allow-Origin": "'*'",
                      "method.response.header.Access-Control-Allow-Headers": "'Content-Type,X-Amz-Date,Authorization,X-Api-Key,X-Amz-Security-Token,X-Amz-User-Agent'",
                      "method.response.header.Access-Control-Allow-Methods": "'OPTIONS,GET'"
                    },
                    "ResponseTemplates": {
                      "application/json": "#set($origin = $input.params(\"Origin\"))\n#if($origin == \"\") #set($origin = $input.params(\"origin\")) #end\n#if($origin.matches(\".+\")) #set($context.responseOverride.header.Access-Control-Allow-Origin = $origin) #end"
                    }
                  }
                ]
              },
              "ResourceId": {
                "Ref": "ApiGatewayResourceApiTranscripts"
              },
              "RestApiId": {
                "Ref": "Api"
              }
            }
          },
          "ApiGatewayMethodApiAudioOptions": {
            "Type": "AWS::ApiGateway::Method",
            "Properties": {
              "AuthorizationType": "NONE",
              "HttpMethod": "OPTIONS",
              "MethodResponses": [
                {
                  "StatusCode": "200",
                  "ResponseParameters": {
                    "method.response.header.Access-Control-Allow-Origin": true,
                    "method.response.header.Access-Control-Allow-Headers": true,
                    "method.response.header.Access-Control-Allow-Methods": true
                  },
                  "ResponseModels": {}
                }
              ],
              "RequestParameters": {},
              "Integration": {
                "Type": "MOCK",
                "RequestTemplates": {
                  "application/json": "{statusCode:200}"
                },
                "ContentHandling": "CONVERT_TO_TEXT",
                "IntegrationResponses": [
                  {
                    "StatusCode": "200",
                    "ResponseParameters": {
                      "method.response.header.Access-Control-Allow-Origin": "'*'",
                      "method.response.header.Access-Control-Allow-Headers": "'Content-Type,X-Amz-Date,Authorization,X-Api-Key,X-Amz-Security-Token,X-Amz-User-Agent'",
                      "method.response.header.Access-Control-Allow-Methods": "'OPTIONS,GET'"
                    },
                    "ResponseTemplates": {
                      "application/json": "#set($origin = $input.params(\"Origin\"))\n#if($origin == \"\") #set($origin = $input.params(\"origin\")) #end\n#if($origin.matches(\".+\")) #set($context.responseOverride.header.Access-Control-Allow-Origin = $origin) #end"
                    }
                  }
                ]
              },
              "ResourceId": {
                "Ref": "ApiGatewayResourceApiAudio"
              },
              "RestApiId": {
                "Ref": "Api"
              }
            }
          },
          "ApiGatewayMethodApiSentimentOptions": {
            "Type": "AWS::ApiGateway::Method",
            "Properties": {
              "AuthorizationType": "NONE",
              "HttpMethod": "OPTIONS",
              "MethodResponses": [
                {
                  "StatusCode": "200",
                  "ResponseParameters": {
                    "method.response.header.Access-Control-Allow-Origin": true,
                    "method.response.header.Access-Control-Allow-Headers": true,
                    "method.response.header.Access-Control-Allow-Methods": true
                  },
                  "ResponseModels": {}
                }
              ],
              "RequestParameters": {},
              "Integration": {
                "Type": "MOCK",
                "RequestTemplates": {
                  "application/json": "{statusCode:200}"
                },
                "ContentHandling": "CONVERT_TO_TEXT",
                "IntegrationResponses": [
                  {
                    "StatusCode": "200",
                    "ResponseParameters": {
                      "method.response.header.Access-Control-Allow-Origin": "'*'",
                      "method.response.header.Access-Control-Allow-Headers": "'Content-Type,X-Amz-Date,Authorization,X-Api-Key,X-Amz-Security-Token,X-Amz-User-Agent'",
                      "method.response.header.Access-Control-Allow-Methods": "'OPTIONS,GET'"
                    },
                    "ResponseTemplates": {
                      "application/json": "#set($origin = $input.params(\"Origin\"))\n#if($origin == \"\") #set($origin = $input.params(\"origin\")) #end\n#if($origin.matches(\".+\")) #set($context.responseOverride.header.Access-Control-Allow-Origin = $origin) #end"
                    }
                  }
                ]
              },
              "ResourceId": {
                "Ref": "ApiGatewayResourceApiSentiment"
              },
              "RestApiId": {
                "Ref": "Api"
              }
            }
          },
          "ApiGatewayMethodApiPresignedOptions": {
            "Type": "AWS::ApiGateway::Method",
            "Properties": {
              "AuthorizationType": "NONE",
              "HttpMethod": "OPTIONS",
              "MethodResponses": [
                {
                  "StatusCode": "200",
                  "ResponseParameters": {
                    "method.response.header.Access-Control-Allow-Origin": true,
                    "method.response.header.Access-Control-Allow-Headers": true,
                    "method.response.header.Access-Control-Allow-Methods": true
                  },
                  "ResponseModels": {}
                }
              ],
              "RequestParameters": {},
              "Integration": {
                "Type": "MOCK",
                "RequestTemplates": {
                  "application/json": "{statusCode:200}"
                },
                "ContentHandling": "CONVERT_TO_TEXT",
                "IntegrationResponses": [
                  {
                    "StatusCode": "200",
                    "ResponseParameters": {
                      "method.response.header.Access-Control-Allow-Origin": "'*'",
                      "method.response.header.Access-Control-Allow-Headers": "'Content-Type,X-Amz-Date,Authorization,X-Api-Key,X-Amz-Security-Token,X-Amz-User-Agent'",
                      "method.response.header.Access-Control-Allow-Methods": "'OPTIONS,POST'"
                    },
                    "ResponseTemplates": {
                      "application/json": "#set($origin = $input.params(\"Origin\"))\n#if($origin == \"\") #set($origin = $input.params(\"origin\")) #end\n#if($origin.matches(\".+\")) #set($context.responseOverride.header.Access-Control-Allow-Origin = $origin) #end"
                    }
                  }
                ]
              },
              "ResourceId": {
                "Ref": "ApiGatewayResourceApiPresigned"
              },
              "RestApiId": {
                "Ref": "Api"
              }
            }
          },
          "ApiGatewayMethodApiStatusOptions": {
            "Type": "AWS::ApiGateway::Method",
            "Properties": {
              "AuthorizationType": "NONE",
              "HttpMethod": "OPTIONS",
              "MethodResponses": [
                {
                  "StatusCode": "200",
                  "ResponseParameters": {
                    "method.response.header.Access-Control-Allow-Origin": true,
                    "method.response.header.Access-Control-Allow-Headers": true,
                    "method.response.header.Access-Control-Allow-Methods": true
                  },
                  "ResponseModels": {}
                }
              ],
              "RequestParameters": {},
              "Integration": {
                "Type": "MOCK",
                "RequestTemplates": {
                  "application/json": "{statusCode:200}"
                },
                "ContentHandling": "CONVERT_TO_TEXT",
                "IntegrationResponses": [
                  {
                    "StatusCode": "200",
                    "ResponseParameters": {
                      "method.response.header.Access-Control-Allow-Origin": "'*'",
                      "method.response.header.Access-Control-Allow-Headers": "'Content-Type,X-Amz-Date,Authorization,X-Api-Key,X-Amz-Security-Token,X-Amz-User-Agent'",
                      "method.response.header.Access-Control-Allow-Methods": "'OPTIONS,POST'"
                    },
                    "ResponseTemplates": {
                      "application/json": "#set($origin = $input.params(\"Origin\"))\n#if($origin == \"\") #set($origin = $input.params(\"origin\")) #end\n#if($origin.matches(\".+\")) #set($context.responseOverride.header.Access-Control-Allow-Origin = $origin) #end"
                    }
                  }
                ]
              },
              "ResourceId": {
                "Ref": "ApiGatewayResourceApiStatus"
              },
              "RestApiId": {
                "Ref": "Api"
              }
            }
          },
          "ApiGatewayMethodAuthOptions": {
            "Type": "AWS::ApiGateway::Method",
            "Properties": {
              "AuthorizationType": "NONE",
              "HttpMethod": "OPTIONS",
              "MethodResponses": [
                {
                  "StatusCode": "200",
                  "ResponseParameters": {
                    "method.response.header.Access-Control-Allow-Origin": true,
                    "method.response.header.Access-Control-Allow-Headers": true,
                    "method.response.header.Access-Control-Allow-Methods": true
                  },
                  "ResponseModels": {}
                }
              ],
              "RequestParameters": {},
              "Integration": {
                "Type": "MOCK",
                "RequestTemplates": {
                  "application/json": "{statusCode:200}"
                },
                "ContentHandling": "CONVERT_TO_TEXT",
                "IntegrationResponses": [
                  {
                    "StatusCode": "200",
                    "ResponseParameters": {
                      "method.response.header.Access-Control-Allow-Origin": "'*'",
                      "method.response.header.Access-Control-Allow-Headers": "'Content-Type,X-Amz-Date,Authorization,X-Api-Key,X-Amz-Security-Token,X-Amz-User-Agent'",
                      "method.response.header.Access-Control-Allow-Methods": "'OPTIONS,POST'"
                    },
                    "ResponseTemplates": {
                      "application/json": "#set($origin = $input.params(\"Origin\"))\n#if($origin == \"\") #set($origin = $input.params(\"origin\")) #end\n#if($origin.matches(\".+\")) #set($context.responseOverride.header.Access-Control-Allow-Origin = $origin) #end"
                    }
                  }
                ]
              },
              "ResourceId": {
                "Ref": "ApiGatewayResourceAuth"
              },
              "RestApiId": {
                "Ref": "Api"
              }
            }
          },
          "ApiGatewayMethodApiTranscriptsGet": {
            "Type": "AWS::ApiGateway::Method",
            "Properties": {
              "HttpMethod": "GET",
              "RequestParameters": {
                "method.request.header.authorization": false
              },
              "ResourceId": {
                "Ref": "ApiGatewayResourceApiTranscripts"
              },
              "RestApiId": {
                "Ref": "Api"
              },
              "ApiKeyRequired": false,
              "AuthorizationType": "COGNITO_USER_POOLS",
              "AuthorizerId": {
                "Ref": "ApiGatewayAuthorizer"
              },
              "AuthorizationScopes": [
                "email",
                "openid"
              ],
              "Integration": {
                "IntegrationHttpMethod": "POST",
                "Type": "AWS_PROXY",
                "Uri": {
                  "Fn::Join": [
                    "",
                    [
                      "arn:",
                      {
                        "Ref": "AWS::Partition"
                      },
                      ":apigateway:",
                      {
                        "Ref": "AWS::Region"
                      },
                      ":lambda:path/2015-03-31/functions/",
                      {
                        "Fn::GetAtt": [
                          "GetTranscriptsLambdaFunction",
                          "Arn"
                        ]
                      },
                      "/invocations"
                    ]
                  ]
                }
              },
              "MethodResponses": []
            }
          },
          "ApiGatewayMethodApiAudioGet": {
            "Type": "AWS::ApiGateway::Method",
            "Properties": {
              "HttpMethod": "GET",
              "RequestParameters": {
                "method.request.header.authorization": false
              },
              "ResourceId": {
                "Ref": "ApiGatewayResourceApiAudio"
              },
              "RestApiId": {
                "Ref": "Api"
              },
              "ApiKeyRequired": false,
              "AuthorizationType": "COGNITO_USER_POOLS",
              "AuthorizerId": {
                "Ref": "ApiGatewayAuthorizer"
              },
              "AuthorizationScopes": [
                "email",
                "openid"
              ],
              "Integration": {
                "IntegrationHttpMethod": "POST",
                "Type": "AWS_PROXY",
                "Uri": {
                  "Fn::Join": [
                    "",
                    [
                      "arn:",
                      {
                        "Ref": "AWS::Partition"
                      },
                      ":apigateway:",
                      {
                        "Ref": "AWS::Region"
                      },
                      ":lambda:path/2015-03-31/functions/",
                      {
                        "Fn::GetAtt": [
                          "GetAudioLambdaFunction",
                          "Arn"
                        ]
                      },
                      "/invocations"
                    ]
                  ]
                }
              },
              "MethodResponses": []
            }
          },
          "ApiGatewayMethodApiSentimentGet": {
            "Type": "AWS::ApiGateway::Method",
            "Properties": {
              "HttpMethod": "GET",
              "RequestParameters": {
                "method.request.header.authorization": false
              },
              "ResourceId": {
                "Ref": "ApiGatewayResourceApiSentiment"
              },
              "RestApiId": {
                "Ref": "Api"
              },
              "ApiKeyRequired": false,
              "AuthorizationType": "COGNITO_USER_POOLS",
              "AuthorizerId": {
                "Ref": "ApiGatewayAuthorizer"
              },
              "AuthorizationScopes": [
                "email",
                "openid"
              ],
              "Integration": {
                "IntegrationHttpMethod": "POST",
                "Type": "AWS_PROXY",
                "Uri": {
                  "Fn::Join": [
                    "",
                    [
                      "arn:",
                      {
                        "Ref": "AWS::Partition"
                      },
                      ":apigateway:",
                      {
                        "Ref": "AWS::Region"
                      },
                      ":lambda:path/2015-03-31/functions/",
                      {
                        "Fn::GetAtt": [
                          "GetSentimentLambdaFunction",
                          "Arn"
                        ]
                      },
                      "/invocations"
                    ]
                  ]
                }
              },
              "MethodResponses": []
            }
          },
          "ApiGatewayMethodApiPresignedPost": {
            "Type": "AWS::ApiGateway::Method",
            "Properties": {
              "HttpMethod": "POST",
              "RequestParameters": {
                "method.request.header.authorization": false
              },
              "ResourceId": {
                "Ref": "ApiGatewayResourceApiPresigned"
              },
              "RestApiId": {
                "Ref": "Api"
              },
              "ApiKeyRequired": false,
              "AuthorizationType": "COGNITO_USER_POOLS",
              "AuthorizerId": {
                "Ref": "ApiGatewayAuthorizer"
              },
              "AuthorizationScopes": [
                "email",
                "openid"
              ],
              "Integration": {
                "IntegrationHttpMethod": "POST",
                "Type": "AWS_PROXY",
                "Uri": {
                  "Fn::Join": [
                    "",
                    [
                      "arn:",
                      {
                        "Ref": "AWS::Partition"
                      },
                      ":apigateway:",
                      {
                        "Ref": "AWS::Region"
                      },
                      ":lambda:path/2015-03-31/functions/",
                      {
                        "Fn::GetAtt": [
                          "GetPresignedUrlLambdaFunction",
                          "Arn"
                        ]
                      },
                      "/invocations"
                    ]
                  ]
                }
              },
              "MethodResponses": []
            }
          },
          "ApiGatewayMethodApiStatusPost": {
            "Type": "AWS::ApiGateway::Method",
            "Properties": {
              "HttpMethod": "POST",
              "RequestParameters": {
                "method.request.header.authorization": false
              },
              "ResourceId": {
                "Ref": "ApiGatewayResourceApiStatus"
              },
              "RestApiId": {
                "Ref": "Api"
              },
              "ApiKeyRequired": false,
              "AuthorizationType": "COGNITO_USER_POOLS",
              "AuthorizerId": {
                "Ref": "ApiGatewayAuthorizer"
              },
              "AuthorizationScopes": [
                "email",
                "openid"
              ],
              "Integration": {
                "IntegrationHttpMethod": "POST",
                "Type": "AWS_PROXY",
                "Uri": {
                  "Fn::Join": [
                    "",
                    [
                      "arn:",
                      {
                        "Ref": "AWS::Partition"
                      },
                      ":apigateway:",
                      {
                        "Ref": "AWS::Region"
                      },
                      ":lambda:path/2015-03-31/functions/",
                      {
                        "Fn::GetAtt": [
                          "UpdateStatusLambdaFunction",
                          "Arn"
                        ]
                      },
                      "/invocations"
                    ]
                  ]
                }
              },
              "MethodResponses": []
            }
          },
          "ApiGatewayMethodAuthPost": {
            "Type": "AWS::ApiGateway::Method",
            "Properties": {
              "HttpMethod": "POST",
              "RequestParameters": {
                "method.request.header.authorization": false
              },
              "ResourceId": {
                "Ref": "ApiGatewayResourceAuth"
              },
              "RestApiId": {
                "Ref": "Api"
              },
              "ApiKeyRequired": false,
              "AuthorizationType": "COGNITO_USER_POOLS",
              "AuthorizerId": {
                "Ref": "ApiGatewayAuthorizer"
              },
              "AuthorizationScopes": [
                "email",
                "openid"
              ],
              "Integration": {
                "IntegrationHttpMethod": "POST",
                "Type": "AWS_PROXY",
                "Uri": {
                  "Fn::Join": [
                    "",
                    [
                      "arn:",
                      {
                        "Ref": "AWS::Partition"
                      },
                      ":apigateway:",
                      {
                        "Ref": "AWS::Region"
                      },
                      ":lambda:path/2015-03-31/functions/",
                      {
                        "Fn::GetAtt": [
                          "QuickSightFederationFunctionLambdaFunction",
                          "Arn"
                        ]
                      },
                      "/invocations"
                    ]
                  ]
                }
              },
              "MethodResponses": []
            }
          },
          "ApiGatewayDeployment1596656703888": {
            "Type": "AWS::ApiGateway::Deployment",
            "Properties": {
              "RestApiId": {
                "Ref": "Api"
              },
              "StageName": "prod"
            },
            "DependsOn": [
              "ApiGatewayMethodApiTranscriptsOptions",
              "ApiGatewayMethodApiAudioOptions",
              "ApiGatewayMethodApiSentimentOptions",
              "ApiGatewayMethodApiPresignedOptions",
              "ApiGatewayMethodApiStatusOptions",
              "ApiGatewayMethodAuthOptions",
              "ApiGatewayMethodApiTranscriptsGet",
              "ApiGatewayMethodApiAudioGet",
              "ApiGatewayMethodApiSentimentGet",
              "ApiGatewayMethodApiPresignedPost",
              "ApiGatewayMethodApiStatusPost",
              "ApiGatewayMethodAuthPost"
            ]
          },
          "GetTranscriptsLambdaPermissionApiGateway": {
            "Type": "AWS::Lambda::Permission",
            "Properties": {
              "FunctionName": {
                "Fn::GetAtt": [
                  "GetTranscriptsLambdaFunction",
                  "Arn"
                ]
              },
              "Action": "lambda:InvokeFunction",
              "Principal": "apigateway.amazonaws.com",
              "SourceArn": {
                "Fn::Join": [
                  "",
                  [
                    "arn:",
                    {
                      "Ref": "AWS::Partition"
                    },
                    ":execute-api:",
                    {
                      "Ref": "AWS::Region"
                    },
                    ":",
                    {
                      "Ref": "AWS::AccountId"
                    },
                    ":",
                    {
                      "$ref": "$[\"service\"][\"provider\"][\"apiGateway\"][\"restApiId\"]"
                    },
                    "/*/*"
                  ]
                ]
              }
            }
          },
          "GetAudioLambdaPermissionApiGateway": {
            "Type": "AWS::Lambda::Permission",
            "Properties": {
              "FunctionName": {
                "Fn::GetAtt": [
                  "GetAudioLambdaFunction",
                  "Arn"
                ]
              },
              "Action": "lambda:InvokeFunction",
              "Principal": "apigateway.amazonaws.com",
              "SourceArn": {
                "Fn::Join": [
                  "",
                  [
                    "arn:",
                    {
                      "Ref": "AWS::Partition"
                    },
                    ":execute-api:",
                    {
                      "Ref": "AWS::Region"
                    },
                    ":",
                    {
                      "Ref": "AWS::AccountId"
                    },
                    ":",
                    {
                      "$ref": "$[\"service\"][\"provider\"][\"apiGateway\"][\"restApiId\"]"
                    },
                    "/*/*"
                  ]
                ]
              }
            }
          },
          "GetSentimentLambdaPermissionApiGateway": {
            "Type": "AWS::Lambda::Permission",
            "Properties": {
              "FunctionName": {
                "Fn::GetAtt": [
                  "GetSentimentLambdaFunction",
                  "Arn"
                ]
              },
              "Action": "lambda:InvokeFunction",
              "Principal": "apigateway.amazonaws.com",
              "SourceArn": {
                "Fn::Join": [
                  "",
                  [
                    "arn:",
                    {
                      "Ref": "AWS::Partition"
                    },
                    ":execute-api:",
                    {
                      "Ref": "AWS::Region"
                    },
                    ":",
                    {
                      "Ref": "AWS::AccountId"
                    },
                    ":",
                    {
                      "$ref": "$[\"service\"][\"provider\"][\"apiGateway\"][\"restApiId\"]"
                    },
                    "/*/*"
                  ]
                ]
              }
            }
          },
          "GetPresignedUrlLambdaPermissionApiGateway": {
            "Type": "AWS::Lambda::Permission",
            "Properties": {
              "FunctionName": {
                "Fn::GetAtt": [
                  "GetPresignedUrlLambdaFunction",
                  "Arn"
                ]
              },
              "Action": "lambda:InvokeFunction",
              "Principal": "apigateway.amazonaws.com",
              "SourceArn": {
                "Fn::Join": [
                  "",
                  [
                    "arn:",
                    {
                      "Ref": "AWS::Partition"
                    },
                    ":execute-api:",
                    {
                      "Ref": "AWS::Region"
                    },
                    ":",
                    {
                      "Ref": "AWS::AccountId"
                    },
                    ":",
                    {
                      "$ref": "$[\"service\"][\"provider\"][\"apiGateway\"][\"restApiId\"]"
                    },
                    "/*/*"
                  ]
                ]
              }
            }
          },
          "UpdateStatusLambdaPermissionApiGateway": {
            "Type": "AWS::Lambda::Permission",
            "Properties": {
              "FunctionName": {
                "Fn::GetAtt": [
                  "UpdateStatusLambdaFunction",
                  "Arn"
                ]
              },
              "Action": "lambda:InvokeFunction",
              "Principal": "apigateway.amazonaws.com",
              "SourceArn": {
                "Fn::Join": [
                  "",
                  [
                    "arn:",
                    {
                      "Ref": "AWS::Partition"
                    },
                    ":execute-api:",
                    {
                      "Ref": "AWS::Region"
                    },
                    ":",
                    {
                      "Ref": "AWS::AccountId"
                    },
                    ":",
                    {
                      "$ref": "$[\"service\"][\"provider\"][\"apiGateway\"][\"restApiId\"]"
                    },
                    "/*/*"
                  ]
                ]
              }
            }
          },
          "QuickSightFederationFunctionLambdaPermissionApiGateway": {
            "Type": "AWS::Lambda::Permission",
            "Properties": {
              "FunctionName": {
                "Fn::GetAtt": [
                  "QuickSightFederationFunctionLambdaFunction",
                  "Arn"
                ]
              },
              "Action": "lambda:InvokeFunction",
              "Principal": "apigateway.amazonaws.com",
              "SourceArn": {
                "Fn::Join": [
                  "",
                  [
                    "arn:",
                    {
                      "Ref": "AWS::Partition"
                    },
                    ":execute-api:",
                    {
                      "Ref": "AWS::Region"
                    },
                    ":",
                    {
                      "Ref": "AWS::AccountId"
                    },
                    ":",
                    {
                      "$ref": "$[\"service\"][\"provider\"][\"apiGateway\"][\"restApiId\"]"
                    },
                    "/*/*"
                  ]
                ]
              }
            }
          },
          "LambdaBasicExecutionRole": {
            "Type": "AWS::IAM::Role",
            "Properties": {
              "RoleName": {
                "Fn::Join": [
                  "",
                  [
                    "basic-execution",
                    "-prod-",
                    {
                      "Ref": "ServicePrefix"
                    }
                  ]
                ]
              },
              "AssumeRolePolicyDocument": {
                "Version": "2012-10-17",
                "Statement": [
                  {
                    "Effect": "Allow",
                    "Principal": {
                      "Service": [
                        "lambda.amazonaws.com"
                      ]
                    },
                    "Action": "sts:AssumeRole"
                  }
                ]
              },
              "ManagedPolicyArns": [
                "arn:aws:iam::aws:policy/service-role/AWSLambdaBasicExecutionRole"
              ]
            }
          },
          "TranscribeS3DynamoDBRole": {
            "Type": "AWS::IAM::Role",
            "Properties": {
              "RoleName": {
                "Fn::Join": [
                  "",
                  [
                    "transcribe-s3-dynamo-full-access",
                    "-prod-",
                    {
                      "Ref": "ServicePrefix"
                    }
                  ]
                ]
              },
              "AssumeRolePolicyDocument": {
                "Version": "2012-10-17",
                "Statement": [
                  {
                    "Effect": "Allow",
                    "Principal": {
                      "Service": [
                        "lambda.amazonaws.com"
                      ]
                    },
                    "Action": "sts:AssumeRole"
                  }
                ]
              },
              "ManagedPolicyArns": [
                "arn:aws:iam::aws:policy/service-role/AWSLambdaBasicExecutionRole",
                "arn:aws:iam::aws:policy/AmazonTranscribeFullAccess",
                {
                  "Ref": "TranscriptionAudioFilesPolicy"
                }
              ],
              "Policies": [
                {
                  "PolicyName": "UpdateDynamoDBAndTranscribeOutputPolicy",
                  "PolicyDocument": {
                    "Version": "2012-10-17",
                    "Statement": [
                      {
                        "Effect": "Allow",
                        "Action": [
                          "dynamodb:Update*"
                        ],
                        "Resource": [
                          {
                            "Fn::GetAtt": [
                              "StatusTable",
                              "Arn"
                            ]
                          }
                        ]
                      },
                      {
                        "Effect": "Allow",
                        "Action": [
                          "s3:Put*",
                          "s3:ListBucket",
                          "s3:Get*"
                        ],
                        "Resource": [
                          {
                            "Fn::Join": [
                              "",
                              [
                                "arn:aws:s3:::",
                                "transcription-output-prod-",
                                {
                                  "Ref": "ServicePrefix"
                                }
                              ]
                            ]
                          },
                          {
                            "Fn::Join": [
                              "",
                              [
                                "arn:aws:s3:::",
                                "transcription-output-prod-",
                                {
                                  "Ref": "ServicePrefix"
                                },
                                "/*"
                              ]
                            ]
                          }
                        ]
                      }
                    ]
                  }
                }
              ]
            }
          },
          "DynamoBatchWriteRole": {
            "Type": "AWS::IAM::Role",
            "Properties": {
              "RoleName": {
                "Fn::Join": [
                  "",
                  [
                    "dynamodb-batch-write-role",
                    "-prod-",
                    {
                      "Ref": "ServicePrefix"
                    }
                  ]
                ]
              },
              "AssumeRolePolicyDocument": {
                "Version": "2012-10-17",
                "Statement": [
                  {
                    "Effect": "Allow",
                    "Principal": {
                      "Service": [
                        "lambda.amazonaws.com"
                      ]
                    },
                    "Action": "sts:AssumeRole"
                  }
                ]
              },
              "ManagedPolicyArns": [
                "arn:aws:iam::aws:policy/service-role/AWSLambdaBasicExecutionRole"
              ],
              "Policies": [
                {
                  "PolicyName": "ScanDynamoDBPolicy",
                  "PolicyDocument": {
                    "Version": "2012-10-17",
                    "Statement": [
                      {
                        "Effect": "Allow",
                        "Action": [
                          "dynamodb:batchWrite"
                        ],
                        "Resource": [
                          {
                            "Fn::GetAtt": [
                              "StatusTable",
                              "Arn"
                            ]
                          }
                        ]
                      },
                      {
                        "Effect": "Allow",
                        "Action": [
                          "dynamodb:BatchWriteItem"
                        ],
                        "Resource": [
                          {
                            "Fn::GetAtt": [
                              "StatusTable",
                              "Arn"
                            ]
                          }
                        ]
                      }
                    ]
                  }
                }
              ]
            }
          },
          "S3ReadOnlyAccessRole": {
            "Type": "AWS::IAM::Role",
            "Properties": {
              "RoleName": {
                "Fn::Join": [
                  "",
                  [
                    "s3-readonly-access",
                    "-prod-",
                    {
                      "Ref": "ServicePrefix"
                    }
                  ]
                ]
              },
              "AssumeRolePolicyDocument": {
                "Version": "2012-10-17",
                "Statement": [
                  {
                    "Effect": "Allow",
                    "Principal": {
                      "Service": [
                        "apigateway.amazonaws.com"
                      ]
                    },
                    "Action": "sts:AssumeRole"
                  }
                ]
              },
              "ManagedPolicyArns": [
                "arn:aws:iam::aws:policy/AmazonS3ReadOnlyAccess"
              ]
            }
          },
          "TranscriptionAudioFilesRole": {
            "Type": "AWS::IAM::Role",
            "Properties": {
              "RoleName": {
                "Fn::Join": [
                  "",
                  [
                    "transcription-audio-files",
                    "-prod-",
                    {
                      "Ref": "ServicePrefix"
                    }
                  ]
                ]
              },
              "AssumeRolePolicyDocument": {
                "Version": "2012-10-17",
                "Statement": [
                  {
                    "Effect": "Allow",
                    "Principal": {
                      "Service": [
                        "lambda.amazonaws.com"
                      ]
                    },
                    "Action": "sts:AssumeRole"
                  }
                ]
              },
              "ManagedPolicyArns": [
                "arn:aws:iam::aws:policy/service-role/AWSLambdaBasicExecutionRole",
                {
                  "Ref": "TranscriptionAudioFilesPolicy"
                }
              ]
            }
          },
          "ScanTranscriptsRole": {
            "Type": "AWS::IAM::Role",
            "Properties": {
              "RoleName": {
                "Fn::Join": [
                  "",
                  [
                    "scan-transcripts",
                    "-prod-",
                    {
                      "Ref": "ServicePrefix"
                    }
                  ]
                ]
              },
              "AssumeRolePolicyDocument": {
                "Version": "2012-10-17",
                "Statement": [
                  {
                    "Effect": "Allow",
                    "Principal": {
                      "Service": [
                        "lambda.amazonaws.com"
                      ]
                    },
                    "Action": "sts:AssumeRole"
                  }
                ]
              },
              "ManagedPolicyArns": [
                "arn:aws:iam::aws:policy/service-role/AWSLambdaBasicExecutionRole"
              ],
              "Policies": [
                {
                  "PolicyName": "ScanDynamoDBPolicy",
                  "PolicyDocument": {
                    "Version": "2012-10-17",
                    "Statement": [
                      {
                        "Effect": "Allow",
                        "Action": [
                          "dynamodb:Scan"
                        ],
                        "Resource": [
                          {
                            "Fn::GetAtt": [
                              "StatusTable",
                              "Arn"
                            ]
                          }
                        ]
                      }
                    ]
                  }
                }
              ]
            }
          },
          "TranscriptSplitterRole": {
            "Type": "AWS::IAM::Role",
            "Properties": {
              "RoleName": {
                "Fn::Join": [
                  "",
                  [
                    "split-transcript-role",
                    "-prod-",
                    {
                      "Ref": "ServicePrefix"
                    }
                  ]
                ]
              },
              "AssumeRolePolicyDocument": {
                "Version": "2012-10-17",
                "Statement": [
                  {
                    "Effect": "Allow",
                    "Principal": {
                      "Service": [
                        "lambda.amazonaws.com"
                      ]
                    },
                    "Action": "sts:AssumeRole"
                  }
                ]
              },
              "ManagedPolicyArns": [
                "arn:aws:iam::aws:policy/AWSLambdaExecute",
                "arn:aws:iam::aws:policy/AmazonDynamoDBFullAccess"
              ]
            }
          },
          "GetSentimentsRole": {
            "Type": "AWS::IAM::Role",
            "Properties": {
              "RoleName": {
                "Fn::Join": [
                  "",
                  [
                    "get-sentiments-role",
                    "-prod-",
                    {
                      "Ref": "ServicePrefix"
                    }
                  ]
                ]
              },
              "AssumeRolePolicyDocument": {
                "Version": "2012-10-17",
                "Statement": [
                  {
                    "Effect": "Allow",
                    "Principal": {
                      "Service": [
                        "lambda.amazonaws.com"
                      ]
                    },
                    "Action": "sts:AssumeRole"
                  }
                ]
              },
              "ManagedPolicyArns": [
                "arn:aws:iam::aws:policy/AWSLambdaExecute",
                {
                  "Ref": "TextAnalysisPolicy"
                }
              ]
            }
          },
          "TextAnalysisRole": {
            "Type": "AWS::IAM::Role",
            "Properties": {
              "RoleName": {
                "Fn::Join": [
                  "",
                  [
                    "text-analysis-role",
                    "-prod-",
                    {
                      "Ref": "ServicePrefix"
                    }
                  ]
                ]
              },
              "AssumeRolePolicyDocument": {
                "Version": "2012-10-17",
                "Statement": [
                  {
                    "Effect": "Allow",
                    "Principal": {
                      "Service": [
                        "comprehend.amazonaws.com"
                      ]
                    },
                    "Action": [
                      "sts:AssumeRole"
                    ]
                  }
                ]
              },
              "ManagedPolicyArns": [
                {
                  "Ref": "TextAnalysisPolicy"
                }
              ]
            }
          },
          "TextAnalysisResultCrawlerRole": {
            "Type": "AWS::IAM::Role",
            "Properties": {
              "AssumeRolePolicyDocument": {
                "Version": "2012-10-17",
                "Statement": [
                  {
                    "Effect": "Allow",
                    "Principal": {
                      "Service": [
                        "glue.amazonaws.com"
                      ]
                    },
                    "Action": [
                      "sts:AssumeRole"
                    ]
                  }
                ]
              },
              "Path": "/",
              "Policies": [
                {
                  "PolicyName": "TextAnalysisResultCrawlerRolePolicy",
                  "PolicyDocument": {
                    "Version": "2012-10-17",
                    "Statement": [
                      {
                        "Effect": "Allow",
                        "Action": "*",
                        "Resource": "*"
                      }
                    ]
                  }
                }
              ]
            }
          },
          "ComprehendFullAccessRole": {
            "Type": "AWS::IAM::Role",
            "Properties": {
              "RoleName": {
                "Fn::Join": [
                  "",
                  [
                    "comprehend-full-access-role",
                    "-prod-",
                    {
                      "Ref": "ServicePrefix"
                    }
                  ]
                ]
              },
              "AssumeRolePolicyDocument": {
                "Version": "2012-10-17",
                "Statement": [
                  {
                    "Effect": "Allow",
                    "Principal": {
                      "Service": [
                        "lambda.amazonaws.com"
                      ]
                    },
                    "Action": "sts:AssumeRole"
                  }
                ]
              },
              "ManagedPolicyArns": [
                "arn:aws:iam::aws:policy/service-role/AWSLambdaBasicExecutionRole",
                {
                  "Ref": "ComprehendFullAccessPolicy"
                },
                {
                  "Ref": "SnsNotificationPolicy"
                }
              ]
            }
          },
          "ComprehendDataAccessRole": {
            "Type": "AWS::IAM::Role",
            "Properties": {
              "RoleName": {
                "Fn::Join": [
                  "",
                  [
                    "comprehend-data-access",
                    "-prod-",
                    {
                      "Ref": "ServicePrefix"
                    }
                  ]
                ]
              },
              "AssumeRolePolicyDocument": {
                "Version": "2012-10-17",
                "Statement": [
                  {
                    "Effect": "Allow",
                    "Principal": {
                      "Service": [
                        "comprehend.amazonaws.com"
                      ]
                    },
                    "Action": "sts:AssumeRole"
                  }
                ]
              },
              "ManagedPolicyArns": [
                "arn:aws:iam::aws:policy/service-role/ComprehendDataAccessRolePolicy"
              ]
            }
          },
          "ApiGatewayAuthorizer": {
            "Type": "AWS::ApiGateway::Authorizer",
            "DependsOn": [
              "Api"
            ],
            "Properties": {
              "AuthorizerResultTtlInSeconds": 300,
              "IdentitySource": "method.request.header.Authorization",
              "Name": {
                "Fn::Join": [
                  "",
                  [
                    "cognito-authorizer",
                    "-prod-",
                    {
                      "Ref": "ServicePrefix"
                    }
                  ]
                ]
              },
              "RestApiId": {
                "Ref": "Api"
              },
              "Type": "COGNITO_USER_POOLS",
              "ProviderARNs": [
                {
                  "Fn::GetAtt": [
                    "UserPool",
                    "Arn"
                  ]
                }
              ]
            }
          },
          "CognitoAuthUI": {
            "Type": "AWS::Cognito::UserPoolUICustomizationAttachment",
            "Properties": {
              "ClientId": {
                "Ref": "UserPoolClient"
              },
              "UserPoolId": {
                "Ref": "UserPool"
              }
            }
          },
          "CognitoDomain": {
            "Type": "AWS::Cognito::UserPoolDomain",
            "Properties": {
              "Domain": {
                "Ref": "UserPoolDomainName"
              },
              "UserPoolId": {
                "Ref": "UserPool"
              }
            }
          },
          "UserPool": {
            "Type": "AWS::Cognito::UserPool",
            "Properties": {
              "UserPoolName": {
                "Fn::Join": [
                  "",
                  [
                    {
                      "Ref": "UserPoolName"
                    },
                    "-prod-",
                    {
                      "Ref": "ServicePrefix"
                    }
                  ]
                ]
              },
              "UsernameAttributes": [
                "email"
              ],
              "AutoVerifiedAttributes": [
                "email"
              ],
              "Schema": [
                {
                  "Name": "userId",
                  "AttributeDataType": "String",
                  "Mutable": true
                }
              ]
            }
          },
          "UserPoolClient": {
            "Type": "AWS::Cognito::UserPoolClient",
            "Properties": {
              "UserPoolId": {
                "Ref": "UserPool"
              },
              "GenerateSecret": false,
              "RefreshTokenValidity": 30,
              "ReadAttributes": [
                "family_name",
                "given_name",
                "email"
              ],
              "WriteAttributes": [
                "family_name",
                "given_name",
                "email"
              ],
              "AllowedOAuthFlows": [
                "code"
              ],
              "SupportedIdentityProviders": [
                "COGNITO"
              ],
              "AllowedOAuthFlowsUserPoolClient": true,
              "AllowedOAuthScopes": [
                "openid",
                "profile",
                "email"
              ],
              "CallbackURLs": [
                {
                  "Fn::Join": [
                    "",
                    [
                      "https://",
                      {
                        "Fn::GetAtt": [
                          "CloudFrontDistribution",
                          "DomainName"
                        ]
                      },
                      "/login"
                    ]
                  ]
                }
              ],
              "LogoutURLs": [
                {
                  "Fn::Join": [
                    "",
                    [
                      "https://",
                      {
                        "Fn::GetAtt": [
                          "CloudFrontDistribution",
                          "DomainName"
                        ]
                      },
                      "/login"
                    ]
                  ]
                }
              ]
            }
          },
          "IdentityPool": {
            "Type": "AWS::Cognito::IdentityPool",
            "Properties": {
              "IdentityPoolName": {
                "Fn::Join": [
                  "",
                  [
                    {
                      "Ref": "IdentityPoolName"
                    },
                    "-prod-",
                    {
                      "Ref": "ServicePrefix"
                    }
                  ]
                ]
              },
              "AllowUnauthenticatedIdentities": true,
              "CognitoIdentityProviders": [
                {
                  "ClientId": {
                    "Ref": "UserPoolClient"
                  },
                  "ProviderName": {
                    "Fn::GetAtt": [
                      "UserPool",
                      "ProviderName"
                    ]
                  },
                  "ServerSideTokenCheck": true
                }
              ]
            }
          },
          "QuickSightUserRole": {
            "Type": "AWS::IAM::Role",
            "Properties": {
              "RoleName": {
                "Fn::Join": [
                  "",
                  [
                    {
                      "Ref": "QuickSightUserRoleName"
                    },
                    "_prod_",
                    {
                      "Ref": "ServicePrefix"
                    }
                  ]
                ]
              },
              "AssumeRolePolicyDocument": {
                "Version": "2012-10-17",
                "Statement": [
                  {
                    "Effect": "Allow",
                    "Principal": {
                      "Federated": "cognito-identity.amazonaws.com"
                    },
                    "Action": [
                      "sts:AssumeRoleWithWebIdentity"
                    ],
                    "Condition": {
                      "StringEquals": {
                        "cognito-identity.amazonaws.com:aud": {
                          "Ref": "IdentityPool"
                        }
                      },
                      "ForAnyValue:StringLike": {
                        "cognito-identity.amazonaws.com:amr": "authenticated"
                      }
                    }
                  }
                ]
              },
              "Policies": [
                {
                  "PolicyName": "QuickSightUserRolePolicy",
                  "PolicyDocument": {
                    "Version": "2012-10-17",
                    "Statement": [
                      {
                        "Effect": "Allow",
                        "Action": [
                          "quicksight:Create*",
                          "quicksight:Describe*",
                          "quicksight:Delete*",
                          "quicksight:TagResource",
                          "quicksight:PassDataSource"
                        ],
                        "Resource": "*"
                      }
                    ]
                  }
                }
              ]
            }
          },
          "IdentityPoolRoleAttachment": {
            "Type": "AWS::Cognito::IdentityPoolRoleAttachment",
            "Properties": {
              "IdentityPoolId": {
                "Ref": "IdentityPool"
              },
              "Roles": {
                "authenticated": {
                  "Fn::GetAtt": [
                    "QuickSightUserRole",
                    "Arn"
                  ]
                }
              }
            }
          },
          "ComprehendCallResolutionBucket": {
            "Type": "AWS::S3::Bucket",
            "Properties": {
              "BucketName": {
                "Fn::Join": [
                  "",
                  [
                    "comprehend-call-resolution",
                    "-prod-",
                    {
                      "Ref": "ServicePrefix"
                    }
                  ]
                ]
              }
            }
          },
          "ComprehendCallMotivationBucket": {
            "Type": "AWS::S3::Bucket",
            "Properties": {
              "BucketName": {
                "Fn::Join": [
                  "",
                  [
                    "comprehend-call-motivation",
                    "-prod-",
                    {
                      "Ref": "ServicePrefix"
                    }
                  ]
                ]
              }
            }
          },
          "TranscriptionOutput": {
            "Type": "AWS::S3::Bucket",
            "Properties": {
              "BucketName": {
                "Fn::Join": [
                  "",
                  [
                    "transcription-output",
                    "-prod-",
                    {
                      "Ref": "ServicePrefix"
                    }
                  ]
                ]
              }
            }
          },
          "TranscriptionAudioFiles": {
            "Type": "AWS::S3::Bucket",
            "Properties": {
              "BucketName": {
                "Fn::Join": [
                  "",
                  [
                    "transcription-audio-files",
                    "-prod-",
                    {
                      "Ref": "ServicePrefix"
                    }
                  ]
                ]
              },
              "CorsConfiguration": {
                "CorsRules": [
                  {
                    "AllowedHeaders": [
                      "*"
                    ],
                    "AllowedMethods": [
                      "PUT"
                    ],
                    "AllowedOrigins": [
                      "*"
                    ]
                  }
                ]
              }
            }
          },
          "StatusTable": {
            "Type": "AWS::DynamoDB::Table",
            "Properties": {
              "TableName": {
                "Fn::Join": [
                  "",
                  [
                    "jobStatus",
                    "-prod-",
                    {
                      "Ref": "ServicePrefix"
                    }
                  ]
                ]
              },
              "AttributeDefinitions": [
                {
                  "AttributeName": "jobId",
                  "AttributeType": "S"
                },
                {
                  "AttributeName": "audioURI",
                  "AttributeType": "S"
                },
                {
                  "AttributeName": "transcriptURI",
                  "AttributeType": "S"
                },
                {
                  "AttributeName": "lastModified",
                  "AttributeType": "S"
                },
                {
                  "AttributeName": "transcriptionJobName",
                  "AttributeType": "S"
                }
              ],
              "KeySchema": [
                {
                  "AttributeName": "jobId",
                  "KeyType": "HASH"
                },
                {
                  "AttributeName": "lastModified",
                  "KeyType": "RANGE"
                }
              ],
              "LocalSecondaryIndexes": [
                {
                  "IndexName": "audioLSI",
                  "KeySchema": [
                    {
                      "AttributeName": "jobId",
                      "KeyType": "HASH"
                    },
                    {
                      "AttributeName": "audioURI",
                      "KeyType": "RANGE"
                    }
                  ],
                  "Projection": {
                    "ProjectionType": "ALL"
                  }
                },
                {
                  "IndexName": "transcriptLSI",
                  "KeySchema": [
                    {
                      "AttributeName": "jobId",
                      "KeyType": "HASH"
                    },
                    {
                      "AttributeName": "transcriptURI",
                      "KeyType": "RANGE"
                    }
                  ],
                  "Projection": {
                    "ProjectionType": "ALL"
                  }
                }
              ],
              "GlobalSecondaryIndexes": [
                {
                  "IndexName": "jobStatusGSI",
                  "KeySchema": [
                    {
                      "AttributeName": "transcriptionJobName",
                      "KeyType": "HASH"
                    }
                  ],
                  "Projection": {
                    "ProjectionType": "ALL"
                  },
                  "ProvisionedThroughput": {
                    "ReadCapacityUnits": 1,
                    "WriteCapacityUnits": 1
                  }
                }
              ],
              "ProvisionedThroughput": {
                "ReadCapacityUnits": 1,
                "WriteCapacityUnits": 1
              }
            }
          },
          "SplitTranscriptOutput": {
            "Type": "AWS::S3::Bucket",
            "Properties": {
              "BucketName": {
                "Fn::Join": [
                  "",
                  [
                    "split-transcript-output",
                    "-prod-",
                    {
                      "Ref": "ServicePrefix"
                    }
                  ]
                ]
              }
            }
          },
          "TextAnalysisOutput": {
            "Type": "AWS::S3::Bucket",
            "Properties": {
              "BucketName": {
                "Fn::Join": [
                  "",
                  [
                    "text-analysis-output",
                    "-prod-",
                    {
                      "Ref": "ServicePrefix"
                    }
                  ]
                ]
              }
            }
          },
          "TranscriptionAudioFilesPolicy": {
            "Type": "AWS::IAM::ManagedPolicy",
            "Properties": {
              "ManagedPolicyName": {
                "Fn::Join": [
                  "",
                  [
                    "get-presignedurl-policy",
                    "-prod-",
                    {
                      "Ref": "ServicePrefix"
                    }
                  ]
                ]
              },
              "PolicyDocument": {
                "Version": "2012-10-17",
                "Statement": [
                  {
                    "Effect": "Allow",
                    "Action": [
                      "s3:Put*",
                      "s3:ListBucket",
                      "s3:Get*"
                    ],
                    "Resource": [
                      {
                        "Fn::Join": [
                          "",
                          [
                            "arn:aws:s3:::",
                            "transcription-audio-files-prod-",
                            {
                              "Ref": "ServicePrefix"
                            }
                          ]
                        ]
                      },
                      {
                        "Fn::Join": [
                          "",
                          [
                            "arn:aws:s3:::",
                            "transcription-audio-files-prod-",
                            {
                              "Ref": "ServicePrefix"
                            },
                            "/*"
                          ]
                        ]
                      }
                    ]
                  }
                ]
              }
            }
          },
          "TextAnalysisPolicy": {
            "Type": "AWS::IAM::ManagedPolicy",
            "Properties": {
              "ManagedPolicyName": {
                "Fn::Join": [
                  "",
                  [
                    "text-analysis-policy",
                    "-prod-",
                    {
                      "Ref": "ServicePrefix"
                    }
                  ]
                ]
              },
              "PolicyDocument": {
                "Version": "2012-10-17",
                "Statement": [
                  {
                    "Effect": "Allow",
                    "Action": [
                      "s3:Put*",
                      "s3:ListBucket",
                      "s3:Get*"
                    ],
                    "Resource": [
                      {
                        "Fn::Join": [
                          "",
                          [
                            "arn:aws:s3:::",
                            "text-analysis-output-prod-",
                            {
                              "Ref": "ServicePrefix"
                            }
                          ]
                        ]
                      },
                      {
                        "Fn::Join": [
                          "",
                          [
                            "arn:aws:s3:::",
                            "text-analysis-output-prod-",
                            {
                              "Ref": "ServicePrefix"
                            },
                            "/*"
                          ]
                        ]
                      }
                    ]
                  }
                ]
              }
            }
          },
          "TextAnalysisDatabase": {
            "Type": "AWS::Glue::Database",
            "Properties": {
              "CatalogId": {
                "Ref": "AWS::AccountId"
              },
              "DatabaseInput": {
                "Name": {
                  "Fn::Join": [
                    "",
                    [
                      "text_analysis_database",
                      "-prod-",
                      {
                        "Ref": "ServicePrefix"
                      }
                    ]
                  ]
                },
                "Description": "AWS Glue container to hold metadata tables for the text analysis crawler"
              }
            }
          },
          "TextAnalysisMetadataCrawler": {
            "Type": "AWS::Glue::Crawler",
            "Properties": {
              "Name": {
                "Fn::Join": [
                  "",
                  [
                    "text-analysis-metadata-crawler",
                    "-prod-",
                    {
                      "Ref": "ServicePrefix"
                    }
                  ]
                ]
              },
              "Role": {
                "Fn::GetAtt": [
                  "TextAnalysisResultCrawlerRole",
                  "Arn"
                ]
              },
              "Description": "AWS Glue crawler to crawl text analysis results",
              "Schedule": {
                "ScheduleExpression": "cron(0/59 * * * ? *)"
              },
              "DatabaseName": {
                "Ref": "TextAnalysisDatabase"
              },
              "Targets": {
                "S3Targets": [
                  {
                    "Path": {
                      "Ref": "TextAnalysisOutput"
                    }
                  }
                ]
              },
              "SchemaChangePolicy": {
                "UpdateBehavior": "UPDATE_IN_DATABASE",
                "DeleteBehavior": "LOG"
              },
              "Configuration": "{\"Version\":1.0,\"CrawlerOutput\":{\"Partitions\":{\"AddOrUpdateBehavior\":\"InheritFromTable\"},\"Tables\":{\"AddOrUpdateBehavior\":\"MergeNewColumns\"}}}"
            }
          },
          "TextAnalysisAthena": {
            "Type": "AWS::S3::Bucket",
            "Properties": {
              "BucketName": {
                "Fn::Join": [
                  "",
                  [
                    "text-analysis-athena-results",
                    "-prod-",
                    {
                      "Ref": "ServicePrefix"
                    }
                  ]
                ]
              }
            }
          },
          "FetchTurnByTurnSentimentsNamedQuery": {
            "Type": "AWS::Athena::NamedQuery",
            "Properties": {
              "Database": {
                "Ref": "TextAnalysisDatabase"
              },
              "Description": "A query that selects turn by turn sentiments",
              "Name": "Select Turn by turn sentiments",
              "QueryString": {
                "Fn::Join": [
                  "",
                  [
                    "WITH dataset AS ( select asset_id as id, call_resolution_status as resolution, call_motivation_status as motivation, turns from ",
                    "\"text_analysis_database-prod-",
                    {
                      "Ref": "ServicePrefix"
                    },
                    "\".\"",
                    "text_analysis_output_prod_",
                    {
                      "Fn::Join": [
                        "_",
                        {
                          "Fn::Split": [
                            "-",
                            {
                              "Ref": "ServicePrefix"
                            }
                          ]
                        }
                      ]
                    },
                    "\"",
                    ") select id, turn.turn, turn.channel, resolution, motivation, turn.sentiment.Sentiment, turn.sentiment.SentimentScore, turn.text from dataset cross join unnest(turns) t(turn)"
                  ]
                ]
              }
            }
          },
          "ComprehendFullAccessPolicy": {
            "Type": "AWS::IAM::ManagedPolicy",
            "Properties": {
              "ManagedPolicyName": {
                "Fn::Join": [
                  "",
                  [
                    "comprehend-full-access-policy",
                    "-prod-",
                    {
                      "Ref": "ServicePrefix"
                    }
                  ]
                ]
              },
              "PolicyDocument": {
                "Version": "2012-10-17",
                "Statement": [
                  {
                    "Effect": "Allow",
                    "Action": [
                      "s3:Put*",
                      "s3:ListBucket",
                      "s3:Get*"
                    ],
                    "Resource": "*"
                  },
                  {
                    "Effect": "Allow",
                    "Action": [
                      "lambda:InvokeFunction"
                    ],
                    "Resource": "*"
                  },
                  {
                    "Effect": "Allow",
                    "Action": [
                      "comprehend:Create*",
                      "comprehend:Describe*",
                      "comprehend:Batch*",
                      "comprehend:Delete*",
                      "comprehend:Detect*",
                      "comprehend:List*",
                      "comprehend:Start*",
                      "comprehend:Stop*",
                      "comprehend:ClassifyDocument"
                    ],
                    "Resource": "*"
                  },
                  {
                    "Effect": "Allow",
                    "Action": [
                      "events:Disable*"
                    ],
                    "Resource": "*"
                  },
                  {
                    "Effect": "Allow",
                    "Action": [
                      "dynamodb:*"
                    ],
                    "Resource": {
                      "Fn::Join": [
                        "",
                        [
                          "arn:aws:dynamodb:",
                          {
                            "Ref": "AWS::Region"
                          },
                          {
                            "Fn::Sub": ":${AWS::AccountId}:table/"
                          },
                          {
                            "Ref": "StatusTable"
                          }
                        ]
                      ]
                    }
                  },
                  {
                    "Effect": "Allow",
                    "Action": [
                      "iam:PassRole"
                    ],
                    "Resource": [
                      {
                        "Fn::GetAtt": [
                          "ComprehendDataAccessRole",
                          "Arn"
                        ]
                      },
                      {
                        "Fn::GetAtt": [
                          "TextAnalysisRole",
                          "Arn"
                        ]
                      }
                    ]
                  }
                ]
              }
            }
          },
          "SnsNotificationPolicy": {
            "Type": "AWS::IAM::ManagedPolicy",
            "Properties": {
              "ManagedPolicyName": {
                "Fn::Join": [
                  "",
                  [
                    "sns-notification",
                    "-prod-",
                    {
                      "Ref": "ServicePrefix"
                    }
                  ]
                ]
              },
              "PolicyDocument": {
                "Version": "2012-10-17",
                "Statement": [
                  {
                    "Effect": "Allow",
                    "Action": [
                      "sns:*"
                    ],
                    "Resource": [
                      {
                        "Ref": "ThreatNotificationTopic"
                      }
                    ]
                  }
                ]
              }
            }
          },
          "ThreatNotificationTopic": {
            "Type": "AWS::SNS::Topic",
            "Properties": {
              "Subscription": [
                {
                  "Endpoint": {
                    "Ref": "NotificationEmail"
                  },
                  "Protocol": "email"
                }
              ],
              "DisplayName": {
                "Fn::Join": [
                  "",
                  [
                    "threat-notification",
                    "-prod-",
                    {
                      "Ref": "ServicePrefix"
                    }
                  ]
                ]
              },
              "TopicName": {
                "Fn::Join": [
                  "",
                  [
                    "threat-notification",
                    "-prod-",
                    {
                      "Ref": "ServicePrefix"
                    }
                  ]
                ]
              }
            }
          },
          "CleanUpS3Buckets": {
            "DependsOn": [
              "ComprehendCallResolutionBucket",
              "ComprehendCallMotivationBucket",
              "TranscriptionOutput",
              "TranscriptionAudioFiles",
              "SplitTranscriptOutput",
              "TextAnalysisOutput",
              "TextAnalysisAthena",
              "PortalBucket"
            ],
            "Type": "Custom::CleanUpS3Buckets",
            "Properties": {
              "ServiceToken": {
                "Fn::GetAtt": [
                  "CleanUpS3BucketsFunction",
                  "Arn"
                ]
              },
              "Buckets": [
                {
                  "Ref": "ComprehendCallResolutionBucket"
                },
                {
                  "Ref": "ComprehendCallMotivationBucket"
                },
                {
                  "Ref": "TranscriptionOutput"
                },
                {
                  "Ref": "TranscriptionAudioFiles"
                },
                {
                  "Ref": "SplitTranscriptOutput"
                },
                {
                  "Ref": "TextAnalysisOutput"
                },
                {
                  "Ref": "TextAnalysisAthena"
                },
                {
                  "Ref": "PortalBucket"
                }
              ]
            }
          },
          "CleanUpS3BucketsFunction": {
            "Type": "AWS::Lambda::Function",
            "Properties": {
              "Code": {
                "ZipFile": "import json\nimport logging\nimport threading\nimport boto3\nimport cfnresponse\n\ns3r = boto3.resource('s3')\ns3c = boto3.client('s3')\n\ndef delete_objects(bucket):\n    print(\"Collecting data from\" + bucket)\n    paginator = s3c.get_paginator('list_object_versions')\n    result = paginator.paginate(Bucket=bucket)\n    objects = []\n    for page in result:\n        try:\n            for k in page['Versions']:\n                objects.append({'Key': k['Key'], 'VersionId': k['VersionId']})\n            try:\n                for k in page['DeleteMarkers']:\n                    version = k['VersionId']\n                    key = k['Key']\n                    objects.append({'Key': key, 'VersionId': version})\n            except Exception as e:\n                print(e)\n                pass\n            print(\"deleting objects\")\n            s3c.delete_objects(Bucket=bucket, Delete={'Objects': objects})\n        except Exception as e:\n            print(e)\n            pass\n    print(\"bucket already empty\")\n\n\ndef timeout(event, context):\n    logging.error('Execution is about to time out, sending failure response to CloudFormation')\n    cfnresponse.send(event, context, cfnresponse.FAILED, {}, None)\n\n\ndef handler(event, context):\n    # make sure we send a failure to CloudFormation if the function is going to timeout\n    timer = threading.Timer((context.get_remaining_time_in_millis() / 1000.00) - 0.5, timeout, args=[event, context])\n    timer.start()\n\n    print('Received event: %s' % json.dumps(event))\n    status = cfnresponse.SUCCESS\n    try:\n        buckets = event['ResourceProperties']['Buckets']\n        if event['RequestType'] == 'Delete':\n            for bucket in buckets:\n                delete_objects(bucket)\n        else:\n            print(\"Nothing to do\")\n    except Exception as e:\n        logging.error('Exception: %s' % e, exc_info=True)\n        status = cfnresponse.FAILED\n    finally:\n        timer.cancel()\n        cfnresponse.send(event, context, status, {}, None)\n"
              },
              "Description": "Empty the S3 Bucket",
              "Handler": "index.handler",
              "Role": {
                "Fn::GetAtt": [
                  "S3CleanUpRole",
                  "Arn"
                ]
              },
              "Runtime": "python3.6",
              "Timeout": 240
            }
          },
          "S3CleanUpRole": {
            "Type": "AWS::IAM::Role",
            "Properties": {
              "AssumeRolePolicyDocument": {
                "Statement": [
                  {
                    "Action": "sts:AssumeRole",
                    "Effect": "Allow",
                    "Principal": {
                      "Service": "lambda.amazonaws.com"
                    }
                  }
                ],
                "Version": "2012-10-17"
              },
              "ManagedPolicyArns": [
                "arn:aws:iam::aws:policy/service-role/AWSLambdaBasicExecutionRole"
              ],
              "Path": "/",
              "Policies": [
                {
                  "PolicyDocument": {
                    "Statement": [
                      {
                        "Action": [
                          "s3:PutObject",
                          "s3:DeleteObject",
                          "s3:GetObject",
                          "s3:ListBucket",
                          "s3:ListBucketVersions",
                          "s3:DeleteObjectVersion",
                          "s3:GetObjectVersion",
                          "s3:GetBucketVersioning"
                        ],
                        "Effect": "Allow",
                        "Resource": [
                          {
                            "Fn::GetAtt": [
                              "ComprehendCallResolutionBucket",
                              "Arn"
                            ]
                          },
                          {
                            "Fn::GetAtt": [
                              "ComprehendCallMotivationBucket",
                              "Arn"
                            ]
                          },
                          {
                            "Fn::GetAtt": [
                              "TranscriptionOutput",
                              "Arn"
                            ]
                          },
                          {
                            "Fn::GetAtt": [
                              "TranscriptionAudioFiles",
                              "Arn"
                            ]
                          },
                          {
                            "Fn::GetAtt": [
                              "SplitTranscriptOutput",
                              "Arn"
                            ]
                          },
                          {
                            "Fn::GetAtt": [
                              "TextAnalysisOutput",
                              "Arn"
                            ]
                          },
                          {
                            "Fn::GetAtt": [
                              "TextAnalysisAthena",
                              "Arn"
                            ]
                          },
                          {
                            "Fn::GetAtt": [
                              "PortalBucket",
                              "Arn"
                            ]
                          }
                        ]
                      }
                    ],
                    "Version": "2012-10-17"
                  },
                  "PolicyName": "Empty-bucket"
                }
              ]
            }
          },
          "ComprehendCleanup": {
            "Type": "Custom::ComprehendCleanup",
            "Properties": {
              "ServiceToken": {
                "Fn::GetAtt": [
                  "ComprehendCleanupFunction",
                  "Arn"
                ]
              },
              "MotivationEndpointArn": {
                "Fn::Join": [
                  "",
                  [
                    "arn:aws:comprehend:",
                    {
                      "Ref": "AWS::Region"
                    },
                    ":",
                    {
                      "Ref": "AWS::AccountId"
                    },
                    ":document-classifier-endpoint/",
                    {
                      "Ref": "CallMotivationClassifierName"
                    },
                    "Endpoint"
                  ]
                ]
              },
              "ResolutionEndpointArn": {
                "Fn::Join": [
                  "",
                  [
                    "arn:aws:comprehend:",
                    {
                      "Ref": "AWS::Region"
                    },
                    ":",
                    {
                      "Ref": "AWS::AccountId"
                    },
                    ":document-classifier-endpoint/",
                    {
                      "Ref": "CallResolutionClassifierName"
                    },
                    "Endpoint"
                  ]
                ]
              },
              "MotivationClassifierArn": {
                "Fn::Join": [
                  "",
                  [
                    "arn:aws:comprehend:",
                    {
                      "Ref": "AWS::Region"
                    },
                    ":",
                    {
                      "Ref": "AWS::AccountId"
                    },
                    ":document-classifier/",
                    {
                      "Ref": "CallMotivationClassifierName"
                    }
                  ]
                ]
              },
              "ResolutionClassifierArn": {
                "Fn::Join": [
                  "",
                  [
                    "arn:aws:comprehend:",
                    {
                      "Ref": "AWS::Region"
                    },
                    ":",
                    {
                      "Ref": "AWS::AccountId"
                    },
                    ":document-classifier/",
                    {
                      "Ref": "CallResolutionClassifierName"
                    }
                  ]
                ]
              }
            }
          },
          "ComprehendCleanupFunction": {
            "Type": "AWS::Lambda::Function",
            "Properties": {
              "Description": "Empty the S3 Bucket",
              "Handler": "index.handler",
              "Role": {
                "Fn::GetAtt": [
                  "ComprehendFullAccessRole",
                  "Arn"
                ]
              },
              "Runtime": "python3.6",
              "Timeout": 240,
              "Code": {
                "ZipFile": "import json\nimport logging\nimport threading\nimport boto3\nimport cfnresponse\n\ncomprehend = boto3.client('comprehend')\n\ndef endpoint_exists(arn):\n    try:\n        endpoint = comprehend.describe_endpoint(\n            EndpointArn=arn\n        )\n        return True\n    except Exception as e:\n        return False\n\n\ndef classifier_exists(arn):\n    try:\n        endpoints = comprehend.describe_document_classifier(\n            Filter={\n                'ModelArn': arn\n            }\n        )\n        return True\n    except Exception as e:\n        return False\n\n\ndef timeout(event, context):\n    logging.error('Execution is about to time out, sending failure response to CloudFormation')\n    cfnresponse.send(event, context, cfnresponse.FAILED, {}, None)\n\n\ndef handler(event, context):\n    # make sure we send a failure to CloudFormation if the function is going to timeout\n    timer = threading.Timer((context.get_remaining_time_in_millis() / 1000.00) - 0.5, timeout, args=[event, context])\n    timer.start()\n\n    print('Received event: %s' % json.dumps(event))\n    status = cfnresponse.SUCCESS\n    try:\n        mot_endpoint_arn = event['ResourceProperties']['MotivationEndpointArn']\n        res_endpoint_arn = event['ResourceProperties']['ResolutionEndpointArn']\n        mot_classifier_arn = event['ResourceProperties']['MotivationClassifierArn']\n        res_classifier_arn = event['ResourceProperties']['ResolutionClassifierArn']\n\n        if event['RequestType'] == 'Delete':\n            mot_endpoint_exists = endpoint_exists(mot_endpoint_arn)\n            res_endpoint_exists = endpoint_exists(res_endpoint_arn)\n            mot_classifier_exists = classifier_exists(mot_classifier_arn)\n            res_classifier_exists = classifier_exists(res_classifier_arn)\n            if mot_endpoint_exists is True:\n                print('deleting ' + mot_endpoint_arn)\n                comprehend.delete_endpoint(\n                    EndpointArn=mot_endpoint_arn\n                )\n            if res_endpoint_exists is True:\n                print('deleting ' + res_endpoint_arn)\n                comprehend.delete_endpoint(\n                    EndpointArn=res_endpoint_arn\n                )\n            if mot_classifier_exists is True:\n                print('deleting ' + mot_classifier_arn)\n                comprehend.delete_document_classifier(\n                    DocumentClassifierArn=mot_classifier_arn\n                )\n            if res_classifier_exists is True:\n                print('deleting ' + res_classifier_arn)\n                comprehend.delete_document_classifier(\n                    DocumentClassifierArn=res_classifier_arn\n                )\n        else:\n            print(\"Nothing to do\")\n    except Exception as e:\n        logging.error('Exception: %s' % e, exc_info=True)\n        status = cfnresponse.FAILED\n    finally:\n        timer.cancel()\n        cfnresponse.send(event, context, status, {}, None)\n"
              }
            }
          },
          "GatewayResponseDefault4XX": {
            "Type": "AWS::ApiGateway::GatewayResponse",
            "Properties": {
              "ResponseParameters": {
                "gatewayresponse.header.Access-Control-Allow-Origin": "'*'",
                "gatewayresponse.header.Access-Control-Allow-Headers": "'*'"
              },
              "ResponseType": "DEFAULT_4XX",
              "RestApiId": {
                "Ref": "Api"
              }
            }
          },
          "GatewayResponseDefault5XX": {
            "Type": "AWS::ApiGateway::GatewayResponse",
            "Properties": {
              "ResponseParameters": {
                "gatewayresponse.header.Access-Control-Allow-Origin": "'*'",
                "gatewayresponse.header.Access-Control-Allow-Headers": "'*'"
              },
              "ResponseType": "DEFAULT_5XX",
              "RestApiId": {
                "Ref": "Api"
              }
            }
          },
          "Api": {
            "Type": "AWS::ApiGateway::RestApi",
            "Properties": {
              "Name": {
                "Fn::Join": [
                  "",
                  [
                    "api",
                    "-prod-",
                    {
                      "Ref": "ServicePrefix"
                    }
                  ]
                ]
              },
              "BinaryMediaTypes": [
                "image/png",
                "image/jpg",
                "image/gif",
                "image/x-icon",
                "application/octet-stream"
              ]
            }
          },
          "PortalBucket": {
            "Type": "AWS::S3::Bucket",
            "Properties": {
              "PublicAccessBlockConfiguration": {
                "BlockPublicAcls": true,
                "BlockPublicPolicy": true,
                "IgnorePublicAcls": true,
                "RestrictPublicBuckets": true
              },
              "WebsiteConfiguration": {
                "IndexDocument": {
                  "Ref": "DefaultRoot"
                },
                "ErrorDocument": {
                  "Ref": "ErrorPage"
                }
              }
            }
          },
          "CloudFrontOriginAccessIdentity": {
            "Type": "AWS::CloudFront::CloudFrontOriginAccessIdentity",
            "Properties": {
              "CloudFrontOriginAccessIdentityConfig": {
                "Comment": {
                  "Ref": "PortalBucket"
                }
              }
            }
          },
          "PortalBucketReadPolicy": {
            "Type": "AWS::S3::BucketPolicy",
            "Properties": {
              "Bucket": {
                "Ref": "PortalBucket"
              },
              "PolicyDocument": {
                "Statement": [
                  {
                    "Action": "s3:GetObject",
                    "Effect": "Allow",
                    "Resource": {
                      "Fn::Join": [
                        "",
                        [
                          "arn:aws:s3:::",
                          {
                            "Ref": "PortalBucket"
                          },
                          "/*"
                        ]
                      ]
                    },
                    "Principal": {
                      "CanonicalUser": {
                        "Fn::GetAtt": [
                          "CloudFrontOriginAccessIdentity",
                          "S3CanonicalUserId"
                        ]
                      }
                    }
                  }
                ]
              }
            }
          },
          "CloudFrontDistribution": {
            "Type": "AWS::CloudFront::Distribution",
            "DependsOn": [
              "PortalBucket"
            ],
            "Properties": {
              "DistributionConfig": {
                "DefaultRootObject": {
                  "Fn::Join": [
                    "",
                    [
                      "/",
                      {
                        "Ref": "DefaultRoot"
                      }
                    ]
                  ]
                },
                "Enabled": true,
                "HttpVersion": "http2",
                "Origins": [
                  {
                    "DomainName": {
                      "Fn::GetAtt": [
                        "PortalBucket",
                        "DomainName"
                      ]
                    },
                    "Id": "s3origin",
                    "S3OriginConfig": {
                      "OriginAccessIdentity": {
                        "Fn::Join": [
                          "",
                          [
                            "origin-access-identity/cloudfront/",
                            {
                              "Ref": "CloudFrontOriginAccessIdentity"
                            }
                          ]
                        ]
                      }
                    }
                  },
                  {
                    "DomainName": {
                      "Fn::Join": [
                        "",
                        [
                          {
                            "Ref": "Api"
                          },
                          ".execute-api.",
                          {
                            "Ref": "AWS::Region"
                          },
                          ".amazonaws.com"
                        ]
                      ]
                    },
                    "CustomOriginConfig": {
                      "HTTPSPort": "443",
                      "OriginProtocolPolicy": "https-only"
                    },
                    "OriginPath": "/prod",
                    "Id": "apigatewayorigin"
                  }
                ],
                "PriceClass": "PriceClass_All",
                "CustomErrorResponses": [
                  {
                    "ErrorCode": 403,
                    "ResponseCode": 200,
                    "ResponsePagePath": {
                      "Fn::Join": [
                        "",
                        [
                          "/",
                          {
                            "Ref": "DefaultRoot"
                          }
                        ]
                      ]
                    }
                  },
                  {
                    "ErrorCode": 404,
                    "ResponseCode": 200,
                    "ResponsePagePath": {
                      "Fn::Join": [
                        "",
                        [
                          "/",
                          {
                            "Ref": "DefaultRoot"
                          }
                        ]
                      ]
                    }
                  }
                ],
                "DefaultCacheBehavior": {
                  "AllowedMethods": [
                    "GET",
                    "HEAD",
                    "OPTIONS"
                  ],
                  "CachedMethods": [
                    "GET",
                    "HEAD",
                    "OPTIONS"
                  ],
                  "Compress": true,
                  "DefaultTTL": 3600,
                  "ForwardedValues": {
                    "Cookies": {
                      "Forward": "none"
                    },
                    "QueryString": false
                  },
                  "MaxTTL": 86400,
                  "MinTTL": 60,
                  "TargetOriginId": "s3origin",
                  "ViewerProtocolPolicy": "redirect-to-https"
                },
                "CacheBehaviors": [
                  {
                    "AllowedMethods": [
                      "DELETE",
                      "GET",
                      "HEAD",
                      "OPTIONS",
                      "PATCH",
                      "POST",
                      "PUT"
                    ],
                    "CachedMethods": [
                      "GET",
                      "HEAD",
                      "OPTIONS"
                    ],
                    "Compress": true,
                    "DefaultTTL": 5000,
                    "MaxTTL": 10000,
                    "MinTTL": 60,
                    "ForwardedValues": {
                      "Headers": [
                        "Accept",
                        "Referer",
                        "Authorization",
                        "Content-Type"
                      ],
                      "QueryString": true
                    },
                    "PathPattern": "/api/*",
                    "TargetOriginId": "apigatewayorigin",
                    "ViewerProtocolPolicy": "https-only"
                  }
                ]
              }
            }
          }
        },
        "Outputs": {
          "ServerlessDeploymentBucketName": {
            "Value": {
              "Ref": "ServerlessDeploymentBucket"
            }
          },
          "TranscribeJobProducerLambdaFunctionQualifiedArn": {
            "Description": "Current Lambda function version",
            "Value": {
              "Ref": "TranscribeJobProducerLambdaVersionswBqveyMVNTuOCipMjIjOVpLJHRZNmVAbB7GLvBtE"
            }
          },
          "SplitTranscriptLambdaFunctionQualifiedArn": {
            "Description": "Current Lambda function version",
            "Value": {
              "Ref": "SplitTranscriptLambdaVersionXAGWafJiFscz2UclaxnMieEcLEHxB8UDU6KkyfSRDQ4"
            }
          },
          "AnalyseTextLambdaFunctionQualifiedArn": {
            "Description": "Current Lambda function version",
            "Value": {
              "Ref": "AnalyseTextLambdaVersionwRDBW58HQZshCZPG1s683MBLo9ThRFswwQM0W4btBI"
            }
          },
          "GetTranscriptsLambdaFunctionQualifiedArn": {
            "Description": "Current Lambda function version",
            "Value": {
              "Ref": "GetTranscriptsLambdaVersionWhSzMAiQoRUWVz3XAHOub7MspgvdGzvwuLFT0WZBhA"
            }
          },
          "GetAudioLambdaFunctionQualifiedArn": {
            "Description": "Current Lambda function version",
            "Value": {
              "Ref": "GetAudioLambdaVersionixE09GCBLxIekgVlBCYgueME7Mssr8zmxrXphTQlbs"
            }
          },
          "GetSentimentLambdaFunctionQualifiedArn": {
            "Description": "Current Lambda function version",
            "Value": {
              "Ref": "GetSentimentLambdaVersionlAm4SlFVBkJG282a3t94ZeFqLU546dKnIgd3mcMcwXU"
            }
          },
          "GetPresignedUrlLambdaFunctionQualifiedArn": {
            "Description": "Current Lambda function version",
            "Value": {
              "Ref": "GetPresignedUrlLambdaVersionZCKVKZv7tZgnWkK8DDps3YYVDDPjU8e1W9ZJwVT18"
            }
          },
          "UpdateStatusLambdaFunctionQualifiedArn": {
            "Description": "Current Lambda function version",
            "Value": {
              "Ref": "UpdateStatusLambdaVersionk5XaoCmLOOrxwc8Zi2T3DrOfHwXEjTfKO9UUBGqPBPo"
            }
          },
          "QuickSightFederationFunctionLambdaFunctionQualifiedArn": {
            "Description": "Current Lambda function version",
            "Value": {
              "Ref": "QuickSightFederationFunctionLambdaVersionEnwx6MUxQDyI4sqkH4rPfOPKlWCNLwzE5sqGIEEgUFI"
            }
          },
          "CreateCallResolutionClassiferLambdaFunctionQualifiedArn": {
            "Description": "Current Lambda function version",
            "Value": {
              "Ref": "CreateCallResolutionClassiferLambdaVersioneKkdukzpkw18BTxRyxoc3N34aNS6POOTKUYgTKwF0"
            }
          },
          "CreateCallMotivationClassifierLambdaFunctionQualifiedArn": {
            "Description": "Current Lambda function version",
            "Value": {
              "Ref": "CreateCallMotivationClassifierLambdaVersionmdyUWGZvjevcLutd2StHiZx0ThLi8GMoblf24jLniY"
            }
          },
          "CreateCallResolutionEndpointLambdaFunctionQualifiedArn": {
            "Description": "Current Lambda function version",
            "Value": {
              "Ref": "CreateCallResolutionEndpointLambdaVersionKegdf5ilCKLEqDfPrXVxHBDvLjfkR4UyX4mJKUQoS0"
            }
          },
          "CreateCallMotivationEndpointLambdaFunctionQualifiedArn": {
            "Description": "Current Lambda function version",
            "Value": {
              "Ref": "CreateCallMotivationEndpointLambdaVersionJcgomsusL2muU9iJ7NWAvMCEXg4SThgT5ifamAUY"
            }
          },
          "ServiceEndpoint": {
            "Description": "URL of the service endpoint",
            "Value": {
              "Fn::Join": [
                "",
                [
                  "https://",
                  {
                    "Ref": "Api"
                  },
                  ".execute-api.",
                  {
                    "Ref": "AWS::Region"
                  },
                  ".",
                  {
                    "Ref": "AWS::URLSuffix"
                  },
                  "/prod"
                ]
              ]
            }
          },
          "Stage": {
            "Value": "prod"
          },
          "ApiGatewayDomain": {
            "Value": {
              "Fn::Join": [
                "",
                [
                  {
                    "Ref": "Api"
                  },
                  ".execute-api.",
                  {
                    "Ref": "AWS::Region"
                  },
                  ".amazonaws.com"
                ]
              ]
            }
          },
          "CognitoDomain": {
            "Value": {
              "Fn::Sub": "${CognitoDomain}.auth.${AWS::Region}.amazoncognito.com"
            }
          },
          "UserPoolId": {
            "Value": {
              "Ref": "UserPool"
            }
          },
          "UserPoolClientId": {
            "Value": {
              "Ref": "UserPoolClient"
            }
          },
          "IdentityPoolId": {
            "Value": {
              "Ref": "IdentityPool"
            }
          },
          "TranscriptionAudioFiles": {
            "Value": {
              "Ref": "TranscriptionAudioFiles"
            }
          },
          "ComprehendCallResolutionBucket": {
            "Value": {
              "Ref": "ComprehendCallResolutionBucket"
            }
          },
          "ComprehendCallMotivationBucket": {
            "Value": {
              "Ref": "ComprehendCallMotivationBucket"
            }
          },
          "UserPoolArn": {
            "Value": {
              "Fn::GetAtt": [
                "UserPool",
                "Arn"
              ]
            }
          },
          "QuickSightUserRoleArn": {
            "Value": {
              "Fn::GetAtt": [
                "QuickSightUserRole",
                "Arn"
              ]
            }
          },
          "PortalBucket": {
            "Value": {
              "Ref": "PortalBucket"
            }
          },
          "PortalBucketArn": {
            "Value": {
              "Fn::GetAtt": [
                "PortalBucket",
                "Arn"
              ]
            }
          },
          "CloudFrontDistributionId": {
            "Value": {
              "Ref": "CloudFrontDistribution"
            }
          },
          "CloudFrontDistributionName": {
            "Value": {
              "Fn::GetAtt": [
                "CloudFrontDistribution",
                "DomainName"
              ]
            }
          },
          "UserPoolClient": {
            "Value": {
              "Ref": "UserPoolClient"
            }
          },
          "ServicePrefix": {
            "Value": {
              "Ref": "ServicePrefix"
            }
          }
        },
        "Parameters": {
          "AgentChannel": {
            "Type": "Number",
            "Default": 0,
            "Description": "Left(0), or Right(1). Customer will be set to the other channel."
          },
          "AgentSpeakerLabel": {
            "Type": "Number",
            "Default": 0,
            "Description": "First speaker(0) or last speaker(1). Customer will be set to the other label."
          },
          "ServicePrefix": {
            "Type": "String",
            "Default": "aws-icc",
            "Description": "A prefix to make resource names unique"
          },
          "CustomVocabularyName": {
            "Type": "String",
            "Default": "custom-vocabulary",
            "Description": "The name of the Amazon Transcribe Custom Vocabulary"
          },
          "CallResolutionClassifierName": {
            "Type": "String",
            "Default": "call-resolution",
            "Description": "The name of the Call Resolution Classifier"
          },
          "CallMotivationClassifierName": {
            "Type": "String",
            "Default": "call-motivation",
            "Description": "The name of the Call Motivation Classifier"
          },
          "UserPoolName": {
            "Type": "String",
            "Default": "MyUserPool"
          },
          "UserPoolDomainName": {
            "Type": "String",
            "Default": "icc-prod"
          },
          "IdentityPoolName": {
            "Type": "String",
            "Default": "MyIdentityPool"
          },
          "QuickSightUserRoleName": {
            "Type": "String",
            "Default": "QuickSightUserRole"
          },
          "QuickSightUserName": {
            "Type": "String",
            "Default": "dkubi"
          },
          "UserPolicyName": {
            "Type": "String",
            "Default": "MyUserPolicy"
          },
          "AllowedOrigins": {
            "Type": "List<String>",
            "Default": "*"
          },
          "DefaultRoot": {
            "Description": "The default path for the index document.",
            "Type": "String",
            "Default": "index.html"
          },
          "ErrorPage": {
            "Description": "The path of the error page for the website.",
            "Type": "String",
            "Default": "error.html"
          },
          "NotificationEmail": {
            "Type": "String",
            "Default": "test@example.com"
          },
          "QSS3KeyPrefix": {
            "Type": "String",
            "Default": "quickstart-onica-post-call-analytics/"
          }
        }
      },
      "coreCloudFormationTemplate": {
        "AWSTemplateFormatVersion": "2010-09-09",
        "Description": "The AWS CloudFormation template for this Serverless application",
        "Resources": {
          "ServerlessDeploymentBucket": {
            "Type": "AWS::S3::Bucket",
            "Properties": {
              "BucketEncryption": {
                "ServerSideEncryptionConfiguration": [
                  {
                    "ServerSideEncryptionByDefault": {
                      "SSEAlgorithm": "AES256"
                    }
                  }
                ]
              }
            }
          },
          "ServerlessDeploymentBucketPolicy": {
            "Type": "AWS::S3::BucketPolicy",
            "Properties": {
              "Bucket": {
                "Ref": "ServerlessDeploymentBucket"
              },
              "PolicyDocument": {
                "Statement": [
                  {
                    "Action": "s3:*",
                    "Effect": "Deny",
                    "Principal": "*",
                    "Resource": [
                      {
                        "Fn::Join": [
                          "",
                          [
                            "arn:",
                            {
                              "Ref": "AWS::Partition"
                            },
                            ":s3:::",
                            {
                              "Ref": "ServerlessDeploymentBucket"
                            },
                            "/*"
                          ]
                        ]
                      }
                    ],
                    "Condition": {
                      "Bool": {
                        "aws:SecureTransport": false
                      }
                    }
                  }
                ]
              }
            }
          }
        },
        "Outputs": {
          "ServerlessDeploymentBucketName": {
            "Value": {
              "Ref": "ServerlessDeploymentBucket"
            }
          }
        }
      },
      "vpc": {}
    },
    "custom": {
      "webpack": {
        "webpackConfig": "./webpack.config.js",
        "includeModules": true
      }
    },
    "plugins": [
      "serverless-pseudo-parameters",
      "serverless-webpack",
      "external-resource-files"
    ],
    "pluginsData": {},
    "functions": {
      "transcribeJobProducer": {
        "handler": "transcribe/transcribeHandler.handler",
        "role": "TranscribeS3DynamoDBRole",
        "environment": {
          "TRANSCRIBE_OUTPUT_BUCKET": {
            "$ref": "$[\"service\"][\"provider\"][\"compiledCloudFormationTemplate\"][\"Resources\"][\"TranscribeJobProducerLambdaFunction\"][\"Properties\"][\"Environment\"][\"Variables\"][\"TRANSCRIBE_OUTPUT_BUCKET\"]"
          },
          "CUSTOM_VOCABULARY_NAME": {
            "$ref": "$[\"service\"][\"provider\"][\"compiledCloudFormationTemplate\"][\"Resources\"][\"TranscribeJobProducerLambdaFunction\"][\"Properties\"][\"Environment\"][\"Variables\"][\"CUSTOM_VOCABULARY_NAME\"]"
          },
          "TABLE_NAME": {
            "$ref": "$[\"service\"][\"provider\"][\"compiledCloudFormationTemplate\"][\"Resources\"][\"TranscribeJobProducerLambdaFunction\"][\"Properties\"][\"Environment\"][\"Variables\"][\"TABLE_NAME\"]"
          }
        },
        "events": [
          {
            "s3": {
              "existing": true,
              "bucket": {
                "$ref": "$[\"service\"][\"provider\"][\"compiledCloudFormationTemplate\"][\"Resources\"][\"IamRoleCustomResourcesLambdaExecution\"][\"Properties\"][\"Policies\"][0][\"PolicyDocument\"][\"Statement\"][0][\"Resource\"][\"Fn::Join\"][1][5]"
              },
              "event": "s3:ObjectCreated:*"
            }
          }
        ],
        "name": "aws-icc-prod-transcribeJobProducer",
        "package": {
          "artifact": ".serverless/aws-icc.zip"
        },
        "memory": 1024,
        "timeout": 6,
        "runtime": "nodejs12.x",
        "vpc": {},
        "versionLogicalId": "TranscribeJobProducerLambdaVersionswBqveyMVNTuOCipMjIjOVpLJHRZNmVAbB7GLvBtE"
      },
      "splitTranscript": {
        "handler": "analysis/splitTranscript.handler",
        "role": "TranscriptSplitterRole",
        "environment": {
          "SPLIT_TRANSCRIPT_OUTPUT_BUCKET": {
            "$ref": "$[\"service\"][\"provider\"][\"compiledCloudFormationTemplate\"][\"Resources\"][\"SplitTranscriptLambdaFunction\"][\"Properties\"][\"Environment\"][\"Variables\"][\"SPLIT_TRANSCRIPT_OUTPUT_BUCKET\"]"
          },
          "TABLE_NAME": {
            "$ref": "$[\"service\"][\"provider\"][\"compiledCloudFormationTemplate\"][\"Resources\"][\"SplitTranscriptLambdaFunction\"][\"Properties\"][\"Environment\"][\"Variables\"][\"TABLE_NAME\"]"
          },
          "AGENT_CHANNEL": {
            "$ref": "$[\"service\"][\"provider\"][\"compiledCloudFormationTemplate\"][\"Resources\"][\"SplitTranscriptLambdaFunction\"][\"Properties\"][\"Environment\"][\"Variables\"][\"AGENT_CHANNEL\"]"
          },
          "AGENT_LABEL": {
            "$ref": "$[\"service\"][\"provider\"][\"compiledCloudFormationTemplate\"][\"Resources\"][\"SplitTranscriptLambdaFunction\"][\"Properties\"][\"Environment\"][\"Variables\"][\"AGENT_LABEL\"]"
          }
        },
        "timeout": 120,
        "events": [
          {
            "s3": {
              "existing": true,
              "bucket": {
                "$ref": "$[\"service\"][\"provider\"][\"compiledCloudFormationTemplate\"][\"Resources\"][\"IamRoleCustomResourcesLambdaExecution\"][\"Properties\"][\"Policies\"][0][\"PolicyDocument\"][\"Statement\"][2][\"Resource\"][\"Fn::Join\"][1][5]"
              },
              "event": "s3:ObjectCreated:*"
            }
          }
        ],
        "name": "aws-icc-prod-splitTranscript",
        "package": {
          "artifact": ".serverless/aws-icc.zip"
        },
        "memory": 1024,
        "runtime": "nodejs12.x",
        "vpc": {},
        "versionLogicalId": "SplitTranscriptLambdaVersionXAGWafJiFscz2UclaxnMieEcLEHxB8UDU6KkyfSRDQ4"
      },
      "analyseText": {
        "handler": "analysis/analyseTranscript.handler",
        "role": "ComprehendFullAccessRole",
        "environment": {
          "TEXT_ANALYSIS_OUTPUT_BUCKET": {
            "$ref": "$[\"service\"][\"provider\"][\"compiledCloudFormationTemplate\"][\"Resources\"][\"AnalyseTextLambdaFunction\"][\"Properties\"][\"Environment\"][\"Variables\"][\"TEXT_ANALYSIS_OUTPUT_BUCKET\"]"
          },
          "DATA_ACCESS_ROLE": {
            "$ref": "$[\"service\"][\"provider\"][\"compiledCloudFormationTemplate\"][\"Resources\"][\"AnalyseTextLambdaFunction\"][\"Properties\"][\"Environment\"][\"Variables\"][\"DATA_ACCESS_ROLE\"]"
          },
          "TABLE_NAME": {
            "$ref": "$[\"service\"][\"provider\"][\"compiledCloudFormationTemplate\"][\"Resources\"][\"AnalyseTextLambdaFunction\"][\"Properties\"][\"Environment\"][\"Variables\"][\"TABLE_NAME\"]"
          },
          "CALL_RESOLUTION_ENDPOINT_ARN": {
            "$ref": "$[\"service\"][\"provider\"][\"compiledCloudFormationTemplate\"][\"Resources\"][\"AnalyseTextLambdaFunction\"][\"Properties\"][\"Environment\"][\"Variables\"][\"CALL_RESOLUTION_ENDPOINT_ARN\"]"
          },
          "CALL_MOTIVATION_ENDPOINT_ARN": {
            "$ref": "$[\"service\"][\"provider\"][\"compiledCloudFormationTemplate\"][\"Resources\"][\"AnalyseTextLambdaFunction\"][\"Properties\"][\"Environment\"][\"Variables\"][\"CALL_MOTIVATION_ENDPOINT_ARN\"]"
          },
          "TOPIC_ARN": {
            "$ref": "$[\"service\"][\"provider\"][\"compiledCloudFormationTemplate\"][\"Resources\"][\"AnalyseTextLambdaFunction\"][\"Properties\"][\"Environment\"][\"Variables\"][\"TOPIC_ARN\"]"
          },
          "AGENT_CHANNEL": {
            "$ref": "$[\"service\"][\"provider\"][\"compiledCloudFormationTemplate\"][\"Resources\"][\"AnalyseTextLambdaFunction\"][\"Properties\"][\"Environment\"][\"Variables\"][\"AGENT_CHANNEL\"]"
          },
          "AGENT_LABEL": {
            "$ref": "$[\"service\"][\"provider\"][\"compiledCloudFormationTemplate\"][\"Resources\"][\"AnalyseTextLambdaFunction\"][\"Properties\"][\"Environment\"][\"Variables\"][\"AGENT_LABEL\"]"
          }
        },
        "timeout": 120,
        "events": [
          {
            "s3": {
              "existing": true,
              "bucket": {
                "$ref": "$[\"service\"][\"provider\"][\"compiledCloudFormationTemplate\"][\"Resources\"][\"IamRoleCustomResourcesLambdaExecution\"][\"Properties\"][\"Policies\"][0][\"PolicyDocument\"][\"Statement\"][4][\"Resource\"][\"Fn::Join\"][1][5]"
              },
              "event": "s3:ObjectCreated:*"
            }
          }
        ],
        "name": "aws-icc-prod-analyseText",
        "package": {
          "artifact": ".serverless/aws-icc.zip"
        },
        "memory": 1024,
        "runtime": "nodejs12.x",
        "vpc": {},
        "versionLogicalId": "AnalyseTextLambdaVersionwRDBW58HQZshCZPG1s683MBLo9ThRFswwQM0W4btBI"
      },
      "getTranscripts": {
        "handler": "api/getTranscripts.handler",
        "role": "ScanTranscriptsRole",
        "environment": {
          "TABLE_NAME": {
            "$ref": "$[\"service\"][\"provider\"][\"compiledCloudFormationTemplate\"][\"Resources\"][\"GetTranscriptsLambdaFunction\"][\"Properties\"][\"Environment\"][\"Variables\"][\"TABLE_NAME\"]"
          },
          "AGENT_CHANNEL": {
            "$ref": "$[\"service\"][\"provider\"][\"compiledCloudFormationTemplate\"][\"Resources\"][\"GetTranscriptsLambdaFunction\"][\"Properties\"][\"Environment\"][\"Variables\"][\"AGENT_CHANNEL\"]"
          },
          "AGENT_LABEL": {
            "$ref": "$[\"service\"][\"provider\"][\"compiledCloudFormationTemplate\"][\"Resources\"][\"GetTranscriptsLambdaFunction\"][\"Properties\"][\"Environment\"][\"Variables\"][\"AGENT_LABEL\"]"
          }
        },
        "timeout": 120,
        "events": [
          {
            "http": {
              "method": "get",
              "path": "api/transcripts",
              "cors": {
                "origins": [
                  "*"
                ],
                "origin": "*",
                "methods": [
                  "OPTIONS",
                  "GET"
                ],
                "headers": [
                  "Content-Type",
                  "X-Amz-Date",
                  "Authorization",
                  "X-Api-Key",
                  "X-Amz-Security-Token",
                  "X-Amz-User-Agent"
                ],
                "allowCredentials": false
              },
              "request": {
                "parameters": {
                  "method.request.header.authorization": false
                }
              },
              "authorizer": {
                "type": "COGNITO_USER_POOLS",
                "managedExternally": false,
                "authorizerId": {
                  "Ref": "ApiGatewayAuthorizer"
                },
                "resultTtlInSeconds": 300,
                "identitySource": "method.request.header.Authorization",
                "claims": [],
                "scopes": [
                  "email",
                  "openid"
                ]
              },
              "integration": "AWS_PROXY"
            }
          }
        ],
        "name": "aws-icc-prod-getTranscripts",
        "package": {
          "artifact": ".serverless/aws-icc.zip"
        },
        "memory": 1024,
        "runtime": "nodejs12.x",
        "vpc": {},
        "versionLogicalId": "GetTranscriptsLambdaVersionWhSzMAiQoRUWVz3XAHOub7MspgvdGzvwuLFT0WZBhA"
      },
      "getAudio": {
        "handler": "api/getAudio.handler",
        "role": "TranscriptionAudioFilesRole",
        "environment": {
          "BUCKET_NAME": {
            "$ref": "$[\"service\"][\"provider\"][\"compiledCloudFormationTemplate\"][\"Resources\"][\"GetAudioLambdaFunction\"][\"Properties\"][\"Environment\"][\"Variables\"][\"BUCKET_NAME\"]"
          }
        },
        "events": [
          {
            "http": {
              "method": "get",
              "path": "api/audio",
              "cors": {
                "origins": [
                  "*"
                ],
                "origin": "*",
                "methods": [
                  "OPTIONS",
                  "GET"
                ],
                "headers": [
                  "Content-Type",
                  "X-Amz-Date",
                  "Authorization",
                  "X-Api-Key",
                  "X-Amz-Security-Token",
                  "X-Amz-User-Agent"
                ],
                "allowCredentials": false
              },
              "request": {
                "parameters": {
                  "method.request.header.authorization": false
                }
              },
              "authorizer": {
                "type": "COGNITO_USER_POOLS",
                "managedExternally": false,
                "authorizerId": {
                  "Ref": "ApiGatewayAuthorizer"
                },
                "resultTtlInSeconds": 300,
                "identitySource": "method.request.header.Authorization",
                "claims": [],
                "scopes": [
                  "email",
                  "openid"
                ]
              },
              "integration": "AWS_PROXY"
            }
          }
        ],
        "name": "aws-icc-prod-getAudio",
        "package": {
          "artifact": ".serverless/aws-icc.zip"
        },
        "memory": 1024,
        "timeout": 6,
        "runtime": "nodejs12.x",
        "vpc": {},
        "versionLogicalId": "GetAudioLambdaVersionixE09GCBLxIekgVlBCYgueME7Mssr8zmxrXphTQlbs"
      },
      "getSentiment": {
        "handler": "api/getSentiments.handler",
        "role": "GetSentimentsRole",
        "environment": {
          "BUCKET": {
            "$ref": "$[\"service\"][\"provider\"][\"compiledCloudFormationTemplate\"][\"Resources\"][\"GetSentimentLambdaFunction\"][\"Properties\"][\"Environment\"][\"Variables\"][\"BUCKET\"]"
          }
        },
        "events": [
          {
            "http": {
              "method": "get",
              "path": "api/sentiment",
              "cors": {
                "origins": [
                  "*"
                ],
                "origin": "*",
                "methods": [
                  "OPTIONS",
                  "GET"
                ],
                "headers": [
                  "Content-Type",
                  "X-Amz-Date",
                  "Authorization",
                  "X-Api-Key",
                  "X-Amz-Security-Token",
                  "X-Amz-User-Agent"
                ],
                "allowCredentials": false
              },
              "request": {
                "parameters": {
                  "method.request.header.authorization": false
                }
              },
              "authorizer": {
                "type": "COGNITO_USER_POOLS",
                "managedExternally": false,
                "authorizerId": {
                  "Ref": "ApiGatewayAuthorizer"
                },
                "resultTtlInSeconds": 300,
                "identitySource": "method.request.header.Authorization",
                "claims": [],
                "scopes": [
                  "email",
                  "openid"
                ]
              },
              "integration": "AWS_PROXY"
            }
          }
        ],
        "name": "aws-icc-prod-getSentiment",
        "package": {
          "artifact": ".serverless/aws-icc.zip"
        },
        "memory": 1024,
        "timeout": 6,
        "runtime": "nodejs12.x",
        "vpc": {},
        "versionLogicalId": "GetSentimentLambdaVersionlAm4SlFVBkJG282a3t94ZeFqLU546dKnIgd3mcMcwXU"
      },
      "getPresignedUrl": {
        "handler": "api/getPresignedUrl.handler",
        "role": "TranscriptionAudioFilesRole",
        "environment": {
          "BUCKET_NAME": {
            "$ref": "$[\"service\"][\"provider\"][\"compiledCloudFormationTemplate\"][\"Resources\"][\"GetPresignedUrlLambdaFunction\"][\"Properties\"][\"Environment\"][\"Variables\"][\"BUCKET_NAME\"]"
          },
          "TOKEN_ENDPOINT": {
            "$ref": "$[\"service\"][\"provider\"][\"compiledCloudFormationTemplate\"][\"Resources\"][\"GetPresignedUrlLambdaFunction\"][\"Properties\"][\"Environment\"][\"Variables\"][\"TOKEN_ENDPOINT\"]"
          }
        },
        "events": [
          {
            "http": {
              "path": "api/presigned",
              "method": "post",
              "cors": {
                "origins": [
                  "*"
                ],
                "origin": "*",
                "methods": [
                  "OPTIONS",
                  "POST"
                ],
                "headers": [
                  "Content-Type",
                  "X-Amz-Date",
                  "Authorization",
                  "X-Api-Key",
                  "X-Amz-Security-Token",
                  "X-Amz-User-Agent"
                ],
                "allowCredentials": false
              },
              "request": {
                "parameters": {
                  "method.request.header.authorization": false
                }
              },
              "authorizer": {
                "type": "COGNITO_USER_POOLS",
                "managedExternally": false,
                "authorizerId": {
                  "Ref": "ApiGatewayAuthorizer"
                },
                "resultTtlInSeconds": 300,
                "identitySource": "method.request.header.Authorization",
                "claims": [],
                "scopes": [
                  "email",
                  "openid"
                ]
              },
              "integration": "AWS_PROXY"
            }
          }
        ],
        "name": "aws-icc-prod-getPresignedUrl",
        "package": {
          "artifact": ".serverless/aws-icc.zip"
        },
        "memory": 1024,
        "timeout": 6,
        "runtime": "nodejs12.x",
        "vpc": {},
        "versionLogicalId": "GetPresignedUrlLambdaVersionZCKVKZv7tZgnWkK8DDps3YYVDDPjU8e1W9ZJwVT18"
      },
      "updateStatus": {
        "handler": "api/updateStatus.handler",
        "role": "DynamoBatchWriteRole",
        "environment": {
          "TABLE_NAME": {
            "$ref": "$[\"service\"][\"provider\"][\"compiledCloudFormationTemplate\"][\"Resources\"][\"UpdateStatusLambdaFunction\"][\"Properties\"][\"Environment\"][\"Variables\"][\"TABLE_NAME\"]"
          },
          "TOKEN_ENDPOINT": {
            "$ref": "$[\"service\"][\"provider\"][\"compiledCloudFormationTemplate\"][\"Resources\"][\"UpdateStatusLambdaFunction\"][\"Properties\"][\"Environment\"][\"Variables\"][\"TOKEN_ENDPOINT\"]"
          }
        },
        "events": [
          {
            "http": {
              "path": "api/status",
              "method": "post",
              "cors": {
                "origins": [
                  "*"
                ],
                "origin": "*",
                "methods": [
                  "OPTIONS",
                  "POST"
                ],
                "headers": [
                  "Content-Type",
                  "X-Amz-Date",
                  "Authorization",
                  "X-Api-Key",
                  "X-Amz-Security-Token",
                  "X-Amz-User-Agent"
                ],
                "allowCredentials": false
              },
              "request": {
                "parameters": {
                  "method.request.header.authorization": false
                }
              },
              "authorizer": {
                "type": "COGNITO_USER_POOLS",
                "managedExternally": false,
                "authorizerId": {
                  "Ref": "ApiGatewayAuthorizer"
                },
                "resultTtlInSeconds": 300,
                "identitySource": "method.request.header.Authorization",
                "claims": [],
                "scopes": [
                  "email",
                  "openid"
                ]
              },
              "integration": "AWS_PROXY"
            }
          }
        ],
        "name": "aws-icc-prod-updateStatus",
        "package": {
          "artifact": ".serverless/aws-icc.zip"
        },
        "memory": 1024,
        "timeout": 6,
        "runtime": "nodejs12.x",
        "vpc": {},
        "versionLogicalId": "UpdateStatusLambdaVersionk5XaoCmLOOrxwc8Zi2T3DrOfHwXEjTfKO9UUBGqPBPo"
      },
      "quickSightFederationFunction": {
        "handler": "api/quicksightAuth.handler",
        "role": "LambdaBasicExecutionRole",
        "events": [
          {
            "http": {
              "method": "post",
              "path": "auth",
              "cors": {
                "origins": [
                  "*"
                ],
                "origin": "*",
                "methods": [
                  "OPTIONS",
                  "POST"
                ],
                "headers": [
                  "Content-Type",
                  "X-Amz-Date",
                  "Authorization",
                  "X-Api-Key",
                  "X-Amz-Security-Token",
                  "X-Amz-User-Agent"
                ],
                "allowCredentials": false
              },
              "request": {
                "parameters": {
                  "method.request.header.authorization": false
                }
              },
              "authorizer": {
                "type": "COGNITO_USER_POOLS",
                "managedExternally": false,
                "authorizerId": {
                  "Ref": "ApiGatewayAuthorizer"
                },
                "resultTtlInSeconds": 300,
                "identitySource": "method.request.header.Authorization",
                "claims": [],
                "scopes": [
                  "email",
                  "openid"
                ]
              },
              "integration": "AWS_PROXY"
            }
          }
        ],
        "name": "aws-icc-prod-quickSightFederationFunction",
        "package": {
          "artifact": ".serverless/aws-icc.zip"
        },
        "memory": 1024,
        "timeout": 6,
        "runtime": "nodejs12.x",
        "vpc": {},
        "versionLogicalId": "QuickSightFederationFunctionLambdaVersionEnwx6MUxQDyI4sqkH4rPfOPKlWCNLwzE5sqGIEEgUFI"
      },
      "createCallResolutionClassifer": {
        "handler": "classifiers/callResolutionClassifier.handler",
        "role": "ComprehendFullAccessRole",
        "environment": {
          "DATA_ACCESS_ROLE": {
            "$ref": "$[\"service\"][\"provider\"][\"compiledCloudFormationTemplate\"][\"Resources\"][\"CreateCallResolutionClassiferLambdaFunction\"][\"Properties\"][\"Environment\"][\"Variables\"][\"DATA_ACCESS_ROLE\"]"
          },
          "CLASSIFIER_NAME": {
            "$ref": "$[\"service\"][\"provider\"][\"compiledCloudFormationTemplate\"][\"Resources\"][\"CreateCallResolutionClassiferLambdaFunction\"][\"Properties\"][\"Environment\"][\"Variables\"][\"CLASSIFIER_NAME\"]"
          },
          "CALL_RESOLUTION_BUCKET": {
            "$ref": "$[\"service\"][\"provider\"][\"compiledCloudFormationTemplate\"][\"Resources\"][\"CreateCallResolutionClassiferLambdaFunction\"][\"Properties\"][\"Environment\"][\"Variables\"][\"CALL_RESOLUTION_BUCKET\"]"
          }
        },
        "timeout": 900,
        "events": [
          {
            "s3": {
              "existing": true,
              "bucket": {
                "$ref": "$[\"service\"][\"provider\"][\"compiledCloudFormationTemplate\"][\"Resources\"][\"IamRoleCustomResourcesLambdaExecution\"][\"Properties\"][\"Policies\"][0][\"PolicyDocument\"][\"Statement\"][6][\"Resource\"][\"Fn::Join\"][1][5]"
              },
              "event": "s3:ObjectCreated:*"
            }
          }
        ],
        "name": "aws-icc-prod-createCallResolutionClassifer",
        "package": {
          "artifact": ".serverless/aws-icc.zip"
        },
        "memory": 1024,
        "runtime": "nodejs12.x",
        "vpc": {},
        "versionLogicalId": "CreateCallResolutionClassiferLambdaVersioneKkdukzpkw18BTxRyxoc3N34aNS6POOTKUYgTKwF0"
      },
      "createCallMotivationClassifier": {
        "handler": "classifiers/createMotivationClassifier.handler",
        "role": "ComprehendFullAccessRole",
        "environment": {
          "DATA_ACCESS_ROLE": {
            "$ref": "$[\"service\"][\"provider\"][\"compiledCloudFormationTemplate\"][\"Resources\"][\"CreateCallMotivationClassifierLambdaFunction\"][\"Properties\"][\"Environment\"][\"Variables\"][\"DATA_ACCESS_ROLE\"]"
          },
          "CLASSIFIER_NAME": {
            "$ref": "$[\"service\"][\"provider\"][\"compiledCloudFormationTemplate\"][\"Resources\"][\"CreateCallMotivationClassifierLambdaFunction\"][\"Properties\"][\"Environment\"][\"Variables\"][\"CLASSIFIER_NAME\"]"
          },
          "CALL_MOTIVATION_INPUT": {
            "$ref": "$[\"service\"][\"provider\"][\"compiledCloudFormationTemplate\"][\"Resources\"][\"CreateCallMotivationClassifierLambdaFunction\"][\"Properties\"][\"Environment\"][\"Variables\"][\"CALL_MOTIVATION_INPUT\"]"
          }
        },
        "timeout": 900,
        "events": [
          {
            "s3": {
              "existing": true,
              "bucket": {
                "$ref": "$[\"service\"][\"provider\"][\"compiledCloudFormationTemplate\"][\"Resources\"][\"IamRoleCustomResourcesLambdaExecution\"][\"Properties\"][\"Policies\"][0][\"PolicyDocument\"][\"Statement\"][8][\"Resource\"][\"Fn::Join\"][1][5]"
              },
              "event": "s3:ObjectCreated:*"
            }
          }
        ],
        "name": "aws-icc-prod-createCallMotivationClassifier",
        "package": {
          "artifact": ".serverless/aws-icc.zip"
        },
        "memory": 1024,
        "runtime": "nodejs12.x",
        "vpc": {},
        "versionLogicalId": "CreateCallMotivationClassifierLambdaVersionmdyUWGZvjevcLutd2StHiZx0ThLi8GMoblf24jLniY"
      },
      "createCallResolutionEndpoint": {
        "handler": "endpoints/callResolutionEnpoint.handler",
        "role": "ComprehendFullAccessRole",
        "environment": {
          "DATA_ACCESS_ROLE": {
            "$ref": "$[\"service\"][\"provider\"][\"compiledCloudFormationTemplate\"][\"Resources\"][\"CreateCallResolutionEndpointLambdaFunction\"][\"Properties\"][\"Environment\"][\"Variables\"][\"DATA_ACCESS_ROLE\"]"
          },
          "CLASSIFIER_NAME": {
            "$ref": "$[\"service\"][\"provider\"][\"compiledCloudFormationTemplate\"][\"Resources\"][\"CreateCallResolutionEndpointLambdaFunction\"][\"Properties\"][\"Environment\"][\"Variables\"][\"CLASSIFIER_NAME\"]"
          },
          "CALL_RESOLUTION_ARN": {
            "$ref": "$[\"service\"][\"provider\"][\"compiledCloudFormationTemplate\"][\"Resources\"][\"CreateCallResolutionEndpointLambdaFunction\"][\"Properties\"][\"Environment\"][\"Variables\"][\"CALL_RESOLUTION_ARN\"]"
          }
        },
        "timeout": 120,
        "events": [
          {
            "schedule": "rate(3 minutes)"
          }
        ],
        "name": "aws-icc-prod-createCallResolutionEndpoint",
        "package": {
          "artifact": ".serverless/aws-icc.zip"
        },
        "memory": 1024,
        "runtime": "nodejs12.x",
        "vpc": {},
        "versionLogicalId": "CreateCallResolutionEndpointLambdaVersionKegdf5ilCKLEqDfPrXVxHBDvLjfkR4UyX4mJKUQoS0"
      },
      "createCallMotivationEndpoint": {
        "handler": "endpoints/createMotivationEndpoint.handler",
        "role": "ComprehendFullAccessRole",
        "environment": {
          "DATA_ACCESS_ROLE": {
            "$ref": "$[\"service\"][\"provider\"][\"compiledCloudFormationTemplate\"][\"Resources\"][\"CreateCallMotivationEndpointLambdaFunction\"][\"Properties\"][\"Environment\"][\"Variables\"][\"DATA_ACCESS_ROLE\"]"
          },
          "CLASSIFIER_NAME": {
            "$ref": "$[\"service\"][\"provider\"][\"compiledCloudFormationTemplate\"][\"Resources\"][\"CreateCallMotivationEndpointLambdaFunction\"][\"Properties\"][\"Environment\"][\"Variables\"][\"CLASSIFIER_NAME\"]"
          },
          "CALL_MOTIVATION_ARN": {
            "$ref": "$[\"service\"][\"provider\"][\"compiledCloudFormationTemplate\"][\"Resources\"][\"CreateCallMotivationEndpointLambdaFunction\"][\"Properties\"][\"Environment\"][\"Variables\"][\"CALL_MOTIVATION_ARN\"]"
          }
        },
        "timeout": 120,
        "events": [
          {
            "schedule": "rate(3 minutes)"
          }
        ],
        "name": "aws-icc-prod-createCallMotivationEndpoint",
        "package": {
          "artifact": ".serverless/aws-icc.zip"
        },
        "memory": 1024,
        "runtime": "nodejs12.x",
        "vpc": {},
        "versionLogicalId": "CreateCallMotivationEndpointLambdaVersionJcgomsusL2muU9iJ7NWAvMCEXg4SThgT5ifamAUY"
      }
    },
    "resources": {
      "Parameters": {
        "AgentChannel": {
          "Type": "Number",
          "Default": 0,
          "Description": "Left(0), or Right(1). Customer will be set to the other channel."
        },
        "AgentSpeakerLabel": {
          "Type": "Number",
          "Default": 0,
          "Description": "First speaker(0) or last speaker(1). Customer will be set to the other label."
        },
        "ServicePrefix": {
          "Type": "String",
          "Default": "aws-icc",
          "Description": "A prefix to make resource names unique"
        },
        "CustomVocabularyName": {
          "Type": "String",
          "Default": "custom-vocabulary",
          "Description": "The name of the Amazon Transcribe Custom Vocabulary"
        },
        "CallResolutionClassifierName": {
          "Type": "String",
          "Default": "call-resolution",
          "Description": "The name of the Call Resolution Classifier"
        },
        "CallMotivationClassifierName": {
          "Type": "String",
          "Default": "call-motivation",
          "Description": "The name of the Call Motivation Classifier"
        },
        "UserPoolName": {
          "Type": "String",
          "Default": "MyUserPool"
        },
        "UserPoolDomainName": {
          "Type": "String",
          "Default": "icc-prod"
        },
        "IdentityPoolName": {
          "Type": "String",
          "Default": "MyIdentityPool"
        },
        "QuickSightUserRoleName": {
          "Type": "String",
          "Default": "QuickSightUserRole"
        },
        "QuickSightUserName": {
          "Type": "String",
          "Default": "dkubi"
        },
        "UserPolicyName": {
          "Type": "String",
          "Default": "MyUserPolicy"
        },
        "AllowedOrigins": {
          "Type": "List<String>",
          "Default": "*"
        },
        "DefaultRoot": {
          "Description": "The default path for the index document.",
          "Type": "String",
          "Default": "index.html"
        },
        "ErrorPage": {
          "Description": "The path of the error page for the website.",
          "Type": "String",
          "Default": "error.html"
        },
        "NotificationEmail": {
          "Type": "String",
          "Default": "test@example.com"
        },
        "QSS3KeyPrefix": {
          "Type": "String",
          "Default": "quickstart-onica-post-call-analytics/"
        }
      },
      "Outputs": {
        "Stage": {
          "Value": "prod"
        },
        "ApiGatewayDomain": {
          "Value": {
            "Fn::Join": [
              "",
              [
                {
                  "Ref": "Api"
                },
                ".execute-api.",
                {
                  "Ref": "AWS::Region"
                },
                ".amazonaws.com"
              ]
            ]
          }
        },
        "CognitoDomain": {
          "Value": {
            "Fn::Sub": "#{CognitoDomain}.auth.#{AWS::Region}.amazoncognito.com"
          }
        },
        "UserPoolId": {
          "Value": {
            "Ref": "UserPool"
          }
        },
        "UserPoolClientId": {
          "Value": {
            "Ref": "UserPoolClient"
          }
        },
        "IdentityPoolId": {
          "Value": {
            "Ref": "IdentityPool"
          }
        },
        "TranscriptionAudioFiles": {
          "Value": {
            "Ref": "TranscriptionAudioFiles"
          }
        },
        "ComprehendCallResolutionBucket": {
          "Value": {
            "Ref": "ComprehendCallResolutionBucket"
          }
        },
        "ComprehendCallMotivationBucket": {
          "Value": {
            "Ref": "ComprehendCallMotivationBucket"
          }
        },
        "UserPoolArn": {
          "Value": {
            "Fn::GetAtt": [
              "UserPool",
              "Arn"
            ]
          }
        },
        "QuickSightUserRoleArn": {
          "Value": {
            "Fn::GetAtt": [
              "QuickSightUserRole",
              "Arn"
            ]
          }
        },
        "PortalBucket": {
          "Value": {
            "Ref": "PortalBucket"
          }
        },
        "PortalBucketArn": {
          "Value": {
            "Fn::GetAtt": [
              "PortalBucket",
              "Arn"
            ]
          }
        },
        "CloudFrontDistributionId": {
          "Value": {
            "Ref": "CloudFrontDistribution"
          }
        },
        "CloudFrontDistributionName": {
          "Value": {
            "Fn::GetAtt": [
              "CloudFrontDistribution",
              "DomainName"
            ]
          }
        },
        "UserPoolClient": {
          "Value": {
            "Ref": "UserPoolClient"
          }
        },
        "ServicePrefix": {
          "Value": {
            "Ref": "ServicePrefix"
          }
        }
      },
      "Resources": {
        "LambdaBasicExecutionRole": {
          "Type": "AWS::IAM::Role",
          "Properties": {
            "RoleName": {
              "Fn::Join": [
                "",
                [
                  "basic-execution",
                  "-prod-",
                  {
                    "Ref": "ServicePrefix"
                  }
                ]
              ]
            },
            "AssumeRolePolicyDocument": {
              "Version": "2012-10-17",
              "Statement": [
                {
                  "Effect": "Allow",
                  "Principal": {
                    "Service": [
                      "lambda.amazonaws.com"
                    ]
                  },
                  "Action": "sts:AssumeRole"
                }
              ]
            },
            "ManagedPolicyArns": [
              "arn:aws:iam::aws:policy/service-role/AWSLambdaBasicExecutionRole"
            ]
          }
        },
        "TranscribeS3DynamoDBRole": {
          "Type": "AWS::IAM::Role",
          "Properties": {
            "RoleName": {
              "Fn::Join": [
                "",
                [
                  "transcribe-s3-dynamo-full-access",
                  "-prod-",
                  {
                    "Ref": "ServicePrefix"
                  }
                ]
              ]
            },
            "AssumeRolePolicyDocument": {
              "Version": "2012-10-17",
              "Statement": [
                {
                  "Effect": "Allow",
                  "Principal": {
                    "Service": [
                      "lambda.amazonaws.com"
                    ]
                  },
                  "Action": "sts:AssumeRole"
                }
              ]
            },
            "ManagedPolicyArns": [
              "arn:aws:iam::aws:policy/service-role/AWSLambdaBasicExecutionRole",
              "arn:aws:iam::aws:policy/AmazonTranscribeFullAccess",
              {
                "Ref": "TranscriptionAudioFilesPolicy"
              }
            ],
            "Policies": [
              {
                "PolicyName": "UpdateDynamoDBAndTranscribeOutputPolicy",
                "PolicyDocument": {
                  "Version": "2012-10-17",
                  "Statement": [
                    {
                      "Effect": "Allow",
                      "Action": [
                        "dynamodb:Update*"
                      ],
                      "Resource": [
                        {
                          "Fn::GetAtt": [
                            "StatusTable",
                            "Arn"
                          ]
                        }
                      ]
                    },
                    {
                      "Effect": "Allow",
                      "Action": [
                        "s3:Put*",
                        "s3:ListBucket",
                        "s3:Get*"
                      ],
                      "Resource": [
                        {
                          "Fn::Join": [
                            "",
                            [
                              "arn:aws:s3:::",
                              "transcription-output-prod-",
                              {
                                "Ref": "ServicePrefix"
                              }
                            ]
                          ]
                        },
                        {
                          "Fn::Join": [
                            "",
                            [
                              "arn:aws:s3:::",
                              "transcription-output-prod-",
                              {
                                "Ref": "ServicePrefix"
                              },
                              "/*"
                            ]
                          ]
                        }
                      ]
                    }
                  ]
                }
              }
            ]
          }
        },
        "DynamoBatchWriteRole": {
          "Type": "AWS::IAM::Role",
          "Properties": {
            "RoleName": {
              "Fn::Join": [
                "",
                [
                  "dynamodb-batch-write-role",
                  "-prod-",
                  {
                    "Ref": "ServicePrefix"
                  }
                ]
              ]
            },
            "AssumeRolePolicyDocument": {
              "Version": "2012-10-17",
              "Statement": [
                {
                  "Effect": "Allow",
                  "Principal": {
                    "Service": [
                      "lambda.amazonaws.com"
                    ]
                  },
                  "Action": "sts:AssumeRole"
                }
              ]
            },
            "ManagedPolicyArns": [
              "arn:aws:iam::aws:policy/service-role/AWSLambdaBasicExecutionRole"
            ],
            "Policies": [
              {
                "PolicyName": "ScanDynamoDBPolicy",
                "PolicyDocument": {
                  "Version": "2012-10-17",
                  "Statement": [
                    {
                      "Effect": "Allow",
                      "Action": [
                        "dynamodb:batchWrite"
                      ],
                      "Resource": [
                        {
                          "Fn::GetAtt": [
                            "StatusTable",
                            "Arn"
                          ]
                        }
                      ]
                    },
                    {
                      "Effect": "Allow",
                      "Action": [
                        "dynamodb:BatchWriteItem"
                      ],
                      "Resource": [
                        {
                          "Fn::GetAtt": [
                            "StatusTable",
                            "Arn"
                          ]
                        }
                      ]
                    }
                  ]
                }
              }
            ]
          }
        },
        "S3ReadOnlyAccessRole": {
          "Type": "AWS::IAM::Role",
          "Properties": {
            "RoleName": {
              "Fn::Join": [
                "",
                [
                  "s3-readonly-access",
                  "-prod-",
                  {
                    "Ref": "ServicePrefix"
                  }
                ]
              ]
            },
            "AssumeRolePolicyDocument": {
              "Version": "2012-10-17",
              "Statement": [
                {
                  "Effect": "Allow",
                  "Principal": {
                    "Service": [
                      "apigateway.amazonaws.com"
                    ]
                  },
                  "Action": "sts:AssumeRole"
                }
              ]
            },
            "ManagedPolicyArns": [
              "arn:aws:iam::aws:policy/AmazonS3ReadOnlyAccess"
            ]
          }
        },
        "TranscriptionAudioFilesRole": {
          "Type": "AWS::IAM::Role",
          "Properties": {
            "RoleName": {
              "Fn::Join": [
                "",
                [
                  "transcription-audio-files",
                  "-prod-",
                  {
                    "Ref": "ServicePrefix"
                  }
                ]
              ]
            },
            "AssumeRolePolicyDocument": {
              "Version": "2012-10-17",
              "Statement": [
                {
                  "Effect": "Allow",
                  "Principal": {
                    "Service": [
                      "lambda.amazonaws.com"
                    ]
                  },
                  "Action": "sts:AssumeRole"
                }
              ]
            },
            "ManagedPolicyArns": [
              "arn:aws:iam::aws:policy/service-role/AWSLambdaBasicExecutionRole",
              {
                "Ref": "TranscriptionAudioFilesPolicy"
              }
            ]
          }
        },
        "ScanTranscriptsRole": {
          "Type": "AWS::IAM::Role",
          "Properties": {
            "RoleName": {
              "Fn::Join": [
                "",
                [
                  "scan-transcripts",
                  "-prod-",
                  {
                    "Ref": "ServicePrefix"
                  }
                ]
              ]
            },
            "AssumeRolePolicyDocument": {
              "Version": "2012-10-17",
              "Statement": [
                {
                  "Effect": "Allow",
                  "Principal": {
                    "Service": [
                      "lambda.amazonaws.com"
                    ]
                  },
                  "Action": "sts:AssumeRole"
                }
              ]
            },
            "ManagedPolicyArns": [
              "arn:aws:iam::aws:policy/service-role/AWSLambdaBasicExecutionRole"
            ],
            "Policies": [
              {
                "PolicyName": "ScanDynamoDBPolicy",
                "PolicyDocument": {
                  "Version": "2012-10-17",
                  "Statement": [
                    {
                      "Effect": "Allow",
                      "Action": [
                        "dynamodb:Scan"
                      ],
                      "Resource": [
                        {
                          "Fn::GetAtt": [
                            "StatusTable",
                            "Arn"
                          ]
                        }
                      ]
                    }
                  ]
                }
              }
            ]
          }
        },
        "TranscriptSplitterRole": {
          "Type": "AWS::IAM::Role",
          "Properties": {
            "RoleName": {
              "Fn::Join": [
                "",
                [
                  "split-transcript-role",
                  "-prod-",
                  {
                    "Ref": "ServicePrefix"
                  }
                ]
              ]
            },
            "AssumeRolePolicyDocument": {
              "Version": "2012-10-17",
              "Statement": [
                {
                  "Effect": "Allow",
                  "Principal": {
                    "Service": [
                      "lambda.amazonaws.com"
                    ]
                  },
                  "Action": "sts:AssumeRole"
                }
              ]
            },
            "ManagedPolicyArns": [
              "arn:aws:iam::aws:policy/AWSLambdaExecute",
              "arn:aws:iam::aws:policy/AmazonDynamoDBFullAccess"
            ]
          }
        },
        "GetSentimentsRole": {
          "Type": "AWS::IAM::Role",
          "Properties": {
            "RoleName": {
              "Fn::Join": [
                "",
                [
                  "get-sentiments-role",
                  "-prod-",
                  {
                    "Ref": "ServicePrefix"
                  }
                ]
              ]
            },
            "AssumeRolePolicyDocument": {
              "Version": "2012-10-17",
              "Statement": [
                {
                  "Effect": "Allow",
                  "Principal": {
                    "Service": [
                      "lambda.amazonaws.com"
                    ]
                  },
                  "Action": "sts:AssumeRole"
                }
              ]
            },
            "ManagedPolicyArns": [
              "arn:aws:iam::aws:policy/AWSLambdaExecute",
              {
                "Ref": "TextAnalysisPolicy"
              }
            ]
          }
        },
        "TextAnalysisRole": {
          "Type": "AWS::IAM::Role",
          "Properties": {
            "RoleName": {
              "Fn::Join": [
                "",
                [
                  "text-analysis-role",
                  "-prod-",
                  {
                    "Ref": "ServicePrefix"
                  }
                ]
              ]
            },
            "AssumeRolePolicyDocument": {
              "Version": "2012-10-17",
              "Statement": [
                {
                  "Effect": "Allow",
                  "Principal": {
                    "Service": [
                      "comprehend.amazonaws.com"
                    ]
                  },
                  "Action": [
                    "sts:AssumeRole"
                  ]
                }
              ]
            },
            "ManagedPolicyArns": [
              {
                "Ref": "TextAnalysisPolicy"
              }
            ]
          }
        },
        "TextAnalysisResultCrawlerRole": {
          "Type": "AWS::IAM::Role",
          "Properties": {
            "AssumeRolePolicyDocument": {
              "Version": "2012-10-17",
              "Statement": [
                {
                  "Effect": "Allow",
                  "Principal": {
                    "Service": [
                      "glue.amazonaws.com"
                    ]
                  },
                  "Action": [
                    "sts:AssumeRole"
                  ]
                }
              ]
            },
            "Path": "/",
            "Policies": [
              {
                "PolicyName": "TextAnalysisResultCrawlerRolePolicy",
                "PolicyDocument": {
                  "Version": "2012-10-17",
                  "Statement": [
                    {
                      "Effect": "Allow",
                      "Action": "*",
                      "Resource": "*"
                    }
                  ]
                }
              }
            ]
          }
        },
        "ComprehendFullAccessRole": {
          "Type": "AWS::IAM::Role",
          "Properties": {
            "RoleName": {
              "Fn::Join": [
                "",
                [
                  "comprehend-full-access-role",
                  "-prod-",
                  {
                    "Ref": "ServicePrefix"
                  }
                ]
              ]
            },
            "AssumeRolePolicyDocument": {
              "Version": "2012-10-17",
              "Statement": [
                {
                  "Effect": "Allow",
                  "Principal": {
                    "Service": [
                      "lambda.amazonaws.com"
                    ]
                  },
                  "Action": "sts:AssumeRole"
                }
              ]
            },
            "ManagedPolicyArns": [
              "arn:aws:iam::aws:policy/service-role/AWSLambdaBasicExecutionRole",
              {
                "Ref": "ComprehendFullAccessPolicy"
              },
              {
                "Ref": "SnsNotificationPolicy"
              }
            ]
          }
        },
        "ComprehendDataAccessRole": {
          "Type": "AWS::IAM::Role",
          "Properties": {
            "RoleName": {
              "Fn::Join": [
                "",
                [
                  "comprehend-data-access",
                  "-prod-",
                  {
                    "Ref": "ServicePrefix"
                  }
                ]
              ]
            },
            "AssumeRolePolicyDocument": {
              "Version": "2012-10-17",
              "Statement": [
                {
                  "Effect": "Allow",
                  "Principal": {
                    "Service": [
                      "comprehend.amazonaws.com"
                    ]
                  },
                  "Action": "sts:AssumeRole"
                }
              ]
            },
            "ManagedPolicyArns": [
              "arn:aws:iam::aws:policy/service-role/ComprehendDataAccessRolePolicy"
            ]
          }
        },
        "ApiGatewayAuthorizer": {
          "Type": "AWS::ApiGateway::Authorizer",
          "DependsOn": [
            "Api"
          ],
          "Properties": {
            "AuthorizerResultTtlInSeconds": 300,
            "IdentitySource": "method.request.header.Authorization",
            "Name": {
              "Fn::Join": [
                "",
                [
                  "cognito-authorizer",
                  "-prod-",
                  {
                    "Ref": "ServicePrefix"
                  }
                ]
              ]
            },
            "RestApiId": {
              "Ref": "Api"
            },
            "Type": "COGNITO_USER_POOLS",
            "ProviderARNs": [
              {
                "Fn::GetAtt": [
                  "UserPool",
                  "Arn"
                ]
              }
            ]
          }
        },
        "CognitoAuthUI": {
          "Type": "AWS::Cognito::UserPoolUICustomizationAttachment",
          "Properties": {
            "ClientId": {
              "Ref": "UserPoolClient"
            },
            "UserPoolId": {
              "Ref": "UserPool"
            }
          }
        },
        "CognitoDomain": {
          "Type": "AWS::Cognito::UserPoolDomain",
          "Properties": {
            "Domain": {
              "Ref": "UserPoolDomainName"
            },
            "UserPoolId": {
              "Ref": "UserPool"
            }
          }
        },
        "UserPool": {
          "Type": "AWS::Cognito::UserPool",
          "Properties": {
            "UserPoolName": {
              "Fn::Join": [
                "",
                [
                  {
                    "Ref": "UserPoolName"
                  },
                  "-prod-",
                  {
                    "Ref": "ServicePrefix"
                  }
                ]
              ]
            },
            "UsernameAttributes": [
              "email"
            ],
            "AutoVerifiedAttributes": [
              "email"
            ],
            "Schema": [
              {
                "Name": "userId",
                "AttributeDataType": "String",
                "Mutable": true
              }
            ]
          }
        },
        "UserPoolClient": {
          "Type": "AWS::Cognito::UserPoolClient",
          "Properties": {
            "UserPoolId": {
              "Ref": "UserPool"
            },
            "GenerateSecret": false,
            "RefreshTokenValidity": 30,
            "ReadAttributes": [
              "family_name",
              "given_name",
              "email"
            ],
            "WriteAttributes": [
              "family_name",
              "given_name",
              "email"
            ],
            "AllowedOAuthFlows": [
              "code"
            ],
            "SupportedIdentityProviders": [
              "COGNITO"
            ],
            "AllowedOAuthFlowsUserPoolClient": true,
            "AllowedOAuthScopes": [
              "openid",
              "profile",
              "email"
            ],
            "CallbackURLs": [
              {
                "Fn::Join": [
                  "",
                  [
                    "https://",
                    {
                      "Fn::GetAtt": [
                        "CloudFrontDistribution",
                        "DomainName"
                      ]
                    },
                    "/login"
                  ]
                ]
              }
            ],
            "LogoutURLs": [
              {
                "Fn::Join": [
                  "",
                  [
                    "https://",
                    {
                      "Fn::GetAtt": [
                        "CloudFrontDistribution",
                        "DomainName"
                      ]
                    },
                    "/login"
                  ]
                ]
              }
            ]
          }
        },
        "IdentityPool": {
          "Type": "AWS::Cognito::IdentityPool",
          "Properties": {
            "IdentityPoolName": {
              "Fn::Join": [
                "",
                [
                  {
                    "Ref": "IdentityPoolName"
                  },
                  "-prod-",
                  {
                    "Ref": "ServicePrefix"
                  }
                ]
              ]
            },
            "AllowUnauthenticatedIdentities": true,
            "CognitoIdentityProviders": [
              {
                "ClientId": {
                  "Ref": "UserPoolClient"
                },
                "ProviderName": {
                  "Fn::GetAtt": [
                    "UserPool",
                    "ProviderName"
                  ]
                },
                "ServerSideTokenCheck": true
              }
            ]
          }
        },
        "QuickSightUserRole": {
          "Type": "AWS::IAM::Role",
          "Properties": {
            "RoleName": {
              "Fn::Join": [
                "",
                [
                  {
                    "Ref": "QuickSightUserRoleName"
                  },
                  "_prod_",
                  {
                    "Ref": "ServicePrefix"
                  }
                ]
              ]
            },
            "AssumeRolePolicyDocument": {
              "Version": "2012-10-17",
              "Statement": [
                {
                  "Effect": "Allow",
                  "Principal": {
                    "Federated": "cognito-identity.amazonaws.com"
                  },
                  "Action": [
                    "sts:AssumeRoleWithWebIdentity"
                  ],
                  "Condition": {
                    "StringEquals": {
                      "cognito-identity.amazonaws.com:aud": {
                        "Ref": "IdentityPool"
                      }
                    },
                    "ForAnyValue:StringLike": {
                      "cognito-identity.amazonaws.com:amr": "authenticated"
                    }
                  }
                }
              ]
            },
            "Policies": [
              {
                "PolicyName": "QuickSightUserRolePolicy",
                "PolicyDocument": {
                  "Version": "2012-10-17",
                  "Statement": [
                    {
                      "Effect": "Allow",
                      "Action": [
                        "quicksight:Create*",
                        "quicksight:Describe*",
                        "quicksight:Delete*",
                        "quicksight:TagResource",
                        "quicksight:PassDataSource"
                      ],
                      "Resource": "*"
                    }
                  ]
                }
              }
            ]
          }
        },
        "IdentityPoolRoleAttachment": {
          "Type": "AWS::Cognito::IdentityPoolRoleAttachment",
          "Properties": {
            "IdentityPoolId": {
              "Ref": "IdentityPool"
            },
            "Roles": {
              "authenticated": {
                "Fn::GetAtt": [
                  "QuickSightUserRole",
                  "Arn"
                ]
              }
            }
          }
        },
        "ComprehendCallResolutionBucket": {
          "Type": "AWS::S3::Bucket",
          "Properties": {
            "BucketName": {
              "Fn::Join": [
                "",
                [
                  "comprehend-call-resolution",
                  "-prod-",
                  {
                    "Ref": "ServicePrefix"
                  }
                ]
              ]
            }
          }
        },
        "ComprehendCallMotivationBucket": {
          "Type": "AWS::S3::Bucket",
          "Properties": {
            "BucketName": {
              "Fn::Join": [
                "",
                [
                  "comprehend-call-motivation",
                  "-prod-",
                  {
                    "Ref": "ServicePrefix"
                  }
                ]
              ]
            }
          }
        },
        "TranscriptionOutput": {
          "Type": "AWS::S3::Bucket",
          "Properties": {
            "BucketName": {
              "Fn::Join": [
                "",
                [
                  "transcription-output",
                  "-prod-",
                  {
                    "Ref": "ServicePrefix"
                  }
                ]
              ]
            }
          }
        },
        "TranscriptionAudioFiles": {
          "Type": "AWS::S3::Bucket",
          "Properties": {
            "BucketName": {
              "Fn::Join": [
                "",
                [
                  "transcription-audio-files",
                  "-prod-",
                  {
                    "Ref": "ServicePrefix"
                  }
                ]
              ]
            },
            "CorsConfiguration": {
              "CorsRules": [
                {
                  "AllowedHeaders": [
                    "*"
                  ],
                  "AllowedMethods": [
                    "PUT"
                  ],
                  "AllowedOrigins": [
                    "*"
                  ]
                }
              ]
            }
          }
        },
        "StatusTable": {
          "Type": "AWS::DynamoDB::Table",
          "Properties": {
            "TableName": {
              "Fn::Join": [
                "",
                [
                  "jobStatus",
                  "-prod-",
                  {
                    "Ref": "ServicePrefix"
                  }
                ]
              ]
            },
            "AttributeDefinitions": [
              {
                "AttributeName": "jobId",
                "AttributeType": "S"
              },
              {
                "AttributeName": "audioURI",
                "AttributeType": "S"
              },
              {
                "AttributeName": "transcriptURI",
                "AttributeType": "S"
              },
              {
                "AttributeName": "lastModified",
                "AttributeType": "S"
              },
              {
                "AttributeName": "transcriptionJobName",
                "AttributeType": "S"
              }
            ],
            "KeySchema": [
              {
                "AttributeName": "jobId",
                "KeyType": "HASH"
              },
              {
                "AttributeName": "lastModified",
                "KeyType": "RANGE"
              }
            ],
            "LocalSecondaryIndexes": [
              {
                "IndexName": "audioLSI",
                "KeySchema": [
                  {
                    "AttributeName": "jobId",
                    "KeyType": "HASH"
                  },
                  {
                    "AttributeName": "audioURI",
                    "KeyType": "RANGE"
                  }
                ],
                "Projection": {
                  "ProjectionType": "ALL"
                }
              },
              {
                "IndexName": "transcriptLSI",
                "KeySchema": [
                  {
                    "AttributeName": "jobId",
                    "KeyType": "HASH"
                  },
                  {
                    "AttributeName": "transcriptURI",
                    "KeyType": "RANGE"
                  }
                ],
                "Projection": {
                  "ProjectionType": "ALL"
                }
              }
            ],
            "GlobalSecondaryIndexes": [
              {
                "IndexName": "jobStatusGSI",
                "KeySchema": [
                  {
                    "AttributeName": "transcriptionJobName",
                    "KeyType": "HASH"
                  }
                ],
                "Projection": {
                  "ProjectionType": "ALL"
                },
                "ProvisionedThroughput": {
                  "ReadCapacityUnits": 1,
                  "WriteCapacityUnits": 1
                }
              }
            ],
            "ProvisionedThroughput": {
              "ReadCapacityUnits": 1,
              "WriteCapacityUnits": 1
            }
          }
        },
        "SplitTranscriptOutput": {
          "Type": "AWS::S3::Bucket",
          "Properties": {
            "BucketName": {
              "Fn::Join": [
                "",
                [
                  "split-transcript-output",
                  "-prod-",
                  {
                    "Ref": "ServicePrefix"
                  }
                ]
              ]
            }
          }
        },
        "TextAnalysisOutput": {
          "Type": "AWS::S3::Bucket",
          "Properties": {
            "BucketName": {
              "Fn::Join": [
                "",
                [
                  "text-analysis-output",
                  "-prod-",
                  {
                    "Ref": "ServicePrefix"
                  }
                ]
              ]
            }
          }
        },
        "TranscriptionAudioFilesPolicy": {
          "Type": "AWS::IAM::ManagedPolicy",
          "Properties": {
            "ManagedPolicyName": {
              "Fn::Join": [
                "",
                [
                  "get-presignedurl-policy",
                  "-prod-",
                  {
                    "Ref": "ServicePrefix"
                  }
                ]
              ]
            },
            "PolicyDocument": {
              "Version": "2012-10-17",
              "Statement": [
                {
                  "Effect": "Allow",
                  "Action": [
                    "s3:Put*",
                    "s3:ListBucket",
                    "s3:Get*"
                  ],
                  "Resource": [
                    {
                      "Fn::Join": [
                        "",
                        [
                          "arn:aws:s3:::",
                          "transcription-audio-files-prod-",
                          {
                            "Ref": "ServicePrefix"
                          }
                        ]
                      ]
                    },
                    {
                      "Fn::Join": [
                        "",
                        [
                          "arn:aws:s3:::",
                          "transcription-audio-files-prod-",
                          {
                            "Ref": "ServicePrefix"
                          },
                          "/*"
                        ]
                      ]
                    }
                  ]
                }
              ]
            }
          }
        },
        "TextAnalysisPolicy": {
          "Type": "AWS::IAM::ManagedPolicy",
          "Properties": {
            "ManagedPolicyName": {
              "Fn::Join": [
                "",
                [
                  "text-analysis-policy",
                  "-prod-",
                  {
                    "Ref": "ServicePrefix"
                  }
                ]
              ]
            },
            "PolicyDocument": {
              "Version": "2012-10-17",
              "Statement": [
                {
                  "Effect": "Allow",
                  "Action": [
                    "s3:Put*",
                    "s3:ListBucket",
                    "s3:Get*"
                  ],
                  "Resource": [
                    {
                      "Fn::Join": [
                        "",
                        [
                          "arn:aws:s3:::",
                          "text-analysis-output-prod-",
                          {
                            "Ref": "ServicePrefix"
                          }
                        ]
                      ]
                    },
                    {
                      "Fn::Join": [
                        "",
                        [
                          "arn:aws:s3:::",
                          "text-analysis-output-prod-",
                          {
                            "Ref": "ServicePrefix"
                          },
                          "/*"
                        ]
                      ]
                    }
                  ]
                }
              ]
            }
          }
        },
        "TextAnalysisDatabase": {
          "Type": "AWS::Glue::Database",
          "Properties": {
            "CatalogId": {
              "Ref": "AWS::AccountId"
            },
            "DatabaseInput": {
              "Name": {
                "Fn::Join": [
                  "",
                  [
                    "text_analysis_database",
                    "-prod-",
                    {
                      "Ref": "ServicePrefix"
                    }
                  ]
                ]
              },
              "Description": "AWS Glue container to hold metadata tables for the text analysis crawler"
            }
          }
        },
        "TextAnalysisMetadataCrawler": {
          "Type": "AWS::Glue::Crawler",
          "Properties": {
            "Name": {
              "Fn::Join": [
                "",
                [
                  "text-analysis-metadata-crawler",
                  "-prod-",
                  {
                    "Ref": "ServicePrefix"
                  }
                ]
              ]
            },
            "Role": {
              "Fn::GetAtt": [
                "TextAnalysisResultCrawlerRole",
                "Arn"
              ]
            },
            "Description": "AWS Glue crawler to crawl text analysis results",
            "Schedule": {
              "ScheduleExpression": "cron(0/59 * * * ? *)"
            },
            "DatabaseName": {
              "Ref": "TextAnalysisDatabase"
            },
            "Targets": {
              "S3Targets": [
                {
                  "Path": {
                    "Ref": "TextAnalysisOutput"
                  }
                }
              ]
            },
            "SchemaChangePolicy": {
              "UpdateBehavior": "UPDATE_IN_DATABASE",
              "DeleteBehavior": "LOG"
            },
            "Configuration": "{\"Version\":1.0,\"CrawlerOutput\":{\"Partitions\":{\"AddOrUpdateBehavior\":\"InheritFromTable\"},\"Tables\":{\"AddOrUpdateBehavior\":\"MergeNewColumns\"}}}"
          }
        },
        "TextAnalysisAthena": {
          "Type": "AWS::S3::Bucket",
          "Properties": {
            "BucketName": {
              "Fn::Join": [
                "",
                [
                  "text-analysis-athena-results",
                  "-prod-",
                  {
                    "Ref": "ServicePrefix"
                  }
                ]
              ]
            }
          }
        },
        "FetchTurnByTurnSentimentsNamedQuery": {
          "Type": "AWS::Athena::NamedQuery",
          "Properties": {
            "Database": {
              "Ref": "TextAnalysisDatabase"
            },
            "Description": "A query that selects turn by turn sentiments",
            "Name": "Select Turn by turn sentiments",
            "QueryString": {
              "Fn::Join": [
                "",
                [
                  "WITH dataset AS ( select asset_id as id, call_resolution_status as resolution, call_motivation_status as motivation, turns from ",
                  "\"text_analysis_database-prod-",
                  {
                    "Ref": "ServicePrefix"
                  },
                  "\".\"",
                  "text_analysis_output_prod_",
                  {
                    "Fn::Join": [
                      "_",
                      {
                        "Fn::Split": [
                          "-",
                          {
                            "Ref": "ServicePrefix"
                          }
                        ]
                      }
                    ]
                  },
                  "\"",
                  ") select id, turn.turn, turn.channel, resolution, motivation, turn.sentiment.Sentiment, turn.sentiment.SentimentScore, turn.text from dataset cross join unnest(turns) t(turn)"
                ]
              ]
            }
          }
        },
        "ComprehendFullAccessPolicy": {
          "Type": "AWS::IAM::ManagedPolicy",
          "Properties": {
            "ManagedPolicyName": {
              "Fn::Join": [
                "",
                [
                  "comprehend-full-access-policy",
                  "-prod-",
                  {
                    "Ref": "ServicePrefix"
                  }
                ]
              ]
            },
            "PolicyDocument": {
              "Version": "2012-10-17",
              "Statement": [
                {
                  "Effect": "Allow",
                  "Action": [
                    "s3:Put*",
                    "s3:ListBucket",
                    "s3:Get*"
                  ],
                  "Resource": "*"
                },
                {
                  "Effect": "Allow",
                  "Action": [
                    "lambda:InvokeFunction"
                  ],
                  "Resource": "*"
                },
                {
                  "Effect": "Allow",
                  "Action": [
                    "comprehend:Create*",
                    "comprehend:Describe*",
                    "comprehend:Batch*",
                    "comprehend:Delete*",
                    "comprehend:Detect*",
                    "comprehend:List*",
                    "comprehend:Start*",
                    "comprehend:Stop*",
                    "comprehend:ClassifyDocument"
                  ],
                  "Resource": "*"
                },
                {
                  "Effect": "Allow",
                  "Action": [
                    "events:Disable*"
                  ],
                  "Resource": "*"
                },
                {
                  "Effect": "Allow",
                  "Action": [
                    "dynamodb:*"
                  ],
                  "Resource": {
                    "Fn::Join": [
                      "",
                      [
                        "arn:aws:dynamodb:",
                        {
                          "Ref": "AWS::Region"
                        },
                        ":#{AWS::AccountId}:table/",
                        {
                          "Ref": "StatusTable"
                        }
                      ]
                    ]
                  }
                },
                {
                  "Effect": "Allow",
                  "Action": [
                    "iam:PassRole"
                  ],
                  "Resource": [
                    {
                      "Fn::GetAtt": [
                        "ComprehendDataAccessRole",
                        "Arn"
                      ]
                    },
                    {
                      "Fn::GetAtt": [
                        "TextAnalysisRole",
                        "Arn"
                      ]
                    }
                  ]
                }
              ]
            }
          }
        },
        "SnsNotificationPolicy": {
          "Type": "AWS::IAM::ManagedPolicy",
          "Properties": {
            "ManagedPolicyName": {
              "Fn::Join": [
                "",
                [
                  "sns-notification",
                  "-prod-",
                  {
                    "Ref": "ServicePrefix"
                  }
                ]
              ]
            },
            "PolicyDocument": {
              "Version": "2012-10-17",
              "Statement": [
                {
                  "Effect": "Allow",
                  "Action": [
                    "sns:*"
                  ],
                  "Resource": [
                    {
                      "Ref": "ThreatNotificationTopic"
                    }
                  ]
                }
              ]
            }
          }
        },
        "ThreatNotificationTopic": {
          "Type": "AWS::SNS::Topic",
          "Properties": {
            "Subscription": [
              {
                "Endpoint": {
                  "Ref": "NotificationEmail"
                },
                "Protocol": "email"
              }
            ],
            "DisplayName": {
              "Fn::Join": [
                "",
                [
                  "threat-notification",
                  "-prod-",
                  {
                    "Ref": "ServicePrefix"
                  }
                ]
              ]
            },
            "TopicName": {
              "Fn::Join": [
                "",
                [
                  "threat-notification",
                  "-prod-",
                  {
                    "Ref": "ServicePrefix"
                  }
                ]
              ]
            }
          }
        },
        "CleanUpS3Buckets": {
          "DependsOn": [
            "ComprehendCallResolutionBucket",
            "ComprehendCallMotivationBucket",
            "TranscriptionOutput",
            "TranscriptionAudioFiles",
            "SplitTranscriptOutput",
            "TextAnalysisOutput",
            "TextAnalysisAthena",
            "PortalBucket"
          ],
          "Type": "Custom::CleanUpS3Buckets",
          "Properties": {
            "ServiceToken": {
              "Fn::GetAtt": [
                "CleanUpS3BucketsFunction",
                "Arn"
              ]
            },
            "Buckets": [
              {
                "Ref": "ComprehendCallResolutionBucket"
              },
              {
                "Ref": "ComprehendCallMotivationBucket"
              },
              {
                "Ref": "TranscriptionOutput"
              },
              {
                "Ref": "TranscriptionAudioFiles"
              },
              {
                "Ref": "SplitTranscriptOutput"
              },
              {
                "Ref": "TextAnalysisOutput"
              },
              {
                "Ref": "TextAnalysisAthena"
              },
              {
                "Ref": "PortalBucket"
              }
            ]
          }
        },
        "CleanUpS3BucketsFunction": {
          "Type": "AWS::Lambda::Function",
          "Properties": {
            "Code": {
              "ZipFile": "import json\nimport logging\nimport threading\nimport boto3\nimport cfnresponse\n\ns3r = boto3.resource('s3')\ns3c = boto3.client('s3')\n\ndef delete_objects(bucket):\n    print(\"Collecting data from\" + bucket)\n    paginator = s3c.get_paginator('list_object_versions')\n    result = paginator.paginate(Bucket=bucket)\n    objects = []\n    for page in result:\n        try:\n            for k in page['Versions']:\n                objects.append({'Key': k['Key'], 'VersionId': k['VersionId']})\n            try:\n                for k in page['DeleteMarkers']:\n                    version = k['VersionId']\n                    key = k['Key']\n                    objects.append({'Key': key, 'VersionId': version})\n            except Exception as e:\n                print(e)\n                pass\n            print(\"deleting objects\")\n            s3c.delete_objects(Bucket=bucket, Delete={'Objects': objects})\n        except Exception as e:\n            print(e)\n            pass\n    print(\"bucket already empty\")\n\n\ndef timeout(event, context):\n    logging.error('Execution is about to time out, sending failure response to CloudFormation')\n    cfnresponse.send(event, context, cfnresponse.FAILED, {}, None)\n\n\ndef handler(event, context):\n    # make sure we send a failure to CloudFormation if the function is going to timeout\n    timer = threading.Timer((context.get_remaining_time_in_millis() / 1000.00) - 0.5, timeout, args=[event, context])\n    timer.start()\n\n    print('Received event: %s' % json.dumps(event))\n    status = cfnresponse.SUCCESS\n    try:\n        buckets = event['ResourceProperties']['Buckets']\n        if event['RequestType'] == 'Delete':\n            for bucket in buckets:\n                delete_objects(bucket)\n        else:\n            print(\"Nothing to do\")\n    except Exception as e:\n        logging.error('Exception: %s' % e, exc_info=True)\n        status = cfnresponse.FAILED\n    finally:\n        timer.cancel()\n        cfnresponse.send(event, context, status, {}, None)\n"
            },
            "Description": "Empty the S3 Bucket",
            "Handler": "index.handler",
            "Role": {
              "Fn::GetAtt": [
                "S3CleanUpRole",
                "Arn"
              ]
            },
            "Runtime": "python3.6",
            "Timeout": 240
          }
        },
        "S3CleanUpRole": {
          "Type": "AWS::IAM::Role",
          "Properties": {
            "AssumeRolePolicyDocument": {
              "Statement": [
                {
                  "Action": "sts:AssumeRole",
                  "Effect": "Allow",
                  "Principal": {
                    "Service": "lambda.amazonaws.com"
                  }
                }
              ],
              "Version": "2012-10-17"
            },
            "ManagedPolicyArns": [
              "arn:aws:iam::aws:policy/service-role/AWSLambdaBasicExecutionRole"
            ],
            "Path": "/",
            "Policies": [
              {
                "PolicyDocument": {
                  "Statement": [
                    {
                      "Action": [
                        "s3:PutObject",
                        "s3:DeleteObject",
                        "s3:GetObject",
                        "s3:ListBucket",
                        "s3:ListBucketVersions",
                        "s3:DeleteObjectVersion",
                        "s3:GetObjectVersion",
                        "s3:GetBucketVersioning"
                      ],
                      "Effect": "Allow",
                      "Resource": [
                        {
                          "Fn::GetAtt": [
                            "ComprehendCallResolutionBucket",
                            "Arn"
                          ]
                        },
                        {
                          "Fn::GetAtt": [
                            "ComprehendCallMotivationBucket",
                            "Arn"
                          ]
                        },
                        {
                          "Fn::GetAtt": [
                            "TranscriptionOutput",
                            "Arn"
                          ]
                        },
                        {
                          "Fn::GetAtt": [
                            "TranscriptionAudioFiles",
                            "Arn"
                          ]
                        },
                        {
                          "Fn::GetAtt": [
                            "SplitTranscriptOutput",
                            "Arn"
                          ]
                        },
                        {
                          "Fn::GetAtt": [
                            "TextAnalysisOutput",
                            "Arn"
                          ]
                        },
                        {
                          "Fn::GetAtt": [
                            "TextAnalysisAthena",
                            "Arn"
                          ]
                        },
                        {
                          "Fn::GetAtt": [
                            "PortalBucket",
                            "Arn"
                          ]
                        }
                      ]
                    }
                  ],
                  "Version": "2012-10-17"
                },
                "PolicyName": "Empty-bucket"
              }
            ]
          }
        },
        "ComprehendCleanup": {
          "Type": "Custom::ComprehendCleanup",
          "Properties": {
            "ServiceToken": {
              "Fn::GetAtt": [
                "ComprehendCleanupFunction",
                "Arn"
              ]
            },
            "MotivationEndpointArn": {
              "Fn::Join": [
                "",
                [
                  "arn:aws:comprehend:",
                  {
                    "Ref": "AWS::Region"
                  },
                  ":",
                  {
                    "Ref": "AWS::AccountId"
                  },
                  ":document-classifier-endpoint/",
                  {
                    "Ref": "CallMotivationClassifierName"
                  },
                  "Endpoint"
                ]
              ]
            },
            "ResolutionEndpointArn": {
              "Fn::Join": [
                "",
                [
                  "arn:aws:comprehend:",
                  {
                    "Ref": "AWS::Region"
                  },
                  ":",
                  {
                    "Ref": "AWS::AccountId"
                  },
                  ":document-classifier-endpoint/",
                  {
                    "Ref": "CallResolutionClassifierName"
                  },
                  "Endpoint"
                ]
              ]
            },
            "MotivationClassifierArn": {
              "Fn::Join": [
                "",
                [
                  "arn:aws:comprehend:",
                  {
                    "Ref": "AWS::Region"
                  },
                  ":",
                  {
                    "Ref": "AWS::AccountId"
                  },
                  ":document-classifier/",
                  {
                    "Ref": "CallMotivationClassifierName"
                  }
                ]
              ]
            },
            "ResolutionClassifierArn": {
              "Fn::Join": [
                "",
                [
                  "arn:aws:comprehend:",
                  {
                    "Ref": "AWS::Region"
                  },
                  ":",
                  {
                    "Ref": "AWS::AccountId"
                  },
                  ":document-classifier/",
                  {
                    "Ref": "CallResolutionClassifierName"
                  }
                ]
              ]
            }
          }
        },
        "ComprehendCleanupFunction": {
          "Type": "AWS::Lambda::Function",
          "Properties": {
            "Description": "Empty the S3 Bucket",
            "Handler": "index.handler",
            "Role": {
              "Fn::GetAtt": [
                "ComprehendFullAccessRole",
                "Arn"
              ]
            },
            "Runtime": "python3.6",
            "Timeout": 240,
            "Code": {
              "ZipFile": "import json\nimport logging\nimport threading\nimport boto3\nimport cfnresponse\n\ncomprehend = boto3.client('comprehend')\n\ndef endpoint_exists(arn):\n    try:\n        endpoint = comprehend.describe_endpoint(\n            EndpointArn=arn\n        )\n        return True\n    except Exception as e:\n        return False\n\n\ndef classifier_exists(arn):\n    try:\n        endpoints = comprehend.describe_document_classifier(\n            Filter={\n                'ModelArn': arn\n            }\n        )\n        return True\n    except Exception as e:\n        return False\n\n\ndef timeout(event, context):\n    logging.error('Execution is about to time out, sending failure response to CloudFormation')\n    cfnresponse.send(event, context, cfnresponse.FAILED, {}, None)\n\n\ndef handler(event, context):\n    # make sure we send a failure to CloudFormation if the function is going to timeout\n    timer = threading.Timer((context.get_remaining_time_in_millis() / 1000.00) - 0.5, timeout, args=[event, context])\n    timer.start()\n\n    print('Received event: %s' % json.dumps(event))\n    status = cfnresponse.SUCCESS\n    try:\n        mot_endpoint_arn = event['ResourceProperties']['MotivationEndpointArn']\n        res_endpoint_arn = event['ResourceProperties']['ResolutionEndpointArn']\n        mot_classifier_arn = event['ResourceProperties']['MotivationClassifierArn']\n        res_classifier_arn = event['ResourceProperties']['ResolutionClassifierArn']\n\n        if event['RequestType'] == 'Delete':\n            mot_endpoint_exists = endpoint_exists(mot_endpoint_arn)\n            res_endpoint_exists = endpoint_exists(res_endpoint_arn)\n            mot_classifier_exists = classifier_exists(mot_classifier_arn)\n            res_classifier_exists = classifier_exists(res_classifier_arn)\n            if mot_endpoint_exists is True:\n                print('deleting ' + mot_endpoint_arn)\n                comprehend.delete_endpoint(\n                    EndpointArn=mot_endpoint_arn\n                )\n            if res_endpoint_exists is True:\n                print('deleting ' + res_endpoint_arn)\n                comprehend.delete_endpoint(\n                    EndpointArn=res_endpoint_arn\n                )\n            if mot_classifier_exists is True:\n                print('deleting ' + mot_classifier_arn)\n                comprehend.delete_document_classifier(\n                    DocumentClassifierArn=mot_classifier_arn\n                )\n            if res_classifier_exists is True:\n                print('deleting ' + res_classifier_arn)\n                comprehend.delete_document_classifier(\n                    DocumentClassifierArn=res_classifier_arn\n                )\n        else:\n            print(\"Nothing to do\")\n    except Exception as e:\n        logging.error('Exception: %s' % e, exc_info=True)\n        status = cfnresponse.FAILED\n    finally:\n        timer.cancel()\n        cfnresponse.send(event, context, status, {}, None)\n"
            }
          }
        },
        "GatewayResponseDefault4XX": {
          "Type": "AWS::ApiGateway::GatewayResponse",
          "Properties": {
            "ResponseParameters": {
              "gatewayresponse.header.Access-Control-Allow-Origin": "'*'",
              "gatewayresponse.header.Access-Control-Allow-Headers": "'*'"
            },
            "ResponseType": "DEFAULT_4XX",
            "RestApiId": {
              "Ref": "Api"
            }
          }
        },
        "GatewayResponseDefault5XX": {
          "Type": "AWS::ApiGateway::GatewayResponse",
          "Properties": {
            "ResponseParameters": {
              "gatewayresponse.header.Access-Control-Allow-Origin": "'*'",
              "gatewayresponse.header.Access-Control-Allow-Headers": "'*'"
            },
            "ResponseType": "DEFAULT_5XX",
            "RestApiId": {
              "Ref": "Api"
            }
          }
        },
        "Api": {
          "Type": "AWS::ApiGateway::RestApi",
          "Properties": {
            "Name": {
              "Fn::Join": [
                "",
                [
                  "api",
                  "-prod-",
                  {
                    "Ref": "ServicePrefix"
                  }
                ]
              ]
            },
            "BinaryMediaTypes": [
              "image/png",
              "image/jpg",
              "image/gif",
              "image/x-icon",
              "application/octet-stream"
            ]
          }
        },
        "PortalBucket": {
          "Type": "AWS::S3::Bucket",
          "Properties": {
            "PublicAccessBlockConfiguration": {
              "BlockPublicAcls": true,
              "BlockPublicPolicy": true,
              "IgnorePublicAcls": true,
              "RestrictPublicBuckets": true
            },
            "WebsiteConfiguration": {
              "IndexDocument": {
                "Ref": "DefaultRoot"
              },
              "ErrorDocument": {
                "Ref": "ErrorPage"
              }
            }
          }
        },
        "CloudFrontOriginAccessIdentity": {
          "Type": "AWS::CloudFront::CloudFrontOriginAccessIdentity",
          "Properties": {
            "CloudFrontOriginAccessIdentityConfig": {
              "Comment": {
                "Ref": "PortalBucket"
              }
            }
          }
        },
        "PortalBucketReadPolicy": {
          "Type": "AWS::S3::BucketPolicy",
          "Properties": {
            "Bucket": {
              "Ref": "PortalBucket"
            },
            "PolicyDocument": {
              "Statement": [
                {
                  "Action": "s3:GetObject",
                  "Effect": "Allow",
                  "Resource": {
                    "Fn::Join": [
                      "",
                      [
                        "arn:aws:s3:::",
                        {
                          "Ref": "PortalBucket"
                        },
                        "/*"
                      ]
                    ]
                  },
                  "Principal": {
                    "CanonicalUser": {
                      "Fn::GetAtt": [
                        "CloudFrontOriginAccessIdentity",
                        "S3CanonicalUserId"
                      ]
                    }
                  }
                }
              ]
            }
          }
        },
        "CloudFrontDistribution": {
          "Type": "AWS::CloudFront::Distribution",
          "DependsOn": [
            "PortalBucket"
          ],
          "Properties": {
            "DistributionConfig": {
              "DefaultRootObject": {
                "Fn::Join": [
                  "",
                  [
                    "/",
                    {
                      "Ref": "DefaultRoot"
                    }
                  ]
                ]
              },
              "Enabled": true,
              "HttpVersion": "http2",
              "Origins": [
                {
                  "DomainName": {
                    "Fn::GetAtt": [
                      "PortalBucket",
                      "DomainName"
                    ]
                  },
                  "Id": "s3origin",
                  "S3OriginConfig": {
                    "OriginAccessIdentity": {
                      "Fn::Join": [
                        "",
                        [
                          "origin-access-identity/cloudfront/",
                          {
                            "Ref": "CloudFrontOriginAccessIdentity"
                          }
                        ]
                      ]
                    }
                  }
                },
                {
                  "DomainName": {
                    "Fn::Join": [
                      "",
                      [
                        {
                          "Ref": "Api"
                        },
                        ".execute-api.",
                        {
                          "Ref": "AWS::Region"
                        },
                        ".amazonaws.com"
                      ]
                    ]
                  },
                  "CustomOriginConfig": {
                    "HTTPSPort": "443",
                    "OriginProtocolPolicy": "https-only"
                  },
                  "OriginPath": "/prod",
                  "Id": "apigatewayorigin"
                }
              ],
              "PriceClass": "PriceClass_All",
              "CustomErrorResponses": [
                {
                  "ErrorCode": 403,
                  "ResponseCode": 200,
                  "ResponsePagePath": {
                    "Fn::Join": [
                      "",
                      [
                        "/",
                        {
                          "Ref": "DefaultRoot"
                        }
                      ]
                    ]
                  }
                },
                {
                  "ErrorCode": 404,
                  "ResponseCode": 200,
                  "ResponsePagePath": {
                    "Fn::Join": [
                      "",
                      [
                        "/",
                        {
                          "Ref": "DefaultRoot"
                        }
                      ]
                    ]
                  }
                }
              ],
              "DefaultCacheBehavior": {
                "AllowedMethods": [
                  "GET",
                  "HEAD",
                  "OPTIONS"
                ],
                "CachedMethods": [
                  "GET",
                  "HEAD",
                  "OPTIONS"
                ],
                "Compress": true,
                "DefaultTTL": 3600,
                "ForwardedValues": {
                  "Cookies": {
                    "Forward": "none"
                  },
                  "QueryString": false
                },
                "MaxTTL": 86400,
                "MinTTL": 60,
                "TargetOriginId": "s3origin",
                "ViewerProtocolPolicy": "redirect-to-https"
              },
              "CacheBehaviors": [
                {
                  "AllowedMethods": [
                    "DELETE",
                    "GET",
                    "HEAD",
                    "OPTIONS",
                    "PATCH",
                    "POST",
                    "PUT"
                  ],
                  "CachedMethods": [
                    "GET",
                    "HEAD",
                    "OPTIONS"
                  ],
                  "Compress": true,
                  "DefaultTTL": 5000,
                  "MaxTTL": 10000,
                  "MinTTL": 60,
                  "ForwardedValues": {
                    "Headers": [
                      "Accept",
                      "Referer",
                      "Authorization",
                      "Content-Type"
                    ],
                    "QueryString": true
                  },
                  "PathPattern": "/api/*",
                  "TargetOriginId": "apigatewayorigin",
                  "ViewerProtocolPolicy": "https-only"
                }
              ]
            }
          }
        }
      }
    },
    "serviceFilename": "serverless.yml",
    "layers": {},
    "isDashboardMonitoringPreconfigured": false
  },
  "package": {
    "artifactDirectoryName": "serverless/aws-icc/prod/1596656717357-2020-08-05T19:45:17.357Z",
    "artifact": ""
  }
}